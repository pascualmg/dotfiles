#+TITLE: NixOS MacBook Pro 13,2 (2016)
#+AUTHOR: passh
#+DATE: 2026-01-03
#+STARTUP: overview

* Resumen

Configuracion NixOS para MacBook Pro 13,2 (Late 2016, 13" con Touch Bar).

*IMPORTANTE*: NixOS 24.05 NO arranca en este hardware. Usar NixOS 24.04.

** Versiones Disponibles

| Version | Estado | Archivo |
|---------+--------+---------|
| 24.04   | *RECOMENDADA* | =configuration-24.04.nix= |
| 24.11   | NO PROBADA | =configuration.nix= (original) |

** Hardware soportado

| Componente      | Modelo                          | Driver/Soporte            |
|-----------------+---------------------------------+---------------------------|
| CPU             | Intel Core i5/i7-6xxx (Skylake) | intel_pstate              |
| GPU             | Intel Iris Graphics 550         | i915/modesetting          |
| Display         | Retina 2560x1600 (227 DPI)      | HiDPI 2x scaling          |
| Teclado         | Apple SPI Keyboard              | applespi                  |
| Trackpad        | Force Touch (SPI)               | applespi + libinput       |
| Touch Bar       | OLED T1 chip                    | tiny-dfr                  |
| WiFi            | Broadcom BCM43602               | broadcom_sta (wl) *       |
| Bluetooth       | Broadcom (integrado)            | bluez                     |
| Audio           | Intel HDA + Apple amps          | snd-hda-intel (model=mbp13) |
| Camara          | FaceTime HD                     | facetimehd (nixos-hardware) |
| Thunderbolt     | 4x USB-C TB3                    | thunderbolt + bolt        |
| Storage         | USB 128GB / SSD TB3 4TB         | usb_storage / nvme + fstrim |

*WiFi*: Detecta redes pero tiene problemas de conexion. Usar USB WiFi/Ethernet como fallback.

** Estructura de archivos

#+BEGIN_SRC text
nixos-macbook/
├── README.org                              # Este archivo
├── INSTALL-24.04.md                        # Guia de instalacion detallada
└── etc/nixos/
    ├── configuration.nix                   # Config original (24.11)
    ├── configuration-24.04.nix             # Config para NixOS 24.04 (USAR ESTA)
    ├── hardware-configuration.nix          # Template original
    ├── hardware-configuration-template.nix # Template para USB 128GB
    └── modules/
        ├── apple-hardware.nix              # Modulo original (24.11)
        └── apple-hardware-24.04.nix        # Modulo para NixOS 24.04 (USAR ESTE)
#+END_SRC

** Dependencias

- *nixos-hardware*: Perfiles =apple-macbook-pro= y =common-pc-ssd=
- *nixpkgs.config.allowUnfree = true*: Para firmware Broadcom WiFi

* Instalacion Rapida (NixOS 24.04)

Ver [[file:INSTALL-24.04.md][INSTALL-24.04.md]] para guia completa paso a paso.

** Resumen de pasos

1. Boot USB NixOS 24.04 (24.05 NO funciona)
2. Conectar USB WiFi/Ethernet (Broadcom interno no conecta en Live)
3. Particionar USB 128GB (EFI + root + swap)
4. =nixos-generate-config --root /mnt=
5. Copiar =configuration-24.04.nix= como =configuration.nix=
6. Copiar =apple-hardware-24.04.nix= como =modules/apple-hardware.nix=
7. =nixos-install=
8. Reboot y verificar con =macbook-diag=

* Problema WiFi Broadcom BCM43602

** Sintomas

- En Live USB: Detecta redes pero NO conecta
- El driver =wl= (broadcom_sta) carga correctamente
- =nmcli device wifi list= muestra redes
- =nmcli device wifi connect= falla silenciosamente

** Configuracion actual

#+BEGIN_SRC nix
boot = {
  extraModulePackages = [ config.boot.kernelPackages.broadcom_sta ];
  blacklistedKernelModules = [
    "b43" "b43legacy" "bcma" "brcmsmac" "brcmfmac" "ssb"
  ];
};
#+END_SRC

** Workarounds

1. *USB WiFi con drivers libres* (Ralink, Atheros, Intel)
2. *USB Ethernet adapter*
3. *USB Tethering desde movil*

** Debug

#+BEGIN_SRC bash
# Script incluido en la config
wifi-debug

# Manual
lsmod | grep wl                    # Verificar driver
lsmod | grep -E "b43|bcma|brcm"    # Debe estar vacio
nmcli device wifi list             # Ver redes
journalctl -u NetworkManager       # Ver logs
#+END_SRC

* Diagnostico

** Comandos disponibles

| Comando           | Descripcion                              |
|-------------------+------------------------------------------|
| =macbook-info=    | Info general del sistema                 |
| =macbook-diag=    | Diagnostico completo de hardware         |
| =touchbar-status= | Estado del Touch Bar y tiny-dfr          |
| =wifi-debug=      | Debug WiFi Broadcom                      |
| =brightnessctl=   | Control brillo pantalla                  |
| =powertop=        | Analisis consumo energia                 |

** Checklist de verificacion

#+BEGIN_SRC bash
# 1. Kernel modules SPI (teclado/trackpad)
lsmod | grep -E "applespi|spi_pxa|intel_lpss"
# Esperado: applespi, spi_pxa2xx_platform, intel_lpss_pci

# 2. WiFi driver
lsmod | grep "^wl"
# Esperado: wl

# 3. Touch Bar
systemctl is-active tiny-dfr
# Esperado: active

# 4. Audio
pactl info | grep "Server Name"
# Esperado: PipeWire

# 5. Graphics
lsmod | grep i915
# Esperado: i915

# 6. HiDPI
echo $GDK_SCALE
# Esperado: 2
#+END_SRC

* Troubleshooting

** Teclado no funciona

*En Live USB 24.04*: Deberia funcionar (ya verificado).

*Despues de instalar*: Verificar modulos SPI:

#+BEGIN_SRC bash
sudo modprobe intel_lpss_pci
sudo modprobe spi_pxa2xx_platform
sudo modprobe applespi
#+END_SRC

** WiFi detecta pero no conecta

Ver seccion "Problema WiFi Broadcom BCM43602" arriba.

** Touch Bar no muestra F1-F12

#+BEGIN_SRC bash
sudo systemctl start tiny-dfr
sudo systemctl enable tiny-dfr
#+END_SRC

** Pantalla muy pequena (sin HiDPI)

Verificar variables:
#+BEGIN_SRC bash
echo $GDK_SCALE      # Debe ser 2
echo $GDK_DPI_SCALE  # Debe ser 0.5
#+END_SRC

Si faltan, cerrar sesion y volver a entrar.

** Audio sin sonido

#+BEGIN_SRC bash
pactl set-sink-mute @DEFAULT_SINK@ 0
pactl set-sink-volume @DEFAULT_SINK@ 80%
#+END_SRC

* Notas Tecnicas

** Por que NixOS 24.04 y no 24.05

NixOS 24.05 no arranca en MacBook Pro 13,2. El instalador Live se queda colgado.
Posibles causas:
- Cambios en drivers Intel graphics
- Cambios en systemd-boot
- Incompatibilidad firmware

24.04 funciona correctamente con teclado y trackpad en Live USB.

** Por que nixos-hardware apple-macbook-pro

El repositorio [[https://github.com/NixOS/nixos-hardware][nixos-hardware]] proporciona:

- =apple/default.nix=: mbpfan (ventilador), facetimehd (camara)
- =common/cpu/intel=: Microcode, Intel GPU
- =common/pc/laptop=: TLP power management
- =common/pc/ssd=: fstrim automatico

NO existe perfil =13-2= especifico, por eso =modules/apple-hardware.nix= complementa con:
- Drivers SPI (applespi) para teclado/trackpad
- Touch Bar (tiny-dfr)
- WiFi Broadcom (broadcom_sta)
- HiDPI 227 DPI

** Kernel

Para NixOS 24.04 usamos =linuxPackages_6_6= (LTS) en lugar de =linuxPackages_latest=
para mayor estabilidad.

** Storage USB vs TB3 SSD

| Storage | Opciones mount | commit |
|---------+----------------+--------|
| USB 128GB | noatime, discard | 120s (reduce writes) |
| TB3 SSD 4TB | noatime, discard | 60s (mas seguro) |

* Migracion a Flakes (Futuro)

Cuando se migre a flakes, usar:

#+BEGIN_SRC nix
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-24.05";  # O version estable
    nixos-hardware.url = "github:NixOS/nixos-hardware";
  };

  outputs = { nixpkgs, nixos-hardware, ... }: {
    nixosConfigurations.macbook = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      modules = [
        nixos-hardware.nixosModules.apple-macbook-pro
        nixos-hardware.nixosModules.common-pc-ssd
        ./configuration.nix
        ./modules/apple-hardware.nix
      ];
    };
  };
}
#+END_SRC

* Referencias

- [[https://github.com/NixOS/nixos-hardware][NixOS Hardware Repository]]
- [[https://wiki.archlinux.org/title/Mac][ArchWiki: Mac]]
- [[https://github.com/roadrunner2/macbook12-spi-driver][macbook12-spi-driver (applespi)]]
- [[https://github.com/kekrby/tiny-dfr][tiny-dfr (Touch Bar)]]
- [[https://wiki.archlinux.org/title/Broadcom_wireless][ArchWiki: Broadcom wireless]]
- [[https://nixos.org/manual/nixos/stable/][NixOS Manual]]

---

*Ultima actualizacion*: 2026-01-03
*Sistema*: NixOS 24.04 en MacBook Pro 13,2
