#+TITLE: NixOS Aurin - Configuración Modular
#+AUTHOR: passh
#+DATE: 2026-01-01
#+STARTUP: overview

* Introducción

Esta es la configuración NixOS de *aurin*, organizada usando el sistema de módulos de NixOS para máxima mantenibilidad y reutilización.

** Hardware

- *CPU:* Dual Intel Xeon E5-2699v3 (36 cores / 72 threads)
- *RAM:* 128GB DDR4
- *GPU:* NVIDIA GeForce RTX 5080 (16GB VRAM)
- *Audio:* FiiO K7 DAC/AMP + Sennheiser HD600 (300Ω)
- *Storage:* NVMe SSD

** Versión NixOS

- NixOS 25.05 (unstable)
- Channels: stable, unstable, master

* Arquitectura Modular

** Estructura de Archivos

#+BEGIN_SRC
nixos-aurin/etc/nixos/
├── configuration.nix          # Configuración principal (560 líneas)
├── hardware-configuration.nix # Generado por nixos-generate-config
└── modules/                   # Módulos funcionales
    ├── nvidia-rtx5080.nix     # GPU NVIDIA RTX 5080
    ├── audio-fiio-k7.nix      # PipeWire + FiiO K7 DAC
    ├── sunshine.nix           # Streaming server (Moonlight)
    ├── printing.nix           # CUPS + impresora HP
    ├── xrdp.nix               # Remote Desktop Protocol
    ├── virtualization.nix     # Docker + libvirt/QEMU
    └── xmonad.nix             # Window Manager + X11
#+END_SRC

** Diagrama de Imports

#+BEGIN_SRC
configuration.nix
    │
    ├─→ hardware-configuration.nix (hardware específico)
    ├─→ <home-manager/nixos>       (gestión de usuario)
    │
    └─→ modules/
        ├─→ nvidia-rtx5080.nix
        ├─→ audio-fiio-k7.nix
        ├─→ sunshine.nix
        ├─→ printing.nix
        ├─→ xrdp.nix
        ├─→ virtualization.nix
        └─→ xmonad.nix
#+END_SRC

* Módulos Disponibles

** nvidia-rtx5080.nix (113 líneas)

Configuración completa de GPU NVIDIA RTX 5080.

*** Contenido:
- Drivers open-source (beta) - *OBLIGATORIO para RTX 50xx*
- Hardware acceleration (NVENC, CUDA)
- Parámetros del kernel (nvidia-drm, fbdev)
- Variables de entorno (LIBVA, GLX)
- Container toolkit (Docker + GPU)

*** Por qué drivers open:
Los drivers propietarios NO funcionan con RTX 5080. Solo los open-source beta.

*** Portabilidad:
Portable a cualquier máquina con RTX 5080.

** audio-fiio-k7.nix (221 líneas)

PipeWire optimizado para FiiO K7 DAC/AMP @ 96kHz.

*** Contenido:
- PipeWire con quantum 1024 @ 96kHz
- Configuración USB audio específica FiiO K7
- Bluetooth (pipewire-pulse)
- ALSA low-latency
- Script ~fiio-k7-test~ para diagnóstico

*** Hardware soportado:
- FiiO K7 (USB ID: 2972:0047)
- Sennheiser HD600 (300Ω - requiere GAIN alto)

*** Optimizaciones:
- Sample rate: 96kHz (nativo del K7)
- Quantum: 1024 (balance latencia/estabilidad)
- Períodos ALSA: 2 x 1024

** sunshine.nix (122 líneas)

Servidor de streaming Moonlight/Sunshine con NVENC.

*** Contenido:
- Sunshine con soporte CUDA
- Firewall automático (puertos 47984-48010)
- Captura NvFBC (NVIDIA Frame Buffer Capture)
- Script ~sunshine-test~ para diagnóstico
- udev rules para input devices

*** Puertos abiertos:
- TCP: 47984-48010 (web UI, control, streaming)
- UDP: 47998-48010 (video/audio streaming)

*** Clientes:
- Moonlight (Windows, Mac, Linux, Android, iOS)

** printing.nix (47 líneas)

Sistema de impresión CUPS + HP.

*** Contenido:
- CUPS (Common Unix Printing System)
- Drivers HPLIP (HP LaserJet)
- Avahi/mDNS para autodescubrimiento WiFi
- Soporte impresora: HP LaserJet Pro M148dw

** xrdp.nix (37 líneas)

Remote Desktop Protocol (actualmente *disabled*).

*** Contenido:
- Servidor XRDP
- Integración con XMonad
- Firewall puerto 3389

*** Estado:
Deshabilitado por defecto. Habilitar con:
#+BEGIN_SRC nix
services.xrdp.enable = true;
#+END_SRC

** virtualization.nix (109 líneas)

Virtualización Docker + libvirt/QEMU.

*** Contenido:
- Docker con NVIDIA runtime
- libvirt/QEMU con KVM
- VFIO/IOMMU para GPU passthrough
- SPICE para VMs
- Redes bridge virtuales

*** Capacidades:
- Containers Docker con acceso a GPU
- VMs con hardware passthrough
- Networking virtual

** xmonad.nix (86 líneas)

Window Manager XMonad + compositor Picom.

*** Contenido:
- XMonad tiling WM (Haskell)
- Picom compositor (vsync, transparencias)
- LightDM display manager
- XFCE polkit (autenticación GUI)
- Multi-monitor setup (5120x1440)

*** Configuración:
XMonad config: ~$HOME/.config/xmonad/xmonad.hs~
Picom config: ~$HOME/.config/picom/picom.conf~

* Uso

** Aplicar Cambios

*** Workflow recomendado:

#+BEGIN_SRC bash
# 1. Editar módulo
emacs ~/dotfiles/nixos-aurin/etc/nixos/modules/audio-fiio-k7.nix

# 2. Test (NO permanente, se pierde al reiniciar)
sudo nixos-rebuild test

# 3. Verificar que funciona
# (probar audio, GPU, etc.)

# 4. Si OK → aplicar permanentemente
sudo nixos-rebuild switch

# 5. Si algo falla → rollback
sudo nixos-rebuild switch --rollback
#+END_SRC

#+RESULTS:

*** Comandos útiles:

#+BEGIN_SRC bash
# Ver generaciones disponibles
nixos-rebuild list-generations

# Rollback a generación anterior
sudo nixos-rebuild switch --rollback

# Rollback a generación específica
sudo nixos-rebuild switch --rollback-to 98

# Verificar sintaxis sin construir
nix-instantiate --parse configuration.nix

# Dry-run (ver qué cambiaría)
sudo nixos-rebuild dry-build
#+END_SRC

** Modificar Módulos Existentes

1. Edita el módulo: ~modules/nombre-modulo.nix~
2. Test: ~sudo nixos-rebuild test~
3. Verifica funcionamiento
4. Switch: ~sudo nixos-rebuild switch~

** Crear Nuevo Módulo

*** Plantilla básica:

#+BEGIN_SRC nix
# =============================================================================
# MODULO: Nombre del Módulo
# =============================================================================
# Descripción de qué hace este módulo
#
# Hardware/Software:
#   - Lista de dependencias
#
# Configuración:
#   - Detalles importantes
# =============================================================================

{ config, pkgs, ... }:

{
  # Tu configuración aquí
  services.miservicio = {
    enable = true;
    # opciones...
  };

  environment.systemPackages = with pkgs; [
    # paquetes necesarios
  ];
}
#+END_SRC

*** Pasos:

1. Crear archivo en ~modules/mi-modulo.nix~
2. Añadir a ~configuration.nix~:
   #+BEGIN_SRC nix
   imports = [
     ./modules/mi-modulo.nix
   ];
   #+END_SRC
3. Test y switch

* Scripts de Diagnóstico

** fiio-k7-test

Diagnóstico completo del sistema de audio FiiO K7.

#+BEGIN_SRC bash
fiio-k7-test
#+END_SRC

Verifica:
- Detección USB del K7
- Sample rate activo
- PipeWire funcionando
- Sink correcto configurado

** sunshine-test

Diagnóstico del servidor de streaming Sunshine.

#+BEGIN_SRC bash
sunshine-test
#+END_SRC

Verifica:
- GPU NVIDIA detectada
- Sunshine corriendo
- Puerto 47990 abierto
- NVENC (H.264, H.265) funcionando

** aurin-info

Información general del sistema.

#+BEGIN_SRC bash
aurin-info
#+END_SRC

Muestra:
- CPU (dual Xeon)
- GPU (RTX 5080)
- RAM
- Storage
- Network
- Servicios activos

** Otros scripts:

- ~numa-info~ - Información NUMA dual socket
- ~xeon-stress~ - Stress test CPU
- ~temp-monitor~ - Monitor de temperaturas

* Troubleshooting

** NVIDIA no funciona

#+BEGIN_SRC bash
# Verificar GPU detectada
nvidia-smi

# Ver logs del kernel
journalctl -k | grep -i nvidia

# Verificar módulos cargados
lsmod | grep nvidia
#+END_SRC

** Audio no funciona

#+BEGIN_SRC bash
# Test completo
fiio-k7-test

# Ver dispositivos
pactl list sinks short

# Reiniciar PipeWire
systemctl --user restart pipewire pipewire-pulse
#+END_SRC

** Sunshine pantalla negra

#+BEGIN_SRC bash
# Ver logs
journalctl --user -u sunshine -n 50

# Verificar NVENC
nvidia-smi

# Test completo
sunshine-test
#+END_SRC

** Rollback de emergencia

Si el sistema no arranca:

1. En GRUB, selecciona "NixOS - Old configurations"
2. Elige una generación anterior
3. Una vez dentro:
   #+BEGIN_SRC bash
   sudo nixos-rebuild switch --rollback
   #+END_SRC

* Portabilidad a Otras Máquinas

** Mover módulo a vespino:

#+BEGIN_SRC bash
# 1. Copiar módulo
cp nixos-aurin/etc/nixos/modules/audio-fiio-k7.nix \
   nixos-vespino/etc/nixos/modules/

# 2. Importar en configuration.nix de vespino
# imports = [ ./modules/audio-fiio-k7.nix ];

# 3. Test y switch en vespino
sudo nixos-rebuild test
sudo nixos-rebuild switch
#+END_SRC

** Módulos portables vs específicos:

| Módulo | Portabilidad |
|--------|--------------|
| ~nvidia-rtx5080.nix~ | Solo máquinas con RTX 5080 |
| ~audio-fiio-k7.nix~ | Solo máquinas con FiiO K7 |
| ~sunshine.nix~ | Cualquier máquina con GPU NVIDIA |
| ~printing.nix~ | Portable (impresora HP) |
| ~virtualization.nix~ | Portable (requiere CPU con VT-x/AMD-V) |
| ~xmonad.nix~ | Portable (window manager) |
| ~xrdp.nix~ | Portable (remote desktop) |

* Migración Futura a Flakes

Estructura objetivo (pendiente):

#+BEGIN_SRC
dotfiles/
├── flake.nix              # Punto de entrada
├── hosts/
│   ├── aurin/
│   │   └── configuration.nix
│   └── vespino/
│       └── configuration.nix
└── modules/               # Módulos compartidos
    ├── nvidia-rtx5080.nix
    ├── nvidia-rtx2060.nix
    ├── audio-fiio-k7.nix
    └── ...
#+END_SRC

Beneficios:
- Reproducibilidad total
- Inputs pinneados
- Módulos compartidos entre máquinas
- Lock file para versiones exactas

* Referencias

** Documentación NixOS:
- [[https://nixos.org/manual/nixos/stable/][NixOS Manual]]
- [[https://nixos.wiki/][NixOS Wiki]]
- [[https://nixos.org/guides/nix-pills/][Nix Pills]]

** Configuraciones:
- XMonad: ~$HOME/.config/xmonad/xmonad.hs~
- Picom: ~$HOME/.config/picom/picom.conf~
- Fish: ~$HOME/.config/fish/config.fish~
- Alacritty: ~$HOME/.config/alacritty/alacritty.yml~

** Logs útiles:
#+BEGIN_SRC bash
# Sistema
journalctl -xe

# Kernel
journalctl -k

# Servicio específico
journalctl -u nombre-servicio

# Usuario
journalctl --user -u sunshine
#+END_SRC

* Changelog

** [2026-01-01] - Modularización Completa

*** Añadido:
- Estructura modular con 7 módulos independientes
- README.org con documentación completa
- Scripts de diagnóstico en módulos

*** Cambiado:
- ~configuration.nix~ reducido de 1112 a 560 líneas (-50%)
- Organización por funcionalidad en lugar de monolítico

*** Mejorado:
- Mantenibilidad y legibilidad
- Portabilidad de componentes
- Documentación inline en cada módulo

* Autor

- *Nombre:* passh
- *Sistema:* aurin (NixOS 25.05)
- *Última actualización:* 2026-01-01
