#+TITLE: NixOS Configuration - Vespino
#+AUTHOR: passh
#+DATE: 2026-01-01
#+STARTUP: overview

* Vespino System

Maquina secundaria con servidor Minecraft, NFS, y Ollama.

*Estado:* Vespino va "en las ultimas". Pendiente migrar Minecraft a aurin.

** Hardware
- CPU: Intel/AMD con soporte KVM
- GPU: NVIDIA (drivers propietarios stable)
- Red: enp10s0 (192.168.2.125) + br0 (192.168.53.10)

** Red - ZONA SAGRADA

#+begin_example
Internet
    |
    v
enp10s0 (192.168.2.125/24) --> Gateway 192.168.2.1
    |
    +-- br0 (192.168.53.10/24)
            |
            +-- VM Ubuntu (192.168.53.12)
                    |
                    +-- Cliente Ivanti VPN
                            |
                            v
                    Infraestructura Vocento
                    (10.180.0.0/16, 10.182.0.0/16, etc.)
#+end_example

*CRITICO:* La configuracion de red (bridge br0, rutas via 192.168.53.12) permite
acceso a la VPN de Vocento via VM Ubuntu con cliente Ivanti.

*NO MODIFICAR* la seccion de networking sin:
1. Backup de la VM Ubuntu
2. Snapshot de la generacion NixOS actual
3. Plan de rollback documentado

** Servicios principales

*** Minecraft Server
- Puerto: 25565
- Configuracion: =minecraft.nix=
- Admin: pascualmg
- Modo: Survival cooperativo
- Scripts: =mc-admin= (status, logs, restart, backup)

*** NFS Server
- =/storage= -> 192.168.2.0/24
- =/NFS= -> 192.168.2.0/24

*** Ollama + Open-webui
- Ollama: localhost:11434
- Open-webui: 0.0.0.0:3000
- CUDA acceleration con NVIDIA
- 8 threads OMP
- 4GB VRAM dedicados

*** Syncthing
- GUI: http://192.168.2.125:8384
- User: passh / Password: capullo100
- Carpetas sincronizadas:
  - =~/org= -> aurin, cohete, pocapullos
  - =~/storage/Camera= -> pocapullos

*** Virtualizacion
- libvirt/KVM con VFIO
- QEMU + OVMF
- Docker con autoPrune

** Limpieza 2026-01-01

Se eliminaron servicios no utilizados:
- RustDesk server (hbbs/hbbr) - No se usaba
- spice-vdagentd - Es para VMs invitadas, vespino es HOST
- qemuGuest - Es para VMs invitadas, vespino es HOST
- sound.enable - Deprecated, PipeWire lo maneja

Se actualizo sintaxis deprecated:
- =hardware.opengl= -> =hardware.graphics=

** Instalacion

Esta configuracion se gestiona con GNU Stow desde ~/dotfiles:

#+begin_src bash
cd ~/dotfiles
sudo stow -v -t / nixos-vespino
sudo nixos-rebuild test    # Probar primero!
sudo nixos-rebuild switch  # Aplicar si test OK
#+end_src

** Rollback de emergencia

#+begin_src bash
# Rollback a generacion anterior
sudo nixos-rebuild switch --rollback

# Ver generaciones disponibles
sudo nix-env -p /nix/var/nix/profiles/system --list-generations

# En GRUB: seleccionar "NixOS - Old configurations"
#+end_src

** Pendiente

- [ ] Arreglar WiFi Atheros (no funciona en el pueblo)
- [ ] Migrar servidor Minecraft a aurin
- [ ] Migrar a flakes (junto con aurin)

** Archivos de configuracion

| Archivo | Descripcion |
|---------+-------------|
| =configuration.nix= | Config principal (~525 lineas) |
| =hardware-configuration.nix= | Generado por nixos-generate-config |
| =minecraft.nix= | Servidor Minecraft modular |

** Diferencias con Aurin

| Aspecto | Vespino | Aurin |
|---------+---------+-------|
| Rol | Secundaria | Principal/Produccion |
| GPU | NVIDIA (drivers propietarios) | RTX 5080 (drivers open) |
| Modularizacion | Minima (solo minecraft.nix) | Completa (7 modulos) |
| CPU | Standard | Dual Xeon (72 threads) |
| RAM | Standard | 128GB |
| Servicios | Minecraft, NFS, Ollama | Sunshine, Audio FiiO, etc |
