#+TITLE: Dotfiles - passh (Multi-Machine NixOS)
#+AUTHOR: passh
#+DATE: 2026-01-23
#+STARTUP: overview

* La FilosofÃ­a HHKB Aplicada al Sistema Operativo

** La Historia

La primera vez que probÃ© un HHKB (Happy Hacking Keyboard), algo hizo clic. No fue inmediato - los primeros dÃ­as maldecÃ­a la distribuciÃ³n, buscaba teclas que no estaban donde esperaba. Pero despuÃ©s de una semana, algo cambiÃ³. Mis dedos sabÃ­an dÃ³nde ir sin pensar. El teclado dejÃ³ de ser un perifÃ©rico y se convirtiÃ³ en *una extensiÃ³n de mis manos*.

Ahora llevo el HHKB a todas partes: desktop, portÃ¡til, oficina. El hardware cambia (PC, Mac, Linux), pero la interfaz con la que pienso permanece. Mis manos no tienen que reaprender.

Entonces pensÃ©: *Â¿Y si pudiera hacer lo mismo con TODO mi entorno?*

No solo el teclado - tambiÃ©n mi shell, mis aliases de Git, mi configuraciÃ³n de Vim, mis keybindings de XMonad, mis herramientas de desarrollo. Todo.

*El HHKB se convirtiÃ³ en una extensiÃ³n de mis manos.*
*NixOS se convirtiÃ³ en una extensiÃ³n de mi cerebro.*

#+BEGIN_QUOTE
"When America's cowboys were in the middle of a trip and their horse died, they would leave the horse there. But even if they were in the middle of a desert, they would take their saddle with them. The horse was a consumable good, but the saddle was an interface that their bodies had gotten used to. In the same vein, PCs are consumable goods, while keyboards are important interfaces."

â€” Eiiti Wada, creador del Happy Hacking Keyboard
#+END_QUOTE

*Y si pudieras llevarte no solo la montura (el teclado), sino tambiÃ©n las riendas, el mapa del camino, y la forma en que piensas sobre el viaje?*

** El Problema que Todos Hemos Vivido

Imagina estos escenarios (que has vivido 1000 veces):

1. *Formatear / Reinstalar el sistema*
   - "Mierda, Â¿cuÃ¡l era el plugin de VSCode para formatear?"
   - "Â¿CÃ³mo coÃ±o se configuraba el Dockerfile para el proyecto?"
   - "TenÃ­a un alias de Git que era la hostia... Â¿cuÃ¡l era?"
   - "Las extensiones de Chrome, los favoritos, las sesiones guardadas..."
   - *4 horas despuÃ©s:* "Creo que ya estÃ¡... pero me falta algo y no sÃ© quÃ©"

2. *Nuevo portÃ¡til (del trabajo, personal, o porque el viejo muriÃ³)*
   - Teams, Slack, Zoom, Discord
   - Docker, Docker Compose, Kubernetes
   - IntelliJ IDEA, VSCode, Postman, DBeaver, pgAdmin
   - Node, Python, Go, Rust (con sus versiones especÃ­ficas)
   - Nginx, PostgreSQL, Redis, MongoDB
   - Git config (nombre, email, aliases), SSH keys, GPG keys
   - Fuentes (Nerd Fonts), temas, wallpapers, iconos
   - *2-3 DÃAS perdidos* instalando y configurando
   - *1 semana mÃ¡s* recordando "ah, me faltaba esto"

3. *Desktop potente en casa + PortÃ¡til + Servidor en la nube*
   - Cada mÃ¡quina configurada de forma diferente
   - "En el desktop funcionaba, en el portÃ¡til no... Â¿quÃ© cambiarÃ¡?"
   - Instalas algo nuevo â†’ tienes que acordarte de instalarlo en las otras 2
   - Actualizas config â†’ Â¿en cuÃ¡l de las 3 era la versiÃ³n buena?
   - *Caos absoluto* - nunca sabes quÃ© funciona dÃ³nde

** La SoluciÃ³n: Sistema Operativo Declarativo (NixOS)

#+BEGIN_SRC bash
# MÃ¡quina nueva (desktop gaming con RTX 5080)
git clone https://github.com/tu-usuario/dotfiles ~/dotfiles
sudo nixos-rebuild switch --flake ~/dotfiles#aurin

# 20 minutos despuÃ©s:
# âœ… Nvidia drivers configurados
# âœ… Docker + compose funcionando
# âœ… IntelliJ IDEA con tus plugins
# âœ… Fish shell con tu config
# âœ… XMonad con tus keybindings
# âœ… Claude AI agent con tus custom agents
# âœ… Crush AI apuntando a tu Ollama
# âœ… Alacritty con tu colorscheme
# âœ… TODO exactamente como lo tenÃ­as

# PortÃ¡til (MacBook Pro)
git pull  # Actualizas cambios del desktop
sudo nixos-rebuild switch --flake ~/dotfiles#macbook

# 15 minutos despuÃ©s:
# âœ… MISMA configuraciÃ³n
# âœ… MISMO entorno
# âœ… Solo difiere en hardware (HiDPI, baterÃ­a, WiFi)
#+END_SRC

** El Momento "OMG wtf is magic ğŸª„ XD!" - Caso Real de Esta Semana

*Viernes noche, 23 enero 2026:*

El ejemplo viene por que es con lo que estoy jugando esta semana, probando todos las uis alternativas a claude code y a ver si por fin alguna me deja conectarme en local con ollama. el Hype es el Hype :)
1. *En desktop (aurin)*: "Voy a probar Crush, un nuevo AI agent"
   - Creo =crush.nix= (90 lÃ­neas)
   - AÃ±ado config =crush.json= con Ollama local
   - =git commit && git push=

2. *En MacBook (10 minutos despuÃ©s)*:
   - =git pull=
   - =sudo nixos-rebuild switch=
   - *Magia*: Crush instalado, MISMA config
   - Como la config apunta a =campo.zapto.org:11434= (mi casa)...
   - *Â¡Uso la GPU 5080 de mi workstation (con mis 72 cores chinos ) desde el portÃ¡til!* ğŸ¤¯

3. *Lo que NO tuve que hacer*:
   - âŒ Reinstalar Crush en Mac
   - âŒ Reconfigurar providers/models
   - âŒ Copiar API keys manualmente
   - âŒ Recordar quÃ© versiÃ³n instalÃ© en aurin
   - âœ… Solo: =git pull && rebuild=

** No Es Solo "Dotfiles" - Es Tu Sistema Completo

#+BEGIN_SRC nix
# modules/home-manager/programs/ai-agents/crush.nix
# 90 lÃ­neas que instalan Crush en TODAS tus mÃ¡quinas
let
  charm-nur = builtins.fetchGit {
    url = "https://github.com/charmbracelet/nur";
    ref = "master";
  };
  crush = pkgs.callPackage "${charm-nur}/pkgs/crush" {};
in
{
  home.packages = [ crush ];
  # Config symlinkeado desde ~/dotfiles/crush/.config/crush/crush.json
  # Editas UNA VEZ â†’ funciona en TODAS las mÃ¡quinas
}
#+END_SRC

** El PatrÃ³n: Clone-First Architecture

*REGLA DE ORO:* Todas las mÃ¡quinas son CLONES IDÃ‰NTICOS. Solo difieren en hardware.

#+BEGIN_EXAMPLE
dotfiles/
â”œâ”€â”€ modules/base/           â† COMÃšN a TODAS las mÃ¡quinas
â”‚   â”œâ”€â”€ desktop.nix         (XMonad, GNOME, LightDM)
â”‚   â””â”€â”€ virtualization.nix  (Docker, libvirt)
â”œâ”€â”€ hardware/               â† Hardware-ESPECÃFICO
â”‚   â”œâ”€â”€ nvidia/rtx5080.nix  (aurin)
â”‚   â””â”€â”€ apple/macbook-pro.nix (macbook)
â””â”€â”€ hosts/                  â† Overrides MÃNIMOS
    â”œâ”€â”€ aurin/              (VPN Vocento, FiiO DAC)
    â””â”€â”€ macbook/            (casi vacÃ­o - todo viene de base/)

AI Agents (aÃ±adir nuevo = 30 lÃ­neas):
â”œâ”€â”€ claude-code.nix         (85 lÃ­neas)
â”œâ”€â”€ crush.nix               (90 lÃ­neas)
â””â”€â”€ opencode.nix            (83 lÃ­neas)

Â¿Quieres aider? â†’ Creas aider.nix (30 lÃ­neas) + 1 import
Â¿Quieres cursor? â†’ Creas cursor.nix (30 lÃ­neas) + 1 import
Â¿Quieres foo? â†’ Creas foo.nix (XX lÃ­neas) + 1 import y ya esta :)

#+END_EXAMPLE

** Para QuiÃ©n Es Esto

*Este repo es para ti si:*

1. *Tienes mÃºltiples mÃ¡quinas* (desktop + laptop + servidor)
2. *Odias reinstalar/reconfigurar* herramientas
3. *Quieres reproducibilidad* ("funcionaba ayer, Â¿por quÃ© no hoy?")
4. *Valoras tu tiempo* mÃ¡s que 2 dÃ­as configurando Teams/Slack/Docker
5. *Te gusta la filosofÃ­a HHKB*: tu entorno es TU montura, llÃ©vala contigo

*NO es para ti si:*

- Usas Windows/Mac y no quieres cambiar (aunque... Â¿seguro?) 
- "Me gusta configurar todo a mano cada vez" (respetable, pero raro)
- Tienes miedo a =git= y archivos de texto (tranqui, hay tutoriales)

** El Secreto: LLM como Asistente Experto

*Este repo estÃ¡ diseÃ±ado para trabajar con LLMs* (Claude, ChatGPT, etc.):

#+BEGIN_SRC text
TÃº: "Quiero aÃ±adir Neovim con mi config personalizada"

LLM: *Lee README.org + ai-agents/ pattern*
     "Voy a crear neovim.nix siguiendo el patrÃ³n:
     
     1. fetchGit de tu config (si estÃ¡ en GitHub)
     2. Symlink desde ~/dotfiles/nvim/
     3. AÃ±adir import en default.nix
     4. Rebuild en todas las mÃ¡quinas
     
     Â¿ContinÃºo?"

*5 minutos despuÃ©s:* Neovim configurado en desktop, laptop y servidor.
#+END_SRC

*Patrones documentados:*
- âœ… CÃ³mo aÃ±adir AI agents (fetchGit + callPackage)
- âœ… CÃ³mo gestionar configs (symlinks editables)
- âœ… CÃ³mo manejar licencias unfree (ejemplo: Crush)
- âœ… CÃ³mo separar hardware vs config base
- âœ… Clone-first philosophy (todo en comments)

** Empieza AquÃ­

1. *Curiosea el repo* - lee los mÃ³dulos, estÃ¡n comentados a muerte
2. *Forkea y adapta* - cambia =passh= por tu usuario, ajusta hardware
3. *Pregunta a un LLM* - "Â¿CÃ³mo aÃ±ado X siguiendo el patrÃ³n de este repo?"
4. *Disfruta* - nunca mÃ¡s "joder, Â¿cÃ³mo configurÃ© esto?"

#+BEGIN_QUOTE
*"No es solo un sistema operativo declarativo.*
*Es llevarte tu caballo, tu montura, tus riendas y el mapa del camino."*

â€” La filosofÃ­a del repo, 2026
#+END_QUOTE

---

* TL;DR - Setup Rapido

#+BEGIN_SRC bash
# Clonar dotfiles
git clone <repo> ~/dotfiles
cd ~/dotfiles

# Aplicar NixOS config (FLAKES - metodo actual)
# IMPORTANTE: Ejecutar 'hostname' primero para saber en que maquina estas
# IMPORTANTE: Todas las maquinas necesitan --impure (ver seccion abajo)

# Aurin
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# MacBook
sudo nixos-rebuild switch --flake ~/dotfiles#macbook --impure

# Vespino
sudo nixos-rebuild switch --flake ~/dotfiles#vespino --impure

# Test sin aplicar cambios permanentes
sudo nixos-rebuild test --flake ~/dotfiles#aurin --impure

# Rollback de emergencia
sudo nixos-rebuild switch --rollback
#+END_SRC

** Â¿Por quÃ© --impure? (Pure vs Impure en Nix)

*** El Concepto

Nix es *reproducible* por defecto: dado el mismo input, produce el mismo output.
Esto se llama *evaluaciÃ³n pura* (pure evaluation).

*Impure* significa que el resultado puede variar dependiendo de factores externos.

*** CuÃ¡ndo necesitas --impure

| Caso | Ejemplo | Por quÃ© es impure |
|------+---------+-------------------|
| *Leer archivos externos* | =builtins.readFile "/etc/hosts"= | El archivo puede cambiar |
| *fetchGit con branch* | =ref = "master"= | La branch cambia con commits |
| *Paths fuera del flake* | =./../../archivo.txt= | No estÃ¡ en el flake lockfile |
| *Variables de entorno* | =builtins.getEnv "HOME"= | Depende del sistema |

*** En este repo usamos --impure por:

1. *Hosts Vocento* (aurin/vespino):
   #+BEGIN_SRC nix
   # hosts/aurin/default.nix
   networking.extraHosts = builtins.readFile "/home/passh/src/vocento/autoenv/hosts_all.txt";
   #+END_SRC
   Lee un archivo externo al flake â†’ impure.

2. *Crush NUR* (todas las mÃ¡quinas):
   #+BEGIN_SRC nix
   # modules/home-manager/programs/ai-agents/crush.nix
   charm-nur = builtins.fetchGit {
     url = "https://github.com/charmbracelet/nur";
     ref = "master";  # â† Branch que cambia = IMPURE
   };
   #+END_SRC
   Fetch de una branch que evoluciona â†’ impure.

*** CÃ³mo hacer fetchGit PURE (si quisieras)

#+BEGIN_SRC nix
# IMPURE - branch que cambia
charm-nur = builtins.fetchGit {
  url = "https://github.com/charmbracelet/nur";
  ref = "master";  # â† Cambia con nuevos commits
};

# PURE - commit fijo (hash inmutable)
charm-nur = builtins.fetchGit {
  url = "https://github.com/charmbracelet/nur";
  rev = "a1b2c3d4e5f6...";  # â† Siempre el mismo contenido
};
#+END_SRC

*Trade-off:*
- =ref = "master"= â†’ Siempre Ãºltima versiÃ³n, pero necesita --impure
- =rev = "hash"= â†’ Reproducible sin --impure, pero hay que actualizar manualmente

*** Resumen

| Modo | Comando | CuÃ¡ndo usar |
|------+---------+-------------|
| *Pure* | =nixos-rebuild switch --flake .#host= | Cuando TODO estÃ¡ en flake.lock |
| *Impure* | =nixos-rebuild switch --flake .#host --impure= | Cuando lees archivos externos o fetch branches |

*En este repo:* Siempre usa =--impure=. Es seguro y necesario.

* ğŸš€ Use This Repo (Work in Progress)

*NOTA:* Este repo estÃ¡ diseÃ±ado para ser *forkeable*, pero actualmente tiene valores hardcoded (username =passh=, paths, info personal). Si quieres usarlo como base para tu sistema, sigue esta guÃ­a y adapta lo necesario.

** Quick Start for Others

*** 1. Fork & Clone

#+BEGIN_SRC bash
# Fork este repo en GitHub primero, luego:
git clone https://github.com/TU_USUARIO/dotfiles ~/dotfiles
cd ~/dotfiles
#+END_SRC

*** 2. Generar Hardware Config en Tu MÃ¡quina

#+BEGIN_SRC bash
# En tu mÃ¡quina nueva (booted con NixOS ISO):
sudo nixos-generate-config --show-hardware-config > \
  hardware-configuration.nix

# Crear directorio para tu host
mkdir -p hosts/TU_MAQUINA
mv hardware-configuration.nix hosts/TU_MAQUINA/
#+END_SRC

*** 3. Crear Host Config

#+BEGIN_SRC bash
# Copia un template existente (macbook es el mÃ¡s simple)
cp hosts/macbook/default.nix hosts/TU_MAQUINA/default.nix
vim hosts/TU_MAQUINA/default.nix
#+END_SRC

Adapta segÃºn tu hardware:
- =imports= - Elige mÃ³dulos hardware (NVIDIA, Apple, etc.)
- =services= - Habilita/deshabilita segÃºn necesites
- =networking.hostName= - Se configura automÃ¡ticamente en flake

*** 4. AÃ±adir al flake.nix

#+BEGIN_SRC nix
# En flake.nix, aÃ±ade tu mÃ¡quina:
nixosConfigurations.TU_MAQUINA = mkSystem {
  hostname = "TU_MAQUINA";
  hardware = [
    # Elige los que necesites:
    # ./hardware/nvidia/rtx5080.nix
    # ./hardware/apple/macbook-pro-13-2.nix
    # etc.
  ];
};
#+END_SRC

*** 5. âš ï¸ IMPORTANTE: Personalizar Valores Hardcoded

*CRÃTICO:* Estos archivos tienen info personal que DEBES cambiar:

#+BEGIN_SRC text
[ ] flake.nix
    â””â”€ users.passh â†’ users.TU_USUARIO

[ ] modules/home-manager/core.nix
    â”œâ”€ username = "passh" â†’ "TU_USUARIO"
    â”œâ”€ homeDirectory = "/home/passh" â†’ "/home/TU_USUARIO"
    â””â”€ programs.git.userEmail/userName â†’ TU info

[ ] claude-code/.claude/CLAUDE.md
    â”œâ”€ Eliminar: Red local (IPs, passwords)
    â”œâ”€ Eliminar: GitHub pascualmg â†’ TU_USUARIO
    â””â”€ Actualizar: Preferencias personales

[ ] claude-code/.claude/agents/
    â””â”€ Eliminar agentes personales:
       - vocento-software-architect.md (especÃ­fico empresa)
       - carlos-buenosvinos.md (personal)
       - chema.md (personal)
       - escriba.md (personal)

[ ] hosts/aurin/default.nix (si copias)
    â””â”€ Eliminar: VPN Vocento, hosts corporativos

[ ] .gitignore
    â””â”€ AÃ±adir: tus secrets (.credentials.json, etc.)
#+END_SRC

*** 6. Build & Install

#+BEGIN_SRC bash
# Build
sudo nixos-rebuild switch --flake ~/dotfiles#TU_MAQUINA

# Si falla, verifica:
nix flake check --show-trace
#+END_SRC

** What You Get

| Feature | Status |
|---------+--------|
| *Clone-first architecture* | âœ… Modular (base + hardware + host) |
| *Desktop ready* | âœ… GNOME + XMonad + LightDM configured |
| *AI agents (claude-code)* | âœ… Nixified, portable, customizable |
| *Home-manager* | âœ… 200+ packages, declarative configs |
| *Multi-machine support* | âœ… Easy to add new machines |
| *Hardware support* | âœ… NVIDIA, Apple, pro audio modules |
| *Wayland compositors* | âœ… Hyprland, niri, GNOME Wayland (SDDM) |
| *Plug-and-play* | âŒ WIP - requires manual adaptation |

** What's Personal (Must Customize)

| Item | Location | Action Required |
|------+----------+-----------------|
| *Username* | =flake.nix=, =core.nix= | Change "passh" to yours |
| *Git config* | =core.nix= | Update email/name |
| *CLAUDE.md* | =claude-code/.claude/= | Remove IPs/passwords/personal info |
| *AI agents* | =claude-code/.claude/agents/= | Remove personal agents |
| *VPN Vocento* | =hosts/aurin/=, =modules/services/= | Remove if not applicable |
| *Hosts file* | =hosts/aurin/default.nix= | Remove corporate hosts |
| *Secrets* | Various | Add to =.gitignore= |

** Roadmap: Full Template Support

*Current state:* Functional but requires manual adaptation

*Planned improvements* (after stow elimination + opencode integration):
- [ ] Parametrized username (=mainUser= variable)
- [ ] Template generator script (=./scripts/new-machine.sh=)
- [ ] Secrets management (sops-nix or agenix)
- [ ] Clean separation: personal vs. template
- [ ] Testing with real users (feedback loop)

*ETA:* When stow migration complete (~2-3 weeks)

** Community & Contributions

Si usas este repo y mejoras algo:

1. Fork & create branch: =feat/FEATURE=
2. Keep the clone-first philosophy
3. Document changes (README + comments)
4. Submit Pull Request

*Feedback wanted:* Si eres early adopter, abre un issue con tu experiencia.

** Support

*Issues:* [[https://github.com/pascualmg/dotfiles/issues]]
*Discussions:* [[https://github.com/pascualmg/dotfiles/discussions]]

*Philosophy:* This repo prioritizes *clarity* and *modularity* over convenience.
You'll need to understand NixOS basics to adapt it successfully.

* Arquitectura Clone-First (2026-01-19)

** Filosofia

*Todas las maquinas son CLONES IDENTICOS.* Solo se diferencian en hardware.

La configuracion se divide en 3 capas:

#+BEGIN_SRC text
modules/base/       -> Config comun a TODAS las maquinas (desktop, servicios, etc.)
hardware/           -> Config especifica de hardware (nvidia, apple, audio)
hosts/*/            -> Solo servicios y overrides especificos de cada maquina
#+END_SRC

** Estructura del Proyecto

#+BEGIN_SRC text
dotfiles/
|-- flake.nix                    * Entry point (mkSystem para clone-first)
|-- modules/
|   |-- base/                    * BASE UNIFICADA (todas las maquinas)
|   |   |-- default.nix          # Imports: boot, nix-settings, packages, desktop, etc.
|   |   |-- desktop.nix          # GNOME + XMonad (sesiones)
|   |   |-- sddm.nix             # SDDM display manager (X11 + Wayland)
|   |   |-- sunshine.nix         # Streaming server (opcional)
|   |   `-- virtualization.nix   # Docker + libvirt
|   |-- common/                  . Modulos legacy (usados por mkNixosConfig)
|   |-- desktop/                 * Wayland: hyprland.nix, niri.nix
|   `-- home-manager/            * Configuracion usuario passh
|-- hardware/                    * MODULOS HARDWARE
|   |-- nvidia/
|   |   |-- rtx5080.nix          # Aurin: RTX 5080 (open drivers)
|   |   `-- rtx2060.nix          # Vespino: RTX 2060
|   |-- apple/
|   |   |-- macbook-pro-13-2.nix # MacBook: keyd, HiDPI, bateria
|   |   `-- snd-hda-macbookpro.nix # MacBook: audio CS8409
|   `-- audio/
|       `-- fiio-k7.nix          # Aurin: DAC/AMP FiiO K7
|-- hosts/                       * HOST-SPECIFIC (solo overrides)
|   |-- aurin/
|   |   |-- hardware-configuration.nix
|   |   `-- default.nix          # VPN bridge, hosts Vocento, etc.
|   |-- macbook/
|   |   |-- hardware-configuration.nix
|   |   `-- default.nix          # Casi vacio (todo viene de base + hardware)
|   `-- vespino/
|       |-- hardware-configuration.nix
|       |-- default.nix          # NFS, Minecraft, VPN VM
|       `-- minecraft.nix        # Servidor Minecraft
|-- xmonad/                      * XMonad config (stow)
|-- nixos-*/                     . Legacy (pre-flakes, backup)
`-- README.org                     Este archivo
#+END_SRC

*Leyenda:* =* Activo= | =. Legacy/migrado=

** Como se construye cada maquina

#+BEGIN_SRC nix
# En flake.nix
aurin = mkSystem {
  hostname = "aurin";
  hardware = [
    ./hardware/nvidia/rtx5080.nix
    ./hardware/audio/fiio-k7.nix
  ];
};

macbook = mkSystem {
  hostname = "macbook";
  hardware = [
    nixos-hardware.nixosModules.apple-macbook-pro
    ./hardware/apple/macbook-pro-13-2.nix
    ./hardware/apple/snd-hda-macbookpro.nix
  ];
};

vespino = mkSystem {
  hostname = "vespino";
  hardware = [
    ./hardware/nvidia/rtx2060.nix
  ];
};
#+END_SRC

** Maquinas

| Maquina | Hardware | Rol | Display Manager |
|---------+----------+-----+-----------------|
| aurin   | Dual Xeon E5-2699v3, RTX 5080, 128GB | Produccion, desarrollo | SDDM |
| macbook | MacBook Pro 2016, Intel, HiDPI | Laptop, movilidad | SDDM |
| vespino | AMD CPU, RTX 2060 | Testing, Minecraft, NFS | SDDM |

** VPN Vocento (Ivanti/Pulse Secure) - EXPERIMENTAL [2026-01-21]

*** El Problema

Vocento usa *Ivanti VPN* (Pulse Secure) que NO funciona nativamente en NixOS.
El cliente propietario tiene dependencias imposibles de satisfacer.

*** La Solucion: VM como Gateway VPN

#+BEGIN_SRC text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              HOST (NixOS)                               â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  Interface Ext.  â”‚         â”‚    br0       â”‚       â”‚  VM Ubuntu   â”‚ â”‚
â”‚   â”‚ (WiFi/Ethernet)  â”‚   NAT   â”‚192.168.53.10 â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚192.168.53.12 â”‚ â”‚
â”‚   â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Bridge     â”‚       â”‚              â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚            â”‚                          â–²               â”‚ â”‚ Ivanti   â”‚ â”‚ â”‚
â”‚            â–¼                          â”‚               â”‚ â”‚ Client   â”‚ â”‚ â”‚
â”‚       Internet                   Rutas corp.          â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚                                  via VM               â”‚      â”‚tun0   â”‚ â”‚
â”‚                                                       â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â–¼
                                                        Redes Vocento
                                                        10.180.0.0/16
                                                        10.182.0.0/16
                                                        192.168.196.0/24
                                                        etc...
#+END_SRC

*** Modulos NixOS

Dos modulos declarativos que trabajan juntos:

| Modulo | Funcion | Ubicacion |
|--------+---------+-----------|
| =vocento-vpn-bridge.nix= | Bridge br0, NAT, rutas, DNS | =modules/services/= |
| =ivanti-vpn-vm.nix= | VM libvirt declarativa | =modules/services/= |

**** vocento-vpn-bridge.nix

Configura toda la red del host:

#+BEGIN_SRC nix
services.vocento-vpn-bridge = {
  enable = true;
  externalInterface = "wlp0s20f0u7u4";  # Interface con internet
  # hostAddress = "192.168.53.10";       # IP del host en bridge (default)
  # vmAddress = "192.168.53.12";         # IP de la VM (default)
};
#+END_SRC

*Que hace:*
- Crea bridge =br0= con IP =192.168.53.10/24=
- Configura NAT (MASQUERADE) para que la VM salga a internet
- AÃ±ade rutas estaticas: =10.180.0.0/16 via 192.168.53.12=, etc.
- Configura DNS apuntando a servidores Vocento
- AÃ±ade script =vpn-bridge-status= para diagnostico

**** ivanti-vpn-vm.nix

Define la VM de forma declarativa:

#+BEGIN_SRC nix
services.ivanti-vpn-vm = {
  enable = true;
  networkMode = "bridge";        # "nat" para testing, "bridge" para produccion
  vmAddress = "192.168.53.12";   # IP fija de la VM
};
#+END_SRC

*Que hace:*
- Genera XML de libvirt embebido en Nix
- Servicio systemd que define la VM al boot
- Script =vpn-vm= con comandos: start, stop, ssh, setup-network

*** Comandos Disponibles

#+BEGIN_SRC bash
# Gestion de la VM
vpn-vm start         # Arranca VM + abre virt-viewer
vpn-vm stop          # Apaga la VM
vpn-vm ssh           # SSH a la VM
vpn-vm status        # Estado y conectividad
vpn-vm setup-network # Configura IP en disco (VM apagada)

# Diagnostico del bridge
vpn-bridge-status    # Estado completo del sistema VPN
#+END_SRC

*** Reproducir en Equipo Nuevo

#+BEGIN_SRC bash
# 1. Copiar disco de la VM (17GB) desde maquina existente
scp origen:/var/lib/libvirt/images/ivanti-vpn-clone.qcow2 \
    /var/lib/libvirt/images/

# 2. Configurar en hosts/NUEVO/default.nix:
#+END_SRC

#+BEGIN_SRC nix
imports = [
  ../../modules/services/ivanti-vpn-vm.nix
  ../../modules/services/vocento-vpn-bridge.nix
];

services.ivanti-vpn-vm = {
  enable = true;
  networkMode = "bridge";
};

services.vocento-vpn-bridge = {
  enable = true;
  externalInterface = "enp0s31f6";  # <-- CAMBIAR a tu interface
};
#+END_SRC

#+BEGIN_SRC bash
# 3. Rebuild
sudo nixos-rebuild switch --flake ~/dotfiles#NUEVO

# 4. Configurar red en la VM (solo primera vez, automatico!)
vpn-vm setup-network

# 5. Arrancar y conectar
vpn-vm start
# -> En la VM: conectar cliente Ivanti
# -> Listo! bitbucket.vocento.com accesible desde el host
#+END_SRC

*** Estado: EXPERIMENTAL

| Aspecto | Estado |
|---------+--------|
| Funciona en macbook | âœ“ Probado |
| Funciona en vespino | â³ Pendiente probar |
| Funciona en aurin | â³ NO migrar (usar snapshot existente) |
| Reproducible | âœ“ Modulos declarativos |
| Disco VM en Nix | âœ— Manual (QCOW2 externo) |

*** Notas del NixOS Guru

*Puntos fuertes:*
- Estructura modular correcta
- Tipos bien definidos (submodules para rutas)
- Scripts helper muy utiles
- Documentacion en cabeceras

*Mejoras sugeridas:*
- AÃ±adir assertions para dependencias
- Hacer UUID de VM configurable
- Cuidado con referencias circulares en defaults

*Seguridad:*
- =checkReversePath = false= necesario pero riesgoso
- =--impure= requerido si usas hostsFile

*** Arquitectura Detallada

#+BEGIN_SRC text
                    MODULOS NIX
                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ modules/services/vocento-vpn-bridge.nix                â”‚
â”‚                                                         â”‚
â”‚  options:                                              â”‚
â”‚    - enable                                            â”‚
â”‚    - externalInterface (requerido)                     â”‚
â”‚    - hostAddress (default: 192.168.53.10)              â”‚
â”‚    - vmAddress (default: 192.168.53.12)                â”‚
â”‚    - vpnRoutes (lista de redes corporativas)           â”‚
â”‚    - dnsServers (default: DNS Vocento + 8.8.8.8)       â”‚
â”‚                                                         â”‚
â”‚  configura:                                            â”‚
â”‚    - networking.bridges.br0                            â”‚
â”‚    - networking.interfaces.br0.ipv4.routes             â”‚
â”‚    - networking.nat                                    â”‚
â”‚    - environment.etc."resolv.conf"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ modules/services/ivanti-vpn-vm.nix                     â”‚
â”‚                                                         â”‚
â”‚  options:                                              â”‚
â”‚    - enable                                            â”‚
â”‚    - networkMode ("nat" | "bridge")                    â”‚
â”‚    - vmAddress                                         â”‚
â”‚    - hostAddress                                       â”‚
â”‚                                                         â”‚
â”‚  configura:                                            â”‚
â”‚    - systemd.services.define-ivanti-vpn-vm             â”‚
â”‚    - environment.systemPackages [vpn-vm, guestfs-tools]â”‚
â”‚                                                         â”‚
â”‚  genera:                                               â”‚
â”‚    - XML libvirt con bridge o NAT segun modo           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hosts/macbook/default.nix                              â”‚
â”‚                                                         â”‚
â”‚  services.ivanti-vpn-vm.enable = true;                 â”‚
â”‚  services.ivanti-vpn-vm.networkMode = "bridge";        â”‚
â”‚  services.vocento-vpn-bridge.enable = true;            â”‚
â”‚  services.vocento-vpn-bridge.externalInterface = "...";â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_SRC

*** Troubleshooting

| Problema | Solucion |
|----------+----------|
| VM sin internet | Verificar NAT: =sudo iptables -t nat -L= |
| Host no resuelve DNS Vocento | Verificar ruta a DNS: =ping 192.168.201.38= |
| No llega a redes corporativas | Verificar VPN conectada en VM: =vpn-vm ssh= + =ip route= |
| Bridge no existe | =sudo systemctl start br0-netdev.service= |
| VM no arranca | Verificar disco: =ls /var/lib/libvirt/images/*.qcow2= |

*** Arbol del Proyecto VPN

#+BEGIN_SRC text
dotfiles/
â”œâ”€â”€ flake.nix                         # Entry point - define las 3 maquinas
â”‚
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â””â”€â”€ virtualization.nix        # Habilita libvirtd (REQUERIDO)
â”‚   â”‚
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ vocento-vpn-bridge.nix    # [VPN] Bridge + NAT + Rutas + DNS
â”‚       â”‚   â”œâ”€â”€ options:
â”‚       â”‚   â”‚   â”œâ”€â”€ enable
â”‚       â”‚   â”‚   â”œâ”€â”€ externalInterface  â† CAMBIAR segun maquina
â”‚       â”‚   â”‚   â”œâ”€â”€ hostAddress        (192.168.53.10)
â”‚       â”‚   â”‚   â”œâ”€â”€ vmAddress          (192.168.53.12)
â”‚       â”‚   â”‚   â””â”€â”€ vpnRoutes          (10.180.0.0/16, etc.)
â”‚       â”‚   â””â”€â”€ configura:
â”‚       â”‚       â”œâ”€â”€ networking.bridges.br0
â”‚       â”‚       â”œâ”€â”€ networking.nat
â”‚       â”‚       â””â”€â”€ /etc/resolv.conf
â”‚       â”‚
â”‚       â””â”€â”€ ivanti-vpn-vm.nix         # [VPN] VM declarativa en libvirt
â”‚           â”œâ”€â”€ options:
â”‚           â”‚   â”œâ”€â”€ enable
â”‚           â”‚   â”œâ”€â”€ networkMode        ("nat" | "bridge")
â”‚           â”‚   â””â”€â”€ vmAddress
â”‚           â””â”€â”€ configura:
â”‚               â”œâ”€â”€ systemd.services.define-ivanti-vpn-vm
â”‚               â””â”€â”€ scripts: vpn-vm
â”‚
â”œâ”€â”€ hosts/
â”‚   â”œâ”€â”€ aurin/default.nix             # NO USA modulos VPN (tiene su propia config)
â”‚   â”œâ”€â”€ macbook/default.nix           # USA modulos VPN âœ“
â”‚   â””â”€â”€ vespino/default.nix           # PENDIENTE probar modulos VPN
â”‚
â””â”€â”€ /var/lib/libvirt/images/
    â””â”€â”€ ivanti-vpn-clone.qcow2        # Disco VM (17GB) - EXTERNO AL REPO
#+END_SRC

*** Disaster Recovery: Recrear VM desde Cero

Si pierdes el disco QCOW2, aqui esta como recrear la VM:

**** 1. Descargar Ubuntu 22.04 LTS

#+BEGIN_SRC bash
# Desktop (tiene GUI para el cliente Ivanti)
wget https://releases.ubuntu.com/22.04/ubuntu-22.04.4-desktop-amd64.iso
#+END_SRC

**** 2. Crear VM en virt-manager

#+BEGIN_SRC text
- Nombre: ivanti-vpn
- RAM: 4096 MB
- CPUs: 2
- Disco: 20GB (qcow2)
- Red: Bridge br0 (o NAT para instalar)
- Instalar Ubuntu con usuario: passh / password: capullo100
#+END_SRC

**** 3. Configurar Ubuntu

#+BEGIN_SRC bash
# En la VM:
sudo apt update && sudo apt upgrade -y
sudo apt install -y openssh-server net-tools

# Configurar IP fija (si usas bridge)
sudo tee /etc/netplan/01-bridge.yaml << 'EOF'
network:
  version: 2
  ethernets:
    ens3:
      addresses: [192.168.53.12/24]
      routes:
        - to: default
          via: 192.168.53.10
      nameservers:
        addresses: [8.8.8.8]
EOF
sudo netplan apply
#+END_SRC

**** 4. Instalar cliente Ivanti/Pulse Secure

#+BEGIN_SRC bash
# Obtener el .deb de Vocento (pedir a IT o descargar del portal)
# Tipicamente: ps-pulse-linux-22.x.xxx.deb

sudo dpkg -i ps-pulse-linux-*.deb
sudo apt --fix-broken install -y

# El cliente queda en /opt/pulsesecure/
# Lanzar: /opt/pulsesecure/bin/pulseUI
#+END_SRC

**** 5. Configurar conexion VPN

#+BEGIN_SRC text
- Abrir pulseUI
- AÃ±adir conexion:
  - Nombre: Vocento
  - URL: (preguntar a IT, tipicamente https://vpn.vocento.com)
- Conectar con credenciales corporativas + Okta push
#+END_SRC

**** 6. Verificar funcionamiento

#+BEGIN_SRC bash
# En la VM:
ip route | grep tun    # Debe mostrar tun0
ping 10.180.0.1        # Debe responder (si existe)

# En el host:
ping 192.168.53.12     # VM alcanzable
host bitbucket.vocento.com  # DNS funciona
curl https://bitbucket.vocento.com  # Conectividad OK
#+END_SRC

*** Backup del Disco (Oro en Pano)

**** Backup a USB

#+BEGIN_SRC bash
# 1. Apagar la VM
vpn-vm stop

# 2. Montar USB (ajustar /dev/sdX)
sudo mount /dev/sdb1 /mnt/usb

# 3. Copiar disco (17GB, tarda un rato)
sudo cp /var/lib/libvirt/images/ivanti-vpn-clone.qcow2 /mnt/usb/
# O con progreso:
sudo rsync -ah --progress /var/lib/libvirt/images/ivanti-vpn-clone.qcow2 /mnt/usb/

# 4. Verificar
ls -lh /mnt/usb/ivanti-vpn-clone.qcow2

# 5. Desmontar
sudo umount /mnt/usb
#+END_SRC

**** Backup comprimido (mas pequeno)

#+BEGIN_SRC bash
# Comprimir (17GB -> ~6GB)
sudo qemu-img convert -O qcow2 -c \
  /var/lib/libvirt/images/ivanti-vpn-clone.qcow2 \
  /mnt/usb/ivanti-vpn-backup-$(date +%Y%m%d).qcow2

# Restaurar
sudo cp /mnt/usb/ivanti-vpn-backup-*.qcow2 \
  /var/lib/libvirt/images/ivanti-vpn-clone.qcow2
#+END_SRC

**** Ubicaciones de backup recomendadas

| Ubicacion | Prioridad | Notas |
|-----------+-----------+-------|
| USB externo | Alta | Portatil, offline |
| aurin:/backup/ | Media | Acceso rapido por red |
| NAS/Synology | Baja | Si tienes uno |

*** Cambio de Red WiFi

*Pregunta:* Â¿Que pasa si cambio de WiFi y tengo otra IP?

*Respuesta:* *No afecta* porque:

#+BEGIN_SRC text
Tu IP WiFi cambia (192.168.1.50 â†’ 192.168.2.100)
                    â†“
            NO IMPORTA porque:
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ br0: 192.168.53.10  â† IP FIJA (interna)        â”‚
â”‚ VM:  192.168.53.12  â† IP FIJA (interna)        â”‚
â”‚ NAT: usa INTERFACE, no IP                       â”‚
â”‚      (wlp0s20f0u7u4 sigue siendo la misma)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_SRC

*Solo falla si:* Cambias de interface fisica (ej: de WiFi USB a Ethernet).
En ese caso, cambia =externalInterface= en el config y rebuild.

** AI Agents (claude-code, opencode) - NIXIFICADO [2026-01-22]

*** El Problema: Stow â†’ Home-Manager Migration

HistÃ³ricamente, las configuraciones de =claude-code= se gestionaban con GNU Stow:
- Symlinks manuales desde =~/dotfiles/claude-code/.claude/= a =~/.claude/=
- No portable entre mÃ¡quinas
- Stow es deprecated, se estÃ¡ eliminando progresivamente
- DifÃ­cil de versionar cambios de forma declarativa

*Objetivo:* Nixificar toda la config AI para que sea:
- *Declarativa* - Gestionada por home-manager, no scripts
- *Portable* - Clone-first: misma config en aurin, macbook, vespino
- *Versionada* - Cambios trackeados en git
- *Multi-cliente* - Soportar claude-code, opencode, gemini-cli, etc.

*** La SoluciÃ³n: MÃ³dulo home-manager Unificado

#+BEGIN_SRC text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA AI AGENTS                           â”‚
â”‚                                                                     â”‚
â”‚  dotfiles/claude-code/.claude/    â† SOURCE (git versionado)        â”‚
â”‚         â”œâ”€â”€ CLAUDE.md                                               â”‚
â”‚         â”œâ”€â”€ settings.json                                           â”‚
â”‚         â”œâ”€â”€ agents/                                                 â”‚
â”‚         â”‚   â”œâ”€â”€ nixos-guru.md                                       â”‚
â”‚         â”‚   â”œâ”€â”€ vocento-software-architect.md                       â”‚
â”‚         â”‚   â””â”€â”€ ... (10 agentes)                                    â”‚
â”‚         â””â”€â”€ skills/                                                 â”‚
â”‚                                                                     â”‚
â”‚                    â–¼ (home-manager symlinks)                        â”‚
â”‚                                                                     â”‚
â”‚  ~/.claude/                       â† RUNTIME (symlinkado)           â”‚
â”‚         â”œâ”€â”€ CLAUDE.md        â†’ dotfiles/claude-code/.claude/...    â”‚
â”‚         â”œâ”€â”€ settings.json    â†’ dotfiles/claude-code/.claude/...    â”‚
â”‚         â”œâ”€â”€ agents/          â†’ dotfiles/claude-code/.claude/agents/â”‚
â”‚         â”œâ”€â”€ skills/          â†’ dotfiles/claude-code/.claude/skills/â”‚
â”‚         â”‚                                                           â”‚
â”‚         â””â”€â”€ [STATE - NO GESTIONADO]                                â”‚
â”‚             â”œâ”€â”€ .claude.json        (stats, history - 698 lÃ­neas)  â”‚
â”‚             â”œâ”€â”€ history.jsonl       (conversaciones)               â”‚
â”‚             â”œâ”€â”€ debug/              (logs)                          â”‚
â”‚             â””â”€â”€ cache/              (temp files)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_SRC

*** SeparaciÃ³n: Config vs State

*CRÃTICO:* Nix solo gestiona CONFIGURACIÃ“N, no estado runtime.

| Tipo | Archivos | Gestionado por Nix |
|------+----------+--------------------|
| *Config* | =settings.json=, =CLAUDE.md=, =agents/=, =skills/= | âœ… SÃ (symlinks) |
| *State* | =.claude.json=, =history.jsonl=, =debug/=, =cache/= | âŒ NO (runtime) |

*Por quÃ©?*
- Config: Definiciones estÃ¡ticas (preferencias, agentes)
- State: Datos mutables (historial, estadÃ­sticas, sesiones)

Si gestionaras state con Nix, cada =nixos-rebuild= resetearÃ­a tu historial.

*** MÃ³dulo: modules/home-manager/programs/ai-agents.nix

*UbicaciÃ³n:* Importado en =core.nix= (portable, no en =passh.nix= desktop-only)

#+BEGIN_SRC nix
# modules/home-manager/programs/ai-agents.nix
{ config, lib, pkgs, ... }:

let
  homeDir = config.home.homeDirectory;
  dotfilesDir = "${homeDir}/dotfiles";
in
{
  # ===========================================================================
  # Claude Code - Configuration symlinks
  # ===========================================================================
  
  home.file = {
    ".claude/settings.json".source = 
      config.lib.file.mkOutOfStoreSymlink 
      "${dotfilesDir}/claude-code/.claude/settings.json";
    
    ".claude/CLAUDE.md".source =
      config.lib.file.mkOutOfStoreSymlink
      "${dotfilesDir}/claude-code/.claude/CLAUDE.md";
    
    ".claude/agents".source =
      config.lib.file.mkOutOfStoreSymlink
      "${dotfilesDir}/claude-code/.claude/agents";
    
    ".claude/skills".source =
      config.lib.file.mkOutOfStoreSymlink
      "${dotfilesDir}/claude-code/.claude/skills";
  };
  
  # ===========================================================================
  # State directories (runtime, not managed by Nix)
  # ===========================================================================
  
  home.activation.createClaudeState = lib.hm.dag.entryAfter ["writeBoundary"] ''
    mkdir -p ~/.claude/{debug,file-history,session-env,todos,cache,projects}
  '';
  
  # ===========================================================================
  # Transition helper: Clean old stow symlinks
  # ===========================================================================
  
  home.activation.cleanOldClaudeStow = lib.hm.dag.entryBefore ["checkLinkTargets"] ''
    for link in ~/.claude/{settings.json,CLAUDE.md,agents,skills}; do
      if [[ -L "$link" ]] && [[ "$(readlink "$link")" == *"/dotfiles/claude-code/"* ]]; then
        rm -f "$link"
      fi
    done
  '';
}
#+END_SRC

*** IntegraciÃ³n en core.nix

#+BEGIN_SRC nix
# modules/home-manager/core.nix
{ config, pkgs, lib, ... }:

{
  imports = [
    ./programs/ai-agents.nix  # AI agents config (portable)
  ];
  
  # ... resto de config core ...
}
#+END_SRC

*** Eliminar claude-code de Stow

#+BEGIN_SRC nix
# modules/home-manager/passh.nix (lÃ­nea ~252)

# ANTES:
${pkgs.stow}/bin/stow -v -R -t ${config.home.homeDirectory} \
  composer xmonad claude-code

# DESPUÃ‰S:
${pkgs.stow}/bin/stow -v -R -t ${config.home.homeDirectory} \
  composer xmonad
# claude-code â†’ Migrado a home-manager (modules/home-manager/programs/ai-agents.nix)
#+END_SRC

*** Â¿Por quÃ© mkOutOfStoreSymlink?

*ComparaciÃ³n de mÃ©todos:*

#+BEGIN_SRC nix
# âŒ MAL - Copia al Nix store (read-only, duplicado)
home.file.".claude/CLAUDE.md".source = ./claude-code/.claude/CLAUDE.md;
# Resultado: /nix/store/hash-CLAUDE.md (inmutable)

# âœ… BIEN - Symlink fuera del store (mutable, single source of truth)
home.file.".claude/CLAUDE.md".source = 
  config.lib.file.mkOutOfStoreSymlink "${homeDir}/dotfiles/...";
# Resultado: ~/.claude/CLAUDE.md â†’ ~/dotfiles/claude-code/.claude/CLAUDE.md
#+END_SRC

*Ventajas:*
- Replica exactamente el comportamiento de stow
- Cambios en dotfiles son inmediatos (no rebuild necesario)
- Source of truth sigue siendo =~/dotfiles/=
- Editable con cualquier editor (no read-only)

*** Aplicar la ConfiguraciÃ³n

#+BEGIN_SRC bash
# 1. Git pull (si ya estÃ¡ en origin)
cd ~/dotfiles
git pull

# 2. Aplicar (aurin)
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# 3. Verificar symlinks
ls -la ~/.claude/
readlink ~/.claude/CLAUDE.md
# â†’ /home/passh/dotfiles/claude-code/.claude/CLAUDE.md

# 4. Verificar que no hay symlinks rotos
find ~/.claude -xtype l
# â†’ (vacÃ­o = todo OK)
#+END_SRC

*** Reproducir en MÃ¡quina Nueva

#+BEGIN_SRC bash
# 1. Clonar dotfiles
git clone <repo> ~/dotfiles
cd ~/dotfiles

# 2. Rebuild (automÃ¡ticamente configura AI agents)
sudo nixos-rebuild switch --flake ~/dotfiles#macbook

# 3. LISTO - claude-code funcionando con tus agentes y config
claude-code
#+END_SRC

*No se requiere:*
- âŒ Ejecutar =stow=
- âŒ Copiar archivos manualmente
- âŒ Configurar nada adicional

*Clone-first en acciÃ³n:* Misma config en aurin, macbook, vespino.

*** Estado Actual: Multi-Cliente Preparado

| Cliente | Estado | UbicaciÃ³n en ai-agents.nix |
|---------+--------+----------------------------|
| *claude-code* | âœ… ACTIVO | Symlinks configurados |
| *opencode* | â³ EXPERIMENTAL | Comentado (pending FASE 0) |
| *gemini-cli* | ğŸ“‹ FUTURO | No implementado |
| *github-copilot* | ğŸ¤” INVESTIGAR | Usa =~/.config/github-copilot/= |

*** Plan Futuro: Shared Agents (Multi-Cliente)

*Actualmente:* Cada cliente tiene su propia config en =dotfiles/CLIENTE/=

#+BEGIN_SRC text
dotfiles/
â”œâ”€â”€ claude-code/.claude/    â† Solo claude-code
â””â”€â”€ opencode/.opencode/     â† Solo opencode (futuro)
#+END_SRC

*Propuesta investigar:* Config compartida (si clientes son compatibles)

#+BEGIN_SRC text
dotfiles/
â”œâ”€â”€ ai-agents/              â† SHARED entre todos los clientes
â”‚   â”œâ”€â”€ GLOBAL.md          â† Instrucciones universales
â”‚   â”œâ”€â”€ agents/            â† Agentes compartidos
â”‚   â””â”€â”€ mcp-servers.json   â† MCP (Model Context Protocol)
â”œâ”€â”€ claude-code/           â† Solo overrides especÃ­ficos
â””â”€â”€ opencode/              â† Solo overrides especÃ­ficos
#+END_SRC

*Requisitos para implementar:*
1. *Investigar compatibilidad* - Â¿opencode lee formato .md de claude-code?
2. *Probar MCP* - Â¿opencode soporta mismo formato MCP?
3. *Arquitectura adaptadores* - MÃ³dulo que traduce shared â†’ per-client

*Estado:* ON HOLD hasta investigar opencode (FASE 0)

*** Comandos Ãštiles

#+BEGIN_SRC bash
# Ver symlinks de claude-code
ls -la ~/.claude/
readlink ~/.claude/CLAUDE.md

# Ver agentes disponibles
ls ~/dotfiles/claude-code/.claude/agents/

# Editar agente (cambios inmediatos, no rebuild)
vim ~/dotfiles/claude-code/.claude/agents/nixos-guru.md

# Verificar que claude-code lee la config
cat ~/.claude/settings.json

# Backup del estado (antes de rebuild)
cp ~/.claude.json ~/backup/.claude.json.$(date +%Y%m%d-%H%M)

# Rollback si algo falla
sudo nixos-rebuild switch --rollback
#+END_SRC

*** Troubleshooting

| Problema | SoluciÃ³n |
|----------+----------|
| Symlinks rotos despuÃ©s de rebuild | =find ~/.claude -xtype l= + eliminar manualmente |
| claude-code no lee config nueva | Reiniciar terminal / =hash -r= |
| Cambios en agentes no se aplican | Symlinks apuntan fuera del store, son inmediatos |
| =.claude.json= se resetea | *NO DEBE PASAR* - no gestionado por Nix, verificar |
| Error al hacer rebuild | =nix flake check= + revisar sintaxis |

*** Arquitectura Detallada: Flujo de ConfiguraciÃ³n

#+BEGIN_SRC text
                         FLUJO DE CONFIGURACIÃ“N
                         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. SOURCE (git)                                                    â”‚
â”‚    ~/dotfiles/claude-code/.claude/                                 â”‚
â”‚         â”œâ”€â”€ CLAUDE.md              â† Editable con cualquier editor â”‚
â”‚         â”œâ”€â”€ settings.json                                          â”‚
â”‚         â”œâ”€â”€ agents/                                                â”‚
â”‚         â””â”€â”€ skills/                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ git commit + push
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GIT REMOTE (github.com/pascualmg/dotfiles)                      â”‚
â”‚    Versionado, histÃ³rico, branches                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ git pull (en otra mÃ¡quina)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. NIX BUILD (nixos-rebuild switch)                                â”‚
â”‚    modules/home-manager/programs/ai-agents.nix                     â”‚
â”‚         â””â”€> Genera symlinks con mkOutOfStoreSymlink                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ home.activation
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RUNTIME (symlinks activos)                                      â”‚
â”‚    ~/.claude/CLAUDE.md â†’ ~/dotfiles/claude-code/.claude/CLAUDE.md  â”‚
â”‚    ~/.claude/agents â†’ ~/dotfiles/claude-code/.claude/agents        â”‚
â”‚                                                                    â”‚
â”‚    + State directories creados (debug/, cache/, etc.)              â”‚
â”‚    + Old stow symlinks limpiados (transition helper)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ claude-code lee config
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. AI CLIENT (claude-code)                                         â”‚
â”‚    Lee: ~/.claude/CLAUDE.md (via symlink)                          â”‚
â”‚    Lee: ~/.claude/agents/* (via symlink)                           â”‚
â”‚    Escribe: ~/.claude.json (state, NO gestionado por Nix)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_SRC

*** ComparaciÃ³n: Antes vs DespuÃ©s

*ANTES (Stow):*
#+BEGIN_SRC bash
cd ~/dotfiles
stow -v -R -t ~ claude-code
# â†’ Symlinks manuales, no versionados en sistema
# â†’ DifÃ­cil de replicar en nueva mÃ¡quina
# â†’ No integrado con NixOS rebuild
#+END_SRC

*DESPUÃ‰S (Home-Manager):*
#+BEGIN_SRC bash
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure
# â†’ Todo declarativo en Nix
# â†’ Reproducible en cualquier mÃ¡quina (clone-first)
# â†’ Rollback automÃ¡tico si falla
#+END_SRC

*** Notas del NixOS Guru

*Puntos fuertes:*
- âœ… SeparaciÃ³n config/state correcta
- âœ… =mkOutOfStoreSymlink= apropiado para dotfiles editables
- âœ… Transition helper para limpiar stow (temporal, removible despuÃ©s)
- âœ… Integrado en =core.nix= (portable, no desktop-only)
- âœ… Clone-first: funciona igual en todas las mÃ¡quinas

*Mejoras sugeridas:*
- Considerar =programs.ai-agents.enable= si quieres opt-in por mÃ¡quina
- AÃ±adir assertions para verificar que =dotfiles/= existe
- Documentar formato de agentes .md (para contribuidores)

*Warnings:*
- âš ï¸ NO commitear =.claude.json= (contiene history + stats)
- âš ï¸ NO commitear =.credentials.json= (auth tokens)
- âš ï¸ Symlinks son inmutables post-activation (no editables vÃ­a GUI)

*** Logs de ImplementaciÃ³n

*Fecha:* 2026-01-22
*Ejecutor:* opencode CLI
*Tiempo:* ~10 minutos
*Commit:* =4c32211= feat: nixify claude-code config (remove stow dependency)

*Cambios:*
- âœ… Creado =modules/home-manager/programs/ai-agents.nix=
- âœ… Modificado =modules/home-manager/core.nix= (import)
- âœ… Modificado =modules/home-manager/passh.nix= (stow cleanup)
- âœ… Verificado con =nix flake check=
- âœ… Aplicado en aurin (test + switch)
- âœ… Pushed a origin/master

*Testing:*
#+BEGIN_SRC bash
# VerificaciÃ³n post-aplicaciÃ³n
ls -la ~/.claude/
readlink ~/.claude/CLAUDE.md
find ~/.claude -xtype l  # â†’ vacÃ­o (sin symlinks rotos)
cat ~/.claude/settings.json  # â†’ lee correctamente
#+END_SRC

*Resultado:* âœ… Ã‰XITO - claude-code nixificado completamente

*** AI Agents - Arquitectura Clone-First [2026-01-23]

**** ğŸ“ Esquema de Directorios

#+BEGIN_EXAMPLE
dotfiles/
â”‚
â”œâ”€â”€ modules/home-manager/programs/ai-agents/
â”‚   â”œâ”€â”€ default.nix           # Imports: claude-code, crush, opencode
â”‚   â”œâ”€â”€ claude-code.nix       # 85 lÃ­neas - Symlinks + state dirs
â”‚   â”œâ”€â”€ crush.nix             # 49 lÃ­neas - Symlink config
â”‚   â””â”€â”€ opencode.nix          # 83 lÃ­neas - Symlink + state dirs
â”‚
â”œâ”€â”€ claude-code/              # â† EDITAMOS AQUÃ (config versionado)
â”‚   â””â”€â”€ .claude/
â”‚       â”œâ”€â”€ settings.json     # Config Claude
â”‚       â”œâ”€â”€ CLAUDE.md         # Instructions
â”‚       â”œâ”€â”€ agents/           # Custom agents
â”‚       â””â”€â”€ skills/           # Custom skills
â”‚
â”œâ”€â”€ crush/                    # â† EDITAMOS AQUÃ (config versionado)
â”‚   â””â”€â”€ .config/crush/
â”‚       â””â”€â”€ crush.json        # Config Crush (providers, models)
â”‚
â””â”€â”€ opencode/                 # â† EDITAMOS AQUÃ (config versionado)
    â””â”€â”€ .config/opencode/
        â””â”€â”€ package.json      # Config OpenCode (plugins TypeScript)
#+END_EXAMPLE

**** ğŸ”— Symlinks Generados (home-manager)

#+BEGIN_EXAMPLE
~/.claude/settings.json         â†’ ~/dotfiles/claude-code/.claude/settings.json
~/.claude/CLAUDE.md             â†’ ~/dotfiles/claude-code/.claude/CLAUDE.md
~/.claude/agents                â†’ ~/dotfiles/claude-code/.claude/agents
~/.claude/skills                â†’ ~/dotfiles/claude-code/.claude/skills

~/.config/crush/crush.json      â†’ ~/dotfiles/crush/.config/crush/crush.json

~/.config/opencode/package.json â†’ ~/dotfiles/opencode/.config/opencode/package.json
#+END_EXAMPLE

*IMPORTANTE:* Los symlinks apuntan a =~/dotfiles= (editable), NO al nix store.

**** ğŸ“Š Estado vs Config

**Config (gestionado por Nix):**
- Versionado en git
- En =~/dotfiles/<agent>/=
- Symlinkeado a =~/=
- Editable directamente

**Estado (runtime, NO gestionado):**

#+BEGIN_EXAMPLE
~/.claude/
â”œâ”€â”€ debug/                  # Logs de debug
â”œâ”€â”€ cache/                  # Cache de sesiones
â”œâ”€â”€ history.jsonl           # Historial de comandos
â”œâ”€â”€ file-history/           # Archivos editados
â””â”€â”€ ...                     # MÃ¡s dirs de estado

~/.local/share/opencode/
â”œâ”€â”€ auth.json               # OAuth tokens (Anthropic, OpenAI)
â””â”€â”€ storage/                # Sessions, messages, diffs

# Crush no tiene estado persistente
#+END_EXAMPLE

**** ğŸ”„ Workflow: AÃ±adir Nuevo Agente (ej: "aider")

**Paso 1: Crear config en dotfiles**

#+BEGIN_SRC bash
mkdir -p ~/dotfiles/aider/.config/aider
vim ~/dotfiles/aider/.config/aider/config.yaml
# Editar configuraciÃ³n del agente
#+END_SRC

**Paso 2: Crear mÃ³dulo Nix (~30 lÃ­neas)**

#+BEGIN_SRC nix
# modules/home-manager/programs/ai-agents/aider.nix
{ config, lib, pkgs, ... }:

let
  dotfilesDir = "${config.home.homeDirectory}/dotfiles";
in
{
  home.activation.setupAider = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
    echo "ğŸ“ Configurando aider..."
    mkdir -p ~/.config/aider
    
    # Remove nix store symlink if exists
    if [[ -L ~/.config/aider/config.yaml ]] && [[ "$(readlink ~/.config/aider/config.yaml)" == *"/nix/store/"* ]]; then
      rm ~/.config/aider/config.yaml
    fi
    
    # Create symlink to dotfiles (editable, not in store)
    if [[ ! -e ~/.config/aider/config.yaml ]]; then
      ln -sf "${dotfilesDir}/aider/.config/aider/config.yaml" ~/.config/aider/config.yaml
    fi
  '';
}
#+END_SRC

**Paso 3: AÃ±adir import (1 lÃ­nea)**

#+BEGIN_SRC nix
# modules/home-manager/programs/ai-agents/default.nix
{
  imports = [
    ./claude-code.nix
    ./crush.nix
    ./opencode.nix
    ./aider.nix        # â† AÃ±adir esta lÃ­nea
  ];
}
#+END_SRC

**Paso 4: Deploy**

#+BEGIN_SRC bash
cd ~/dotfiles
git add .
git commit -m "feat(ai-agents): Add aider agent"
git push

# En cualquier mÃ¡quina
git pull
sudo nixos-rebuild switch --flake ~/dotfiles#$(hostname) --impure

# Verificar
readlink ~/.config/aider/config.yaml
# â†’ /home/passh/dotfiles/aider/.config/aider/config.yaml âœ…
#+END_SRC

**** âœ… Beneficios Clone-First

| Aspecto | ImplementaciÃ³n |
|---------+----------------|
| *Config* | En =~/dotfiles/<agent>/= (versionado git) |
| *MÃ³dulo* | Symlink simple (~30-85 lÃ­neas) |
| *Escalabilidad* | AÃ±adir agente = create file + 1 import |
| *EdiciÃ³n* | Editas JSON/YAML directo (fuera de nix store) |
| *Deploy* | =git pull && nixos-rebuild= en todas las mÃ¡quinas |
| *Portabilidad* | Misma config en aurin, macbook, vespino, android |

**** ğŸ¯ FilosofÃ­a

#+BEGIN_QUOTE
*"Config en dotfiles/, Nix solo hace symlinks"*

- âŒ NO: ParametrizaciÃ³n Nix (=programs.crush.enable=, =settings= options)
- âœ… SÃ: Symlinks simples (activation scripts)
- âœ… SÃ: Config editable directamente (JSON, YAML, Markdown)
- âœ… SÃ: Clone-first (mismo cÃ³digo en todas las mÃ¡quinas)

*AÃ±adir nuevo agente = 30 lÃ­neas .nix + 1 import. Done.*
#+END_QUOTE

**** ğŸš€ Agentes Actuales

| Agente | LÃ­neas Nix | Config | Package Source | Estado |
|--------+------------+--------+----------------|--------|
| =claude-code= | 85 | =.claude/= | nixpkgs | âœ… Activo |
| =crush= | 90 | =.config/crush/= | NUR (fetchGit) | âœ… Activo (v0.35.0+) |
| =opencode= | 83 | =.config/opencode/= | nixpkgs | âœ… Activo |

*Total mÃ³dulos:* 3 agentes = 258 lÃ­neas Nix (vs 139 monolÃ­tico anterior)

*PrÃ³ximos fÃ¡ciles de aÃ±adir:* =aider=, =cursor=, =continue= (~30 lÃ­neas cada uno)

*** OpenCode / Crush - InvestigaciÃ³n [2026-01-23]

**** Estado del Ecosistema

| Herramienta | Estado | nixpkgs | VersiÃ³n |
|-------------+--------+---------+---------|
| =claude-code= | âœ… Activo | =pkgs.claude-code= | Latest |
| =opencode= | âš ï¸ Archivado (Sep 2025) | =pkgs.opencode= | 1.1.23 (Ãºltima) |
| =crush= | âœ… Activo | NUR Charmbracelet | 0.34.1+ |

**** OpenCode: Funciona con OAuth Anthropic Max

A pesar de estar "archivado", =opencode= en nixpkgs *FUNCIONA* correctamente:
- VersiÃ³n 1.1.23 en nixpkgs es estable
- OAuth con Anthropic Max funciona
- Multi-provider (Anthropic, OpenAI, OpenRouter, etc.)

#+BEGIN_SRC bash
# Ya instalado via home-manager
opencode --version  # 1.1.23
#+END_SRC

**** Crush: AI Agent (Clone-First)

Crush es mantenido por *Charmbracelet* (creadores de Bubble Tea, Gum, etc.).
Soporta mÃºltiples providers: Ollama, Anthropic, OpenAI, OpenRouter.

***** ImplementaciÃ³n (Clone-First)

Crush usa el mismo patrÃ³n que claude-code y opencode:
- Config en =~/dotfiles/crush/.config/crush/crush.json= (editable)
- MÃ³dulo en =modules/home-manager/programs/ai-agents/crush.nix= (symlink)
- Habilitado por defecto en todas las mÃ¡quinas

***** MÃ³dulo Nix (NUR Charmbracelet)

Crush usa NUR (Nix User Repository) de Charmbracelet para versiÃ³n actualizada (0.35.0+).

****** Por quÃ© NUR y no nixpkgs:

- nixpkgs: =crush 0.22.1= (antigua)
- NUR Charmbracelet: =crush 0.35.0+= (latest)
- Crush tiene licencia unfree (=fsl11Mit=)

****** SoluciÃ³n: fetchGit + callPackage (sin modificar flake)

#+BEGIN_SRC nix
# modules/home-manager/programs/ai-agents/crush.nix
{ config, lib, pkgs, ... }:

let
  homeDir = config.home.homeDirectory;
  dotfilesDir = "${homeDir}/dotfiles";
  
  # Fetch NUR Charmbracelet (NO requiere aÃ±adir al flake.nix)
  charm-nur = builtins.fetchGit {
    url = "https://github.com/charmbracelet/nur";
    ref = "master";
  };
  
  # Rebuild crush con NUESTRO pkgs (hereda allowUnfree del flake)
  crush = pkgs.callPackage "${charm-nur}/pkgs/crush" {};
in
{
  # Instalar crush desde NUR
  home.packages = [ crush ];  # v0.35.0+
  
  # Symlink config desde dotfiles (editable)
  home.activation.setupCrush = lib.hm.dag.entryAfter [ "writeBoundary" ] ''
    mkdir -p ~/.config/crush
    if [[ ! -e ~/.config/crush/crush.json ]]; then
      ln -sf "${dotfilesDir}/crush/.config/crush/crush.json" ~/.config/crush/crush.json
    fi
  '';
}
#+END_SRC

****** Por quÃ© funciona:

1. =fetchGit= descarga NUR sin modificar flake.nix
2. =pkgs.callPackage= rebuilda usando NUESTRO pkgs
3. Nuestro pkgs tiene =allowUnfree = true= (flake.nix)
4. Crush hereda allowUnfree â†’ se instala sin problemas
5. Clone-first: funciona igual en todas las mÃ¡quinas

****** Alternativas rechazadas:

- âŒ AÃ±adir =charm-nur= al flake â†’ overlays complejos
- âŒ Usar =pkgs.crush= de nixpkgs â†’ versiÃ³n antigua (0.22.1)
- âŒ =NIXPKGS_ALLOW_UNFREE=1= â†’ no declarativo

***** Config Actual (Ollama Remoto)

#+BEGIN_SRC json
// ~/dotfiles/crush/.config/crush/crush.json
{
  "providers": {
    "ollama-aurin": {
      "name": "Ollama (Aurin RTX 5080)",
      "base_url": "http://campo.zapto.org:11434/v1/",
      "type": "openai-compat",
      "models": [
        {"name": "Qwen3 14B", "id": "qwen3:14b", "context_window": 32768},
        {"name": "GPT-OSS 20B", "id": "gpt-oss:20b", "context_window": 32768},
        {"name": "Devstral Small 2", "id": "devstral-small-2:latest", "context_window": 32768}
      ]
    }
  }
}
#+END_SRC

***** Uso

#+BEGIN_SRC bash
# Ejecutar crush
crush

# Shortcuts
Ctrl+O  # Seleccionar modelo
Ctrl+K  # Comandos
Ctrl+?  # Ayuda

# Editar config
vim ~/dotfiles/crush/.config/crush/crush.json
# Cambios se aplican inmediatamente (symlink)
#+END_SRC

**** Ollama: Modelos Locales para Agentes

***** Modelos con Soporte de Tools (AgÃ©nticos)

*IMPORTANTE:* Solo estos modelos soportan function calling para agentes AI:

| Modelo | VRAM | Tools | Notas |
|--------+------+-------+-------|
| =qwen3:14b= | ~9GB | âœ… | Recomendado, ligero |
| =gpt-oss:20b= | ~13GB | âœ… | Buen balance |
| =devstral-small-2:latest= | ~15GB | âœ… | LÃ­mite 16GB VRAM |
| =qwen3-coder:30b= | ~18GB | âœ… | Mejor para cÃ³digo |

***** Modelos SIN soporte de tools (no sirven para agentes):

- =qwen2.5-coder:*= - Sin tool calling
- =deepseek-r1:*= - Solo reasoning, sin tools
- =gemma3:*= - Sin tools
- =mistral:latest= - VersiÃ³n antigua sin tools
- =llama3.1:latest= - Sin tools

***** ConfiguraciÃ³n Crush para Ollama Remoto

#+BEGIN_SRC json
{
  "providers": {
    "ollama-aurin": {
      "name": "Ollama (Aurin RTX 5080)",
      "base_url": "http://campo.zapto.org:11434/v1/",
      "type": "openai-compat",
      "models": [
        {"name": "Qwen3 14B", "id": "qwen3:14b", "context_window": 32768},
        {"name": "GPT-OSS 20B", "id": "gpt-oss:20b", "context_window": 32768},
        {"name": "Devstral Small 2", "id": "devstral-small-2:latest", "context_window": 32768}
      ]
    }
  }
}
#+END_SRC

***** Instalar Modelos con Tools

#+BEGIN_SRC bash
# En la mÃ¡quina con Ollama (aurin):
ollama pull qwen3:14b
ollama pull gpt-oss:20b
ollama pull devstral-small-2

# Modelos adicionales recomendados:
ollama pull qwen3-coder:30b    # Mejor para cÃ³digo
ollama pull mistral-small3.2   # Buen tool calling
#+END_SRC

**** Referencias AI Agents

- *Crush*: https://github.com/charmbracelet/crush
- *Charm NUR*: https://github.com/charmbracelet/nur
- *OpenCode (archivado)*: https://github.com/opencode-ai/opencode
- *Ollama Tools Models*: https://ollama.com/search?c=tools
- *Agent Skills*: https://agentskills.io

* Configuraciones Principales

** Home Manager (~/.config/home-manager/home.nix) *

*Gestiona:* Instalacion de paquetes user-level con Nix

*Caracteristicas:*
- Paquetes desde =stable=, =unstable= y =master=
- Desactiva gestion de configs (usamos stow)
- 200+ paquetes instalados

*Paquetes destacados:*
| Categoria       | Paquetes                                      |
|-----------------+-----------------------------------------------|
| Shells          | fish, zsh, bash                               |
| Editores        | emacs (unstable), neovim, doom-emacs          |
| Development     | php83, nodejs_24, go, python3, rust           |
| Window Manager  | xmonad, xmobar, picom, dmenu                  |
| Tools           | docker, lazydocker, k9s, direnv               |
| Media           | vlc, spotify, obs-studio                      |
| Communication   | telegram-desktop, slack, discord              |
| AI              | ollama, claude-code                           |
| Browsers        | firefox, brave, google-chrome                 |

*Aplicar cambios:*
#+BEGIN_SRC bash
# Con flakes (recomendado) - home-manager integrado en nixos-rebuild
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure
#+END_SRC

** NixOS Aurin (/etc/nixos/configuration.nix) *

*Ver documentacion completa:* [[file:nixos-aurin/README.org][nixos-aurin/README.org]]

*Sistema:* Dual Xeon E5-2699v3 + RTX 5080 + FiiO K7 + 128GB RAM

*Caracteristicas principales:*
- NVIDIA RTX 5080 (drivers open-source beta)
- PipeWire optimizado para FiiO K7 DAC/AMP
- Sunshine streaming server (NVENC)
- Virtualizacion KVM/QEMU + Docker
- Ollama + Open WebUI (AI local)
- Dual NIC + bridge para VMs
- NUMA optimizations para dual socket

*Scripts del sistema:*
| Comando          | Descripcion                      |
|------------------+----------------------------------|
| =aurin-info=     | Info completa del sistema        |
| =fiio-k7-test=   | Test DAC/AMP FiiO K7             |
| =sunshine-test=  | Test streaming Sunshine          |
| =xeon-stress=    | Stress test dual Xeon            |
| =numa-info=      | Info NUMA dual socket            |
| =temp-monitor=   | Monitor temperaturas             |

** XMonad (~/.config/xmonad/xmonad.hs) *

*Tiling window manager* escrito en Haskell

*Caracteristicas:*
- Layouts: Tall, ThreeCol, Grid, MultiCol
- Scratchpads: terminal, emacs, jetbrains-toolbox
- Grid selector (M-g)
- Integracion con xmobar
- Keybindings personalizados

*Keybindings importantes:*
| Tecla               | Accion                              |
|---------------------+-------------------------------------|
| =M-p=               | Dmenu (launcher)                    |
| =M-g=               | Grid selector                       |
| =M-S-<Enter>=       | Alacritty                           |
| =M-S-c=             | Cerrar ventana                      |
| =M-<Space>=         | Cambiar layout                      |
| =M-S-f=             | Fullscreen                          |
| =M-[1-9]=           | Cambiar workspace                   |
| =M-S-[1-9]=         | Mover ventana a workspace           |
| =M-j/k=             | Focus siguiente/anterior            |
| =M-h/l=             | Resize master                       |
| =M-S-a=             | Sink all (des-float todas)          |
| =M-S-s=             | Sticky window (all workspaces)      |
| =M-S-k=             | Kill sticky copies                  |
| =M-<F1>=            | Scratchpad terminal                 |
| =M-<F2>=            | Scratchpad Emacs                    |
| =M-<F3>=            | JetBrains Toolbox                   |
| =M-<Print>=         | Flameshot screenshot                |
| =XF86AudioMute=     | Toggle mute                         |
| =XF86AudioRaise=    | Volumen +5%                         |
| =XF86AudioLower=    | Volumen -5%                         |

*Dmenu:* Busca en flatpak apps + nix-profile + $PATH

*Recargar config:*
#+BEGIN_SRC bash
# Recompilar y recargar (HOT RELOAD - no pierde ventanas!)
M-q

# O manualmente
xmonad --recompile && xmonad --restart
#+END_SRC

*** Multi-Monitor y Workspaces

XMonad tiene un modelo de workspaces MUY diferente a otros WMs (GNOME, KDE, i3).
Entender esto es clave para no volverse loco con mÃºltiples monitores.

**** El modelo "peculiar" de XMonad

#+BEGIN_SRC text
En GNOME/KDE:
  Monitor 1: WS1, WS2, WS3 (fijos a este monitor)
  Monitor 2: WS4, WS5, WS6 (fijos a este monitor)
  â†’ Cada monitor tiene SUS workspaces

En XMonad (por defecto):
  Pool compartido: WS1, WS2, WS3, WS4, WS5, WS6, WS7, WS8, WS9
  Monitor 1: muestra WS1 (puede mostrar cualquiera)
  Monitor 2: muestra WS3 (puede mostrar cualquiera)
  â†’ Los workspaces FLOTAN entre monitores
#+END_SRC

**** greedyView vs view (comportamiento al cambiar workspace)

**greedyView:** Los workspaces se INTERCAMBIAN

#+BEGIN_SRC text
Estado inicial:
  Monitor 1: [WS1]     Monitor 2: [WS3]

EstÃ¡s en Monitor 1, pulsas M-3:
  Monitor 1: [WS3]     Monitor 2: [WS1]  â† Â¡SWAP!

El WS3 viene a tu monitor, el WS1 va al otro.
#+END_SRC

**view (config actual):** Solo mueve el FOCO

#+BEGIN_SRC text
Estado inicial:
  Monitor 1: [WS1]     Monitor 2: [WS3]

EstÃ¡s en Monitor 1, pulsas M-3:
  Monitor 1: [WS1]     Monitor 2: [WS3]  â† Sin cambios
                            ^
                       Foco aquÃ­ ahora

Tu cursor/foco salta al Monitor 2 donde ya estÃ¡ WS3.
Ideal para: "reuniÃ³n en monitor 2, trabajo en monitor 1"
#+END_SRC

**** Cambiar entre view y greedyView

*Config actual usa =view=.* Para volver a =greedyView= (swap), edita =xmonad.hs=:

#+BEGIN_SRC haskell
-- Cambiar esto (en keybindings M-[1-9]):
, ("M-1", windows $ W.view "1")

-- Por esto:
, ("M-1", windows $ W.greedyView "1")
#+END_SRC

Luego =M-q= para hot-reload y probar.

**** IndependentScreens (workspaces por monitor)

Para tener workspaces INDEPENDIENTES por monitor (como GNOME/KDE):

#+BEGIN_SRC haskell
import XMonad.Layout.IndependentScreens

-- En main:
xmonad $ def
    { workspaces = withScreens 2 ["1","2","3","4","5","6","7","8","9"]
    -- ...
    }

-- Keybindings cambian:
-- M-1 en monitor 0 â†’ workspace "0_1"
-- M-1 en monitor 1 â†’ workspace "1_1"
#+END_SRC

Con 2 monitores tendrÃ­as 18 workspaces: =0_1= a =0_9= y =1_1= a =1_9=.

**** PhysicalScreens (navegar entre monitores)

Para teclas dedicadas a saltar entre monitores fÃ­sicos:

#+BEGIN_SRC haskell
import XMonad.Actions.PhysicalScreens

-- Keybindings:
, ("M-w", viewScreen def 0)      -- Ir a monitor 0 (izquierda/principal)
, ("M-e", viewScreen def 1)      -- Ir a monitor 1 (derecha/secundario)
, ("M-r", viewScreen def 2)      -- Ir a monitor 2 (si existe)

-- Mover ventana a otro monitor:
, ("M-S-w", sendToScreen def 0)
, ("M-S-e", sendToScreen def 1)
#+END_SRC

**** CycleWS (navegaciÃ³n avanzada)

Para navegar solo por workspaces no vacÃ­os o del monitor actual:

#+BEGIN_SRC haskell
import XMonad.Actions.CycleWS

-- Solo workspaces con ventanas:
, ("M-<Right>", moveTo Next NonEmptyWS)
, ("M-<Left>", moveTo Prev NonEmptyWS)

-- Mover ventana al siguiente workspace no vacÃ­o:
, ("M-S-<Right>", shiftTo Next NonEmptyWS)

-- Alternar entre los 2 Ãºltimos workspaces usados:
, ("M-<Tab>", toggleWS)
#+END_SRC

**** ConfiguraciÃ³n recomendada para ultrawide (aurin)

Para el monitor ultrawide 5120x1440 de aurin, el layout =ThreeColMid=
funciona muy bien (master en el centro, slaves a los lados):

#+BEGIN_SRC haskell
-- Ya configurado en myLayoutHook:
ThreeColMid 1 (3/100) (2/3)  -- 1 master, incremento 3%, ratio 2/3
#+END_SRC

**** xrandr: detectar y configurar monitores

#+BEGIN_SRC bash
# Ver monitores conectados
xrandr

# Configurar monitor ultrawide como primario
xrandr --output DP-4 --mode 5120x1440 --rate 120 --primary

# AÃ±adir segundo monitor a la derecha
xrandr --output HDMI-0 --mode 1920x1080 --right-of DP-4

# Apagar monitor
xrandr --output HDMI-0 --off
#+END_SRC

**** autorandr: perfiles automÃ¡ticos

Para cambiar automÃ¡ticamente entre configs de monitores:

#+BEGIN_SRC bash
# Guardar configuraciÃ³n actual como perfil
autorandr --save trabajo

# Listar perfiles
autorandr --list

# Aplicar perfil
autorandr --load trabajo

# Detectar y aplicar automÃ¡ticamente
autorandr --change
#+END_SRC

**** arandr: configuraciÃ³n grÃ¡fica

=arandr= es la GUI para xrandr. Permite arrastrar monitores visualmente
y genera scripts de configuraciÃ³n.

#+BEGIN_SRC bash
# Lanzar
arandr

# Guardar layout â†’ genera script en ~/.screenlayout/
#+END_SRC

**** Resumen: quÃ© elegir

| Escenario | RecomendaciÃ³n |
|-----------+---------------|
| Monitor Ãºnico | Config actual (view) funciona igual |
| Ultrawide (aurin) | Config actual + ThreeColMid |
| Dual monitor + reuniÃ³n fija | Config actual (view) âœ“ |
| Quieres swap de workspaces | Cambiar a =greedyView= |
| Quieres workspaces fijos por monitor | IndependentScreens |

** Picom (~/.config/picom/picom.conf) *

*Compositor X11* para transparencias, sombras, animaciones, blur

*Caracteristicas:*
- Backend: GLX (optimizado para RTX 5080)
- VSync: enabled (120Hz)
- Refresh rate: 120
- Transparencias: terminals, rofi, etc.
- Sombras suaves en ventanas
- No borders cuando fullscreen

*Configuracion importante:*
#+BEGIN_SRC conf
backend = "glx";
vsync = true;
refresh-rate = 120;
unredir-if-possible = true;  # Mejor para gaming/video
#+END_SRC

*Recargar:*
#+BEGIN_SRC bash
killall picom
picom &
#+END_SRC

** Fish Shell (~/.config/fish/config.fish) *

*Shell moderno* con autocompletado y syntax highlighting

*Config actual:*
#+BEGIN_SRC fish
# PATH additions
set -x PATH /home/passh/.config/emacs/bin $PATH      # Doom Emacs
set -x PATH /home/passh/node_modules/.bin $PATH      # Node local
set -x PATH /home/passh/.local/bin $PATH             # Local bins
#+END_SRC

*Features:*
- =completions/= - Autocompletados personalizados
- =conf.d/= - Configs adicionales
- =functions/= - Funciones personalizadas

*Uso:*
#+BEGIN_SRC bash
# Cambiar a fish
chsh -s $(which fish)

# O usar temporalmente
fish
#+END_SRC

** Alacritty (~/.config/alacritty/) *

*Terminal emulator* GPU-accelerated

*Configuracion:* Ver =~/.config/alacritty/alacritty.yml=

*Features:*
- Renderizado GPU (OpenGL)
- Scrollback history
- True color support
- Integracion con tmux/byobu

** La IncreÃ­ble XMobar (~/.config/xmobar/) *

*Status bar minimalista y elegante* para XMonad. FilosofÃ­a: solo iconos Nerd Font
y valores, sin texto redundante. Si un monitor no aplica a la mÃ¡quina, simplemente
no aparece.

*** FilosofÃ­a de diseÃ±o

- *Solo iconos*: Nerd Fonts para mÃ¡xima densidad de informaciÃ³n
- *Smart monitors*: Si no aplica (ej: baterÃ­a en desktop), no muestra nada (exit 0)
- *Auto-detecciÃ³n*: GPU detecta NVIDIA/Intel/AMD automÃ¡ticamente
- *Colores con significado*: Gradiente verdeâ†’amarilloâ†’rojo segÃºn estado
- *Mismo cÃ³digo, todas las mÃ¡quinas*: Clone-first, sin configs por mÃ¡quina

*** Vista previa

#+BEGIN_SRC text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ó°¡¨02  ó°•¾124%  ó°ˆ€(192.168.2.147)  ó°‹Š21% 48Â°  ó°¢®04% ó°”50Â° ó°›1.3G ó°š¥33W  ó°›08%  ó°¾…1.8GHz  ó°» 04% ó°”46Â° â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚      â”‚           â”‚              â”‚            â”‚                   â”‚         â”‚
  â”‚      â”‚           â”‚              â”‚            â”‚                   â”‚         â””â”€ CPU (uso% + temp)
  â”‚      â”‚           â”‚              â”‚            â”‚                   â””â”€ CPU Freq (GHz + governor)
  â”‚      â”‚           â”‚              â”‚            â””â”€ GPU (uso% temp VRAM watts)
  â”‚      â”‚           â”‚              â””â”€ Discos (uso% + temp)
  â”‚      â”‚           â””â”€ Red (IP)
  â”‚      â””â”€ Volumen (%)
  â””â”€ Docker (containers)
#+END_SRC

En laptops tambiÃ©n aparecen: ó±Š£ BaterÃ­a, âŒ¨ HHKB BT, ó°¤¨ WiFi

*** Modos disponibles

| Modo | DescripciÃ³n | Uso |
|------+-------------+-----|
| Full | Todo en una barra | Monitor Ãºnico, aurin ultrawide |
| Split | Dos barras separadas | Multi-monitor, MacBook + externo |

*** Modo Split (MacBook)

#+BEGIN_SRC text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ó°¥” Hora â”‚ [1] 2 3 4 â”‚ Layout â”‚ TÃ­tulo ventana               â”‚  â† Arriba (workspaces)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    ... contenido ...
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ó°¡¨ ó°•¾ ó±Š£ âŒ¨ ó°¤¨ ó°ˆ€ ó°‹Š ó°¢® ó°› ó°¾… ó°»                         â”‚  â† Abajo (monitores)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_SRC

*Archivos:*
| Archivo | PosiciÃ³n | Contenido |
|---------+----------+-----------|
| =xmobar-workspaces.hs= | Top | Hora + Workspaces + Layout + TÃ­tulo |
| =xmobar-monitors.hs= | Bottom | Todos los monitores del sistema |
| =xmobar-full.hs= | (Full) | Todo junto para monitor Ãºnico |

*** Monitores disponibles (scripts/xmobar-*.sh)

| Monitor | Script | Icono | DescripciÃ³n | Smart |
|---------+--------+-------+-------------+-------|
| Docker | =xmobar-docker.sh= | ó°¡¨ | Containers activos | Si no hay Docker/containers: oculto |
| Volumen | =xmobar-volume.sh= | ó°•¾ | Nivel PipeWire con gradiente | Siempre visible |
| BaterÃ­a | =xmobar-battery.sh= | ó±Š£ | Carga + estado (charging/discharging) | Si no hay baterÃ­a: oculto |
| HHKB | =xmobar-hhkb-battery.sh= | âŒ¨ | BaterÃ­a teclado HHKB Hybrid BT | Si no hay HHKB BT: oculto |
| RatÃ³n | =xmobar-mouse-battery.sh= | ó°½ | BaterÃ­a ratÃ³n Logitech (HID++) | Si no hay ratÃ³n Logitech: oculto |
| WiFi | =xmobar-wifi.sh= | ó°¤¨ | SSID red WiFi | Si no hay WiFi/conectado: oculto |
| Red | =xmobar-network.sh= | ó°ˆ€ | IP principal (eth/wifi) | Siempre visible |
| Discos | =xmobar-disks.sh= | ó°‹Š | Uso % + temperatura NVMe | Siempre visible |
| GPU | =xmobar-gpu.sh= | ó°¢® | Uso, temp, VRAM, watts | Auto-detecta NVIDIA/Intel/AMD |
| RAM | =xmobar-memory.sh= | ó°› | Uso con gradiente | Siempre visible |
| CPU Freq | =xmobar-cpu-freq.sh= | ó°¾… | Frecuencia + governor | Siempre visible |
| CPU | =xmobar-cpu.sh= | ó°»  | Uso % + temperatura | Siempre visible |

*** GPU: Auto-detecciÃ³n (xmobar-gpu.sh)

El script unificado detecta automÃ¡ticamente el tipo de GPU:

#+BEGIN_SRC bash
# Prioridad: NVIDIA > AMD > Intel
# En aurin (RTX 5080): usa nvidia-smi
# En macbook (Intel): usa /sys/class/drm/card*/gt_cur_freq_mhz
# Si no hay GPU dedicada: no muestra nada
#+END_SRC

Output ejemplo NVIDIA:
#+BEGIN_SRC text
ó°¢®04% ó°”50Â° ó°›1.3G ó°š¥33W   (uso% temp VRAM watts)
#+END_SRC

*** Test en terminal: xmobar-test-all.sh

Script para ver todos los monitores en la terminal con los mismos colores que xmobar.
Se ejecuta automÃ¡ticamente al abrir cada terminal (fish greeting).

#+BEGIN_SRC bash
# Ejecutar manualmente
~/dotfiles/scripts/xmobar-test-all.sh

# Output (con colores ANSI truecolor):
ó°¡¨02  ó°•¾124%  ó°ˆ€(192.168.2.147)  ó°‹Š21% 48Â°  ó°¢®04% ó°”50Â° ó°›1.3G ó°š¥33W  ó°›08%  ó°¾…1.8GHz  ó°» 04% ó°”46Â°
#+END_SRC

*Magia del color*: Convierte tags xmobar =<fc=#RRGGBB>= a ANSI truecolor usando Perl:

#+BEGIN_SRC perl
# <fc=#56b6c2>text</fc> â†’ \e[38;2;86;182;194mtext\e[0m
s/<fc=#(..)(..)(..)>([^<]*)<\/fc>/chr(27)."[38;2;".hex($1).";".hex($2).";".hex($3)."m".$4.chr(27)."[0m"/ge
#+END_SRC

*** Sistema de colores (xmobar-colors.sh)

Todos los scripts usan =xmobar-colors.sh= para gradientes consistentes:

#+BEGIN_SRC bash
# Colores One Dark
COLOR_GREEN="#98c379"   # Bueno (>70%)
COLOR_YELLOW="#e5c07b"  # Warning (30-70%)
COLOR_ORANGE="#d19a66"  # Alto
COLOR_RED="#e06c75"     # CrÃ­tico (<30%)

# Funciones
pct_to_color 75          # Devuelve color segÃºn % (0=verde, 100=rojo)
pct_to_color_inverse 75  # Inverso (0=rojo, 100=verde) - para baterÃ­a
#+END_SRC

*** Recargar

#+BEGIN_SRC bash
# Recargar solo xmobar (sin reiniciar xmonad)
killall xmobar && xmonad --restart

# O simplemente
M-q  # Recompila y reinicia xmonad (relanza xmobars)
#+END_SRC

*** PersonalizaciÃ³n por mÃ¡quina

En =modules/home-manager/machines/<maquina>.nix=:

#+BEGIN_SRC nix
dotfiles.xmobar = {
  enable = true;
  fontSize = 22;           # MacBook HiDPI
  gpuType = "intel";       # intel | nvidia | none
  showBattery = true;      # Laptops
  showWirelessMouse = false;
};
#+END_SRC

** Scripts (~/scripts/) .

*Scripts utiles del sistema*

| Script                   | Descripcion                               |
|--------------------------+-------------------------------------------|
| =vm-backupeitor.sh=      | Backup/restore VMs libvirt (XML + QCOW2)  |
| =bootstrap-doom.sh=      | Setup inicial Doom Emacs en mÃ¡quinas nuevas |
| =sync-wallpapers.sh=     | Sincronizar wallpapers                    |
| =xmobar-*.sh=            | Scripts de monitorizaciÃ³n para xmobar     |
| =xmobar-hhkb-battery.sh= | BaterÃ­a HHKB Hybrid (BT) con colores      |
| =trayer-*.sh=            | GestiÃ³n de trayer (system tray)           |
| =wireless-mouse.sh=      | Monitor baterÃ­a ratÃ³n wireless            |

** Wallpapers (~/wallpapers/) .

Fondos de pantalla

*Gestion:*
- Nitrogen (GUI)
- O directamente con =feh=

** Shell (bashrc/zshrc) .

*Posiblemente legacy* - Fish es el shell principal

Contiene:
- =.bashrc= - Configuracion Bash
- =.zshrc= - Configuracion Zsh

*Usar?* Probablemente no si usas Fish, pero mantienen compatibilidad

** Composer (~/.config/composer/) .

*PHP Composer* config

Probablemente para desarrollo PHP (tienes php83 en home.nix)

* Guia Stow - Gestion de Dotfiles

** Que es Stow?

GNU Stow crea *enlaces simbolicos* desde tu dotfiles repo a tu $HOME

** Comandos Esenciales

#+BEGIN_SRC bash
cd ~/dotfiles

# Crear enlaces (primera vez)
stow PAQUETE

# Quitar enlaces
stow -D PAQUETE

# Recrear enlaces (cuando cambias cosas)
stow -R PAQUETE

# Ver que va a hacer sin ejecutar
stow -n PAQUETE

# Verbose (siempre recomendado)
stow -v PAQUETE
#+END_SRC

** Workflows Comunes

*** Activar configuracion por primera vez:
#+BEGIN_SRC bash
cd ~/dotfiles
stow -v xmonad
stow -v fish
#+END_SRC

*** Actualizar configuracion existente:
#+BEGIN_SRC bash
# Editar archivo en dotfiles
vim ~/dotfiles/fish/.config/fish/config.fish

# Recrear enlaces (por si acaso)
stow -R fish
#+END_SRC

*** Para NixOS (necesita root y target /):
#+BEGIN_SRC bash
sudo stow -v -R -t / nixos-aurin

# Verificar
ls -la /etc/nixos/

# Aplicar cambios
sudo nixos-rebuild switch
#+END_SRC

** Flags Explicadas

| Flag     | Significado  | Uso                              |
|----------+--------------+----------------------------------|
| =-v=     | Verbose      | Ver que hace stow                |
| =-R=     | Restow       | Quitar y recrear enlaces         |
| =-D=     | Delete       | Solo quitar enlaces              |
| =-t DIR= | Target       | Directorio donde crear enlaces   |
| =-n=     | No execute   | Simular sin ejecutar (dry-run)   |

** Pro Tips

- *Nunca uses =sudo stow=* para archivos de usuario (home)
- *Siempre usa =sudo stow -t /=* para archivos del sistema (/etc)
- *Usa =-R=* cuando dudes, es mas seguro
- *Usa =-v=* siempre para ver que hace
- *Usa =-n=* para testing antes de ejecutar
- *Git tu dotfiles* para backup/sync

** Troubleshooting

*** "Conflicts with existing target"
#+BEGIN_SRC bash
# Ver que conflicta
stow -v -n PAQUETE

# Quitar archivo manual (backup primero)
mv ~/.config/fish/config.fish ~/.config/fish/config.fish.backup

# Volver a stow
stow fish
#+END_SRC

*** "Permission denied"
#+BEGIN_SRC bash
# Para archivos del sistema (/etc)
sudo stow -t / PAQUETE

# Para archivos de usuario (nunca uses sudo)
stow PAQUETE
#+END_SRC

*** Ver enlaces existentes
#+BEGIN_SRC bash
# Ver todos los symlinks en home
find ~ -maxdepth 3 -type l -ls | grep dotfiles

# Ver especifico
ls -la ~/.config/fish/config.fish
#+END_SRC

* Git Workflow

#+BEGIN_SRC bash
cd ~/dotfiles

# Ver cambios
git status
git diff

# Commit cambios
git add .
git commit -m "Update xmonad keybindings"
git push

# En otra maquina
git pull
stow -R xmonad  # Recrear enlaces
#+END_SRC

** Credenciales Git Persistentes

Las credenciales de git se almacenan permanentemente gracias a =credential.helper = store=
configurado en =modules/home-manager/passh.nix=.

*Ubicacion:* =~/.git-credentials=

*Formato del archivo:*
#+BEGIN_SRC text
https://usuario:password@bitbucket.vocento.com
https://usuario:token@github.com
#+END_SRC

*Primera vez:* Git pedira credenciales una vez y las guardara automaticamente.

*Regenerar credenciales:*
#+BEGIN_SRC bash
# Borrar credenciales existentes
rm ~/.git-credentials

# El proximo git push/pull pedira credenciales de nuevo
#+END_SRC

*Seguridad:* El archivo tiene permisos =600= (solo el usuario puede leer/escribir).

* Comandos Mas Usados

#+BEGIN_SRC bash
# Aplicar NixOS config (FLAKES - metodo actual)
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure
sudo nixos-rebuild switch --flake ~/dotfiles#macbook
sudo nixos-rebuild switch --flake ~/dotfiles#vespino --impure

# Test sin aplicar permanentemente
sudo nixos-rebuild test --flake ~/dotfiles#aurin --impure

# Rollback
sudo nixos-rebuild switch --rollback

# Activar config stow (solo para xmonad ya)
stow -v -R xmonad
#+END_SRC

* Setup Completo Nueva Maquina

#+BEGIN_SRC bash
# 1. Clonar dotfiles
git clone <repo-url> ~/dotfiles
cd ~/dotfiles

# 2. Aplicar NixOS config (incluye home-manager)
# Cambiar 'aurin' por tu hostname
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# 3. Aplicar xmonad (unico que aun usa stow)
stow -v xmonad

# 4. Recargar shell
fish

# 5. Reiniciar sesion X (logout/login) o:
xmonad --recompile && xmonad --restart
#+END_SRC

* Notas de Desarrollo

** Home Manager vs NixOS config

- *NixOS config* (=/etc/nixos/configuration.nix=): Sistema base, servicios, hardware
- *Home Manager* (=~/.config/home-manager/home.nix=): Paquetes usuario, configs user-level

** Channels

#+BEGIN_SRC bash
# Ver channels
nix-channel --list

# Deberia mostrar:
# home-manager https://github.com/nix-community/home-manager/archive/release-25.05.tar.gz
#+END_SRC

** Direnv

Tienes =direnv= instalado. Usa =.envrc= en proyectos para cargar variables automaticamente:

#+BEGIN_SRC bash
# En directorio proyecto
echo "use nix" > .envrc
direnv allow
#+END_SRC

* Ejecutar Programas sin Instalar: nix-index, comma y mas

Esta es probablemente la feature mas util de NixOS para el dia a dia.

** El Problema: "command not found"

Imagina este escenario clasico:

#+BEGIN_SRC bash
$ cowsay "hola"
bash: cowsay: command not found
#+END_SRC

En sistemas tradicionales (Ubuntu, Debian), tendrias que:
1. Buscar en Google que paquete contiene =cowsay=
2. Instalar el paquete con =apt install cowsay=
3. Ahora si, ejecutar =cowsay=

Esto es tedioso. Y en NixOS, donde no usamos =apt=, la solucion historica era
aun mas engorrosa. Pero hoy tenemos herramientas *mucho mejores*.

** La Solucion Moderna: comma (,)

#+BEGIN_SRC bash
# En vez de instalar nada, simplemente:
$ , cowsay "hola"
 ______
< hola >
 ------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
#+END_SRC

*Si, es literal una coma seguida del comando.* comma busca automaticamente
que paquete contiene el binario, lo descarga temporalmente, y lo ejecuta.
No queda instalado. Magia.

** Historia: Como Llegamos Aqui

*** Era 1: command-not-found de Ubuntu

Ubuntu popularizo un sistema ingenioso: cuando escribias un comando que no
existia, te sugeria que paquete instalar. NixOS intento copiarlo con
=programs.command-not-found.enable = true=, pero la base de datos estaba
frecuentemente rota o desactualizada.

*** Era 2: nix-index (hazlo tu mismo)

Alguien penso: "Y si generamos nuestra propia base de datos indexando TODO nixpkgs?"

#+BEGIN_SRC bash
$ nix-index  # ADVERTENCIA: tarda 30-60 minutos!
#+END_SRC

Funcionaba, pero nadie quiere esperar una hora cada vez que necesita actualizar.

*** Era 3: nix-index-database (la comunidad al rescate)

La comunidad penso: "Por que cada usuario genera el mismo indice? Hagamoslo
una vez y compartamoslo."

#+BEGIN_SRC text
                  ANTES                         AHORA
                  -----                         -----
Usuario A:  nix-index (60 min)        Descarga DB precompilada (30 seg)
Usuario B:  nix-index (60 min)        Descarga DB precompilada (30 seg)
Usuario C:  nix-index (60 min)        Descarga DB precompilada (30 seg)
#+END_SRC

*** Era 4: comma (el atajo definitivo)

Y finalmente, comma une todo: busca en la DB + descarga + ejecuta, en un comando.

** Las Diferentes Formas de Ejecutar Programas

*** Metodo 1: =, comando= (comma) - USO DIARIO

#+BEGIN_SRC bash
$ , cowsay "el metodo mas facil"
$ , ffmpeg -i video.mp4 -c:v libx264 output.mp4
$ , ncdu /home  # analizar disco sin instalar ncdu
#+END_SRC

Busqueda automatica, cero friccion. *Este es el que usaras el 90% del tiempo.*

*** Metodo 2: =nix shell nixpkgs#= - Shell interactivo

#+BEGIN_SRC bash
$ nix shell nixpkgs#cowsay nixpkgs#lolcat
[shell]$ cowsay "tengo ambos disponibles" | lolcat
[shell]$ exit
#+END_SRC

Util cuando necesitas varios programas juntos en un shell temporal.

*** Metodo 3: =nix run nixpkgs#= - Ejecutar una vez

#+BEGIN_SRC bash
$ nix run nixpkgs#cowsay -- "ejecuto y termino"
$  # Ya volviste a tu shell normal
#+END_SRC

Similar a comma pero especificas el paquete exacto.

*** Metodo 4: =nix-shell -p= - Legacy pero funciona

#+BEGIN_SRC bash
$ nix-shell -p python3 python3Packages.requests
[nix-shell]$ python3 script.py
[nix-shell]$ exit
#+END_SRC

El metodo antiguo (pre-flakes). Todavia util para scripts con shebangs.

** Cuando Usar Cual

#+BEGIN_SRC text
Quiero ejecutar un programa que no tengo instalado
                    |
                    v
        Se que paquete es? ----No----> Usa: , comando
                    |
                   Si
                    |
                    v
        Necesito shell interactivo? --No--> nix run nixpkgs#pkg
                    |
                   Si
                    |
                    v
              nix shell nixpkgs#pkg
#+END_SRC

| Metodo              | Flakes | Interactivo | Busqueda | Caso de Uso        |
|---------------------+--------+-------------+----------+--------------------|
| =, comando=         | Si     | No          | Auto     | *USO DIARIO*       |
| =nix shell nixpkgs#= | Si     | Si          | Manual   | Shell temporal     |
| =nix run nixpkgs#=  | Si     | No          | Manual   | Ejecutar una vez   |
| =nix-shell -p=      | No     | Si          | Manual   | Scripts, legacy    |

** Buscar Paquetes con nix-locate

#+BEGIN_SRC bash
# Que paquete tiene el comando 'rg'?
$ nix-locate bin/rg
ripgrep.out        /nix/store/...-ripgrep-14.1/bin/rg

# Que paquete tiene libcurl?
$ nix-locate 'lib/libcurl.so'
curl.out           /nix/store/...-curl-8.5/lib/libcurl.so
#+END_SRC

** Configuracion en Este Repo

En el =flake.nix=, nix-index-database esta como input:

#+BEGIN_SRC nix
inputs = {
  nix-index-database = {
    url = "github:nix-community/nix-index-database";
    inputs.nixpkgs.follows = "nixpkgs";
  };
};
#+END_SRC

Y se habilita para todas las maquinas:

#+BEGIN_SRC nix
programs.nix-index-database.comma.enable = true;
#+END_SRC

La base de datos se actualiza automaticamente cuando haces =nix flake update=.

** Ejemplos Practicos de Uso Diario

#+BEGIN_SRC bash
# Probar un programa antes de instalarlo
$ , neofetch

# Convertir video (sin tener ffmpeg instalado)
$ , ffmpeg -i input.mp4 -c:v libx265 output.mp4

# Analizar uso de disco
$ , ncdu /home

# Generar QR code
$ , qrencode -o qr.png "https://example.com"

# Ver arbol de procesos
$ , pstree

# Benchmark rapido
$ , hyperfine 'sleep 0.1' 'sleep 0.2'
#+END_SRC

** Scripts Reproducibles con Dependencias

Puedes crear scripts que traen sus propias dependencias:

#+BEGIN_SRC bash
#!/usr/bin/env nix-shell
#!nix-shell -i bash -p cowsay lolcat

# Este script se auto-provee cowsay y lolcat
cowsay "Mis dependencias vienen conmigo" | lolcat
#+END_SRC

O con flakes (mas moderno):

#+BEGIN_SRC bash
#!/usr/bin/env -S nix shell nixpkgs#cowsay nixpkgs#lolcat --command bash

cowsay "Version con flakes" | lolcat
#+END_SRC

** Troubleshooting

*** nix-locate no encuentra nada

#+BEGIN_SRC bash
# Actualizar la base de datos
$ nix flake update nix-index-database ~/dotfiles
$ sudo nixos-rebuild switch --flake ~/dotfiles#aurin
#+END_SRC

*** comma pregunta multiples opciones

#+BEGIN_SRC bash
$ , python
Multiple packages provide 'python':
  1) python2
  2) python3
Select [1-3]:
#+END_SRC

Solucion: especifica el paquete exacto con =, python3 script.py=

* Multiples Versiones de nixpkgs: pkgs vs pkgsMaster

A veces necesitas un paquete mas nuevo de lo que hay en nixpkgs-unstable.
Este repo usa un sistema multi-channel para resolver eso.

** El Problema

#+BEGIN_SRC text
nixpkgs-master  -->  claude-code 2.1.6  (commits de hoy)
     |
     | ~2-7 dias de propagacion
     v
nixpkgs-unstable --> claude-code 2.1.2  (lo que tienes normalmente)
#+END_SRC

Los paquetes fluyen: master -> unstable -> stable. Puede tardar dias o semanas.

** La Solucion: Dos Fuentes de Paquetes

En =flake.nix= tenemos dos inputs de nixpkgs:

#+BEGIN_SRC nix
inputs = {
  nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
  nixpkgs-master.url = "github:NixOS/nixpkgs/master";  # Bleeding edge
};
#+END_SRC

Y exponemos ambos a todos los modulos:

#+BEGIN_SRC nix
# En el flake
pkgs = import nixpkgs { ... };          # 99% de paquetes
pkgsMaster = import nixpkgs-master { ... };  # Paquetes nuevos

specialArgs = { inherit pkgsMaster; };  # Disponible en todos los modulos
#+END_SRC

** Uso en Practica

#+BEGIN_SRC nix
# En cualquier modulo (configuration.nix, passh.nix, etc.)
{ pkgs, pkgsMaster, ... }:
{
  home.packages = with pkgs; [
    firefox        # De unstable (estable, testeado)
    git
    python3
  ] ++ [
    pkgsMaster.claude-code    # De master (bleeding edge)
    pkgsMaster.jetbrains-toolbox
  ];
}
#+END_SRC

** Cuando Usar Cada Uno

| Fuente      | Usar para                              | Riesgo      |
|-------------+----------------------------------------+-------------|
| =pkgs=      | 99% de paquetes, uso normal            | Bajo        |
| =pkgsMaster= | Paquetes que necesitas YA (nuevos)     | Medio-alto  |

*Nota:* =pkgsMaster= puede tener paquetes rotos ya que no han pasado todos los tests.
Usalo solo cuando realmente necesites la ultima version.

** Actualizar Independientemente

#+BEGIN_SRC bash
# Actualizar solo master (para paquetes nuevos)
nix flake lock --update-input nixpkgs-master ~/dotfiles

# Actualizar solo unstable (actualizacion normal)
nix flake lock --update-input nixpkgs ~/dotfiles

# Actualizar todo
nix flake update ~/dotfiles
#+END_SRC

* NixOS MacBook Pro 13,2 (2016)

** Hardware Status

| Componente         | Estado | Notas                                          |
|--------------------+--------+------------------------------------------------|
| Audio (CS8409)     | OK     | Driver snd-hda-macbookpro (davidjo)            |
| WiFi (BCM43602)    | NO     | Driver wl abandonado 2019, usar USB dongle     |
| Touch Bar (T1)     | NO     | Chip T1 en recovery mode, workaround con keyd  |
| Webcam FaceTime HD | NO     | Conectada via T1, requiere reset del T1        |
| Teclado/Trackpad   | OK     | Drivers applespi + keyd (fix ISO swap)         |
| Pantalla HiDPI     | OK     | 168 DPI, scaling 2x en GNOME                   |
| Bateria            | OK     | ACPI estandar                                  |
| F-keys (Fn+numero) | OK     | keyd: Fn+1=F1, Fn+=Esc, etc.                   |

** Audio CS8409 - Solucion

El MacBook Pro 2016 usa un chip Cirrus Logic CS8409 como bridge HDA.
El driver del kernel solo soporta Dell (subsystem IDs diferentes).

*Solucion implementada:*
- Modulo custom =snd-hda-macbookpro= compilado desde [[https://github.com/davidjo/snd_hda_macbookpro][davidjo/snd_hda_macbookpro]]
- Parchea el driver del kernel para anadir soporte Apple (GPIO init)
- Config en =nixos-macbook/etc/nixos/modules/snd-hda-macbookpro.nix=

*Verificar funcionamiento:*
#+BEGIN_SRC bash
# Diagnostico completo
audio-diag

# GPIO debe mostrar enable=1 para IO[0-3]
cat /proc/asound/card0/codec#0 | grep -A 10 "^GPIO:"

# Test altavoces
speaker-test -c 2 -t wav
#+END_SRC

** WiFi BCM43602 - Sin solucion

El chip Broadcom BCM43602 interno requiere el driver =wl= (broadcom-sta).

*Estado del driver:*
- El modulo *compila* correctamente (mantenido por RPMFusion/Debian)
- Pero *falla en runtime* con kernel 6.x: =wl driver failed with code 1=
- Error: =NULL ndev->ieee80211ptr, unable to deref wl=
- Causa: APIs internas del kernel incompatibles con el driver propietario

*Conclusion:* El driver esta muerto a nivel funcional, no solo de mantenimiento.
No hay solucion posible sin que Broadcom libere codigo o alguien haga ingenieria inversa.

*Alternativa funcional:* USB WiFi dongle con chip Realtek (RTL8xxxu)
- Ejemplo: TP-Link TL-WN725N o similar
- Funciona out-of-the-box con driver =rtl8xxxu= del kernel

** Touch Bar T1 - Sin solucion

El chip T1 (Touch Bar + Touch ID + *FaceTime HD Camera*) esta en "Recovery Mode" permanente.

*Dispositivos conectados al T1:*
- Touch Bar (OLED strip)
- Touch ID (sensor huella)
- FaceTime HD Camera (720p)
- Ambient Light Sensor

*Problema:*
- El T1 aparece como =05ac:1281= (DFU/Recovery) en lugar de =05ac:8600= (iBridge)
- El firmware esta corrupto o nunca fue inicializado
- Los drivers Linux (apple-ibridge, tiny-dfr, facetimehd) requieren el T1 en modo normal
- Sin T1 funcional, la camara no es visible para el sistema (no hay =/dev/video*=)

*Unica solucion:*
- Conectar a un Mac con macOS
- Usar Apple Configurator 2 para restaurar el firmware del T1
- Sin acceso a macOS = sin Touch Bar

*Workaround con keyd:*
- =Fn + = (tecla junto al 1) = Escape
- =Fn + 1-0= = F1-F10
- =Fn + -= = F11, =Fn + == = F12
- =Fn + Backspace= = Delete
- =Fn + Flechas= = Home/End/PageUp/PageDown

Configurado en =services.keyd= en configuration.nix.

** Teclado Spanish ISO - Fix teclas swapeadas

El teclado Apple SPI tiene las teclas = a= y =< >= intercambiadas respecto al layout fisico.

*Solucion:* keyd remapea las teclas a nivel kernel:
#+BEGIN_SRC nix
"grave" = "102nd";  # Swap tecla junto al 1
"102nd" = "grave";  # Swap tecla entre Shift y Z
#+END_SRC

Esto funciona tanto en X11 (XMonad) como en Wayland (GNOME) porque keyd opera a nivel evdev.

** Perifericos de Input

*** Teclados HHKB

- *HHKB original*: Hasu controller (QMK) - layout programado en hardware
- *HHKB Hybrid*: BT + USB-C, Topre switches

FilosofÃ­a: *el hardware manda, no el software*. Config en memoria del teclado.

*** RatÃ³n: Logitech G Pro X Superlight 2

| ConexiÃ³n | Device ID | Nombre |
|----------+-----------+--------|
| Lightspeed (receptor USB) | =046d:c54d= | Logitech USB Receiver |
| Cable USB | =046d:c09b= | Logitech PRO X 2 |
| Bluetooth | - | No probado |

*Estado soporte Linux (2026-01):*
- =libratbag= / =piper=: NO soportado
- =solaar=: NO soportado
- El ratÃ³n es muy nuevo para las herramientas open source

*Configurar DPI:*
1. Conectar a Windows (VM o dual boot)
2. Instalar Logitech G Hub
3. Configurar DPI y guardar en *onboard memory*
4. El DPI persiste en Linux (guardado en el ratÃ³n)

*Config libinput* (ya aplicada):
#+BEGIN_SRC nix
# AceleraciÃ³n plana (raw input) - ideal para gaming
services.libinput.mouse.accelProfile = "flat";
#+END_SRC

** Solucion: xmobar y fuentes HiDPI

*Estado:* RESUELTO

El problema era usar sintaxis *Xft* (=xft:Font:size=X=) que no escala bien en HiDPI.

*Solucion:* Usar sintaxis *Pango* que SI respeta el DPI del sistema:

#+BEGIN_SRC haskell
-- ANTES (Xft - NO funciona en HiDPI):
font = "xft:Monoid Nerd Font:size=16:bold"

-- DESPUES (Pango - funciona perfectamente):
font = "HeavyData Nerd Font 16"
#+END_SRC

El modulo =modules/home-manager/programs/xmobar.nix= usa Pango y calcula
automaticamente la altura de la barra segun el =fontSize=:

#+BEGIN_SRC nix
# En machines/macbook.nix
dotfiles.xmobar = {
  fontSize = 22;  # Pango escala con DPI automaticamente
};
#+END_SRC

La formula: =TopH = fontSize * 1.8= ajusta la altura de barra proporcionalmente.

** Consola TTY: Temas y Fuentes (2026-01-20)

*Estado:* FUNCIONAL con workaround

*** El problema

El EFI de Apple reporta resolucion incorrecta (3360x2100 en vez de 2560x1600).
Esto causa que el texto en TTY se salga de pantalla.

*Workaround:* =stty cols 160 rows 50= en fish login (automatico).

*** console-theme: Cambio de temas en caliente

Comando para cambiar colores de la consola TTY en caliente:

#+BEGIN_SRC bash
console-theme dark            # Spacemacs Dark (default)
console-theme light           # Spacemacs Light
console-theme commodore       # Fosforo verde CRT retro
console-theme mix             # Synthwave neon
console-theme amber           # CRT ambar retro
console-theme solarized-dark  # Solarized Dark
console-theme solarized-light # Solarized Light
console-theme list            # Ver todos
#+END_SRC

*Nota:* Solo funciona en TTY real (Ctrl+Alt+F1-F6), no en terminales graficos.
Para Alacritty usar =alacritty-theme=.

*** Fuentes de consola disponibles

Fuente actual: *Terminus* (ter-v32n) - LA clasica para programar.

*Terminus* (recomendada):
| Nombre | Tamano | Uso |
|--------+--------+-----|
| ter-v16n | 8x16 | Muchas lineas, puede ser pequena |
| ter-v24n | 12x24 | Balance |
| ter-v32n | 16x32 | HiDPI (actual) |
| ter-v32b | 16x32 | Bold |

*Spleen* (retro):
| Nombre | Tamano | Uso |
|--------+--------+-----|
| spleen-8x16 | 8x16 | Pequena |
| spleen-16x32 | 16x32 | HiDPI |
| spleen-32x64 | 32x64 | ENORME |

Cambiar fuente en =hardware/apple/macbook-pro-13-2.nix=:
#+BEGIN_SRC nix
console.font = lib.mkForce "ter-v32n";
console.packages = lib.mkForce [ pkgs.terminus_font ];
#+END_SRC

** Display Managers: La saga GDM -> LightDM -> greetd -> SDDM (RESUELTO 2026-01-24)

*Estado:* COMPLETO - X11 (XMonad) Y Wayland (Hyprland, niri) funcionan

*** Historia del problema

*Era 1: GDM (2026-01-19)*
Intentamos usar GDM + GNOME + XMonad como stack unificado.
*Ambas maquinas (aurin y macbook) dejaron de arrancar graficamente.*

GDM 49+ tiene problemas con:
1. *NVIDIA*: GDM en modo X11 busca =gnome-session-x11@gnome-login.target= que no existe
2. *XMonad puro*: GDM espera una sesion GNOME completa, no solo un WM

*Era 2: LightDM (2026-01-19)*
Cambiamos a LightDM. XMonad funcionaba, PERO:
- LightDM solo lee =xsessions/= (X11)
- Ignora completamente =wayland-sessions/=
- Hyprland, niri, GNOME Wayland NO aparecian

*Era 3: greetd + tuigreet (2026-01-24) - FALLIDO*
Intentamos greetd con tuigreet (TUI greeter), pero:
- X11 roto: Xorg sin suid necesita logind para permisos de input
- Sesiones Wayland funcionaban pero X11 (XMonad) no arrancaba
- Demasiado complejo configurar correctamente

*Era 4: SDDM (2026-01-24)*
Solucion definitiva: SDDM con tema astronaut.

*** Solucion actual: SDDM

Configurado en =modules/base/sddm.nix=:

#+BEGIN_SRC nix
services.displayManager.sddm = {
  enable = true;
  wayland.enable = false;  # GREETER en X11 (kwin_wayland crashea con NVIDIA)
  theme = "sddm-astronaut-theme";
  extraPackages = [ pkgs.sddm-astronaut ];
};
#+END_SRC

*IMPORTANTE*: =wayland.enable= controla el GREETER (pantalla de login), NO las sesiones.
El greeter usa kwin_wayland que crashea con NVIDIA. Con =false= usa X11 para el greeter
pero puedes seguir eligiendo sesiones Wayland (Hyprland, niri) sin problema.

*** Por que SDDM

| Caracteristica | GDM | LightDM | greetd | SDDM |
|----------------+-----+---------+--------+------|
| X11 sessions | Si (roto NVIDIA) | Si | Roto (suid) | Si |
| Wayland sessions | Si | NO | Si | Si |
| Dependencias | Pesadas (GNOME) | Medias | Minimas | Medias (Qt) |
| NVIDIA compatible | Problematico | Si | Parcial | Si |
| Configuracion | Compleja | Media | Compleja | Simple |

*** NVIDIA + Wayland: Que funciona y que NO (2026-01-25)

| Compositor/DE   | X11 | Wayland | Notas                                    |
|-----------------+-----+---------+------------------------------------------|
| XMonad          | OK  | N/A     | Solo X11                                 |
| Plasma (KDE)    | OK  | NO      | kwin_wayland crashea con NVIDIA          |
| GNOME           | OK  | NO      | Mutter tiene problemas con drivers open  |
| Hyprland        | N/A | OK      | DiseÃ±ado con soporte NVIDIA desde inicio |
| niri            | N/A | OK      | DiseÃ±ado con soporte NVIDIA desde inicio |

*SOLUCION PRACTICA*:
- Plasma/GNOME â†’ usar sesiones X11 (funcionan perfecto)
- Wayland â†’ usar Hyprland o niri (funcionan perfecto)

Los problemas de kwin y Mutter con NVIDIA son bugs upstream, no de NixOS.
El soporte NVIDIA en Wayland sigue mejorando - esto puede cambiar en el futuro.

*** Estado actual de las maquinas

| Maquina | DM | Sesiones probadas | Estado |
|---------+----+-------------------+--------|
| aurin   | SDDM | XMonad OK, Plasma X11 OK, Hyprland OK | Probado 2026-01-25 |
| macbook | SDDM | XMonad, GNOME, KDE, Hyprland, niri | OK (Intel, sin NVIDIA) |
| vespino | SDDM | XMonad, Hyprland | Pendiente test |

*** Variables de entorno NVIDIA

Las variables para Wayland van en =hardware/nvidia/*.nix=:

#+BEGIN_SRC nix
environment.sessionVariables = {
  LIBVA_DRIVER_NAME = "nvidia";
  __GLX_VENDOR_LIBRARY_NAME = "nvidia";
  # Para wlroots (Hyprland, etc):
  WLR_NO_HARDWARE_CURSORS = "1";  # Si hay problemas con el cursor
};
#+END_SRC

Estas variables se aplican DESPUES del login (sesion), no en SDDM (pre-login)

*** Picom: por que no esta en desktop.nix

Picom NO se habilita en =modules/base/desktop.nix= porque conflictua con Mutter (GNOME).

*Solucion implementada:*
1. Picom se configura en home-manager (=modules/home-manager/programs/picom.nix=)
2. =xmonad.hs= lo lanza en =startupHook: spawnOnce "picom"=
3. Cuando usas GNOME, picom NO corre (Mutter hace de compositor)
4. Cuando usas XMonad, picom SI corre

*** Comandos utiles para debugging

#+BEGIN_SRC bash
# Ver que Display Manager esta activo
systemctl status display-manager

# Ver sesiones disponibles
ls /usr/share/xsessions/
ls /usr/share/wayland-sessions/

# Ver variables de sesion
echo $XDG_SESSION_TYPE
echo $XDG_CURRENT_DESKTOP

# Ver si picom esta corriendo
pgrep -a picom

# Ver compositor activo
echo $WAYLAND_DISPLAY  # Si tiene valor, estas en Wayland
#+END_SRC

* CPU Frequency Scaling: Por que tu CPU no siempre va a tope

Imagina que tu coche tuviera solo dos opciones: 0 km/h o 200 km/h. Seria un
desastre: consumiria gasolina como loco y el motor se fundiria. Por eso los
coches tienen marchas. Tu CPU funciona igual.

** El problema: rendimiento vs consumo vs temperatura

Tu procesador puede funcionar a diferentes frecuencias:
- *Frecuencia alta* = mas rendimiento, pero mas calor y consumo
- *Frecuencia baja* = menos rendimiento, pero silencioso y eficiente

La pregunta es: *quien decide cuando subir o bajar?*

En Linux, esto se llama *CPU Frequency Scaling*, y hay dos partes:
1. *Driver*: el que sabe COMO cambiar la frecuencia (habla con el hardware)
2. *Governor*: el que decide CUANDO cambiarla (la politica)

** Los drivers: cada CPU habla su idioma

| Driver        | Para que CPUs                      | Notas                                   |
|---------------+------------------------------------+-----------------------------------------|
| intel_pstate  | Intel modernos (2013+)             | El kernel lo carga solo, muy eficiente  |
| amd-pstate    | AMD Ryzen (Zen 2+)                 | Igual que intel_pstate pero para AMD    |
| acpi-cpufreq  | CPUs antiguos o servidores         | Generico, funciona casi siempre         |

*El problema:* No todos los CPUs cargan su driver automaticamente.

- Los Intel de escritorio/laptop modernos: =intel_pstate= se carga solo
- Los AMD Ryzen modernos: =amd-pstate= se carga solo
- Los Xeon servidor y AMD FX antiguos: necesitan =acpi-cpufreq= manualmente

Por eso en este repo, =modules/common/boot.nix= carga =acpi-cpufreq= para todos.
Si tu CPU ya usa otro driver, simplemente se ignora.

** Los governors: quien manda aqui?

| Governor     | Que hace                                        | Cuando usarlo               |
|--------------+-------------------------------------------------+-----------------------------|
| performance  | Siempre al maximo                               | Compilando, gaming, benchs  |
| powersave    | Siempre al minimo                               | Bateria, silencio total     |
| schedutil    | El kernel decide segun carga (inteligente)      | Uso normal (recomendado)    |
| ondemand     | Sube rapido con carga, baja lento               | Alternativa a schedutil     |
| conservative | Sube/baja gradualmente                          | Servidores, estabilidad     |

*Ojo:* =intel_pstate= solo permite =performance= y =powersave=. El resto de
governors solo funcionan con =acpi-cpufreq=.

** Como esta configurado en cada maquina

*** Aurin - La bestia de 72 hilos

Aurin tiene dos Xeon E5-2699v3, que son CPUs de *servidor*. Curiosidad: aunque
son Intel, el kernel NO carga =intel_pstate= automaticamente para Xeons.
Por que? Porque en servidores se prefiere el control fino de =acpi-cpufreq=.

#+BEGIN_SRC bash
# En aurin veras esto:
$ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver
acpi-cpufreq

$ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
conservative ondemand userspace powersave performance schedutil
#+END_SRC

Con 72 hilos y =schedutil=, el sistema sube/baja la frecuencia de cada core
independientemente. Muy eficiente para workloads variados.

*** Vespino - El veterano AMD FX

Vespino tiene un AMD FX-8350, un procesador de 2012 (arquitectura Bulldozer).
Estos CPUs son anteriores a =amd-pstate=, asi que usan =acpi-cpufreq=.

Antes de anadir el modulo en =boot.nix=, vespino no tenia *ningun* driver de
frecuencia cargado. El resultado? El script de xmobar mostraba "?.?" porque
no encontraba =/sys/devices/system/cpu/cpu0/cpufreq/=.

Ahora con =acpi-cpufreq= cargado, tiene todos los governors disponibles.

*** MacBook - El unico con intel_pstate

El MacBook Pro tiene un Intel Skylake, y este SI carga =intel_pstate= solo.
La diferencia es que solo tiene dos governors: =performance= y =powersave=.

#+BEGIN_SRC bash
# En macbook veras esto:
$ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver
intel_pstate

$ cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors
performance powersave
# Solo dos! No hay schedutil ni ondemand
#+END_SRC

Por defecto usa =powersave= (es un laptop, prioriza bateria).

** La configuracion en NixOS

Todo esto se configura en dos archivos:

*** 1. Cargar el driver (modules/common/boot.nix)

#+BEGIN_SRC nix
# Una linea que soluciona el problema para CPUs antiguos
boot.kernelModules = [ "acpi-cpufreq" ];
#+END_SRC

Si tu CPU ya usa =intel_pstate= o =amd-pstate=, esta linea no hace nada
(los drivers nativos tienen prioridad). Solo ayuda a los que lo necesitan.

*** 2. GUI para cambiar governor (modules/common/cpupower-gui.nix)

=cpupower-gui= es una app grafica para cambiar el governor sin terminal.
El modulo configura:
- El paquete
- Polkit para no pedir password (si estas en grupo wheel)
- El servicio D-Bus necesario

** Uso diario: el monitor en xmobar

En xmobar veras algo como: =2.3GHz auto=

| Color  | Governor        | Significado                    |
|--------+-----------------+--------------------------------|
| Rojo   | performance     | Al maximo, cuidado con el calor |
| Verde  | powersave       | Ahorrando energia               |
| Cyan   | schedutil/auto  | El kernel decide (normal)       |
| Gris   | none            | Sin cpufreq (fallback a /proc)  |

*Click en el monitor* abre =cpupower-gui= para cambiar el governor.

** Comandos utiles

#+BEGIN_SRC bash
# Ver que tienes
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_driver
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

# Cambiar governor (temporal, hasta reboot)
sudo cpupower frequency-set -g performance   # Al maximo
sudo cpupower frequency-set -g powersave     # Al minimo
sudo cpupower frequency-set -g schedutil     # Automatico

# O simplemente abre la GUI
cpupower-gui
#+END_SRC

** Bonus: ver consumo en watts (RAPL)

Solo CPUs Intel pueden reportar consumo real en watts via RAPL.

#+BEGIN_SRC nix
# En configuration.nix - dar acceso a RAPL sin root
services.udev.extraRules = ''
  SUBSYSTEM=="powercap", ACTION=="add", RUN+="${pkgs.coreutils}/bin/chmod g+r /sys/class/powercap/intel-rapl/intel-rapl:*/energy_uj"
  SUBSYSTEM=="powercap", ACTION=="add", RUN+="${pkgs.coreutils}/bin/chgrp wheel /sys/class/powercap/intel-rapl/intel-rapl:*/energy_uj"
'';
#+END_SRC

Solo disponible en CPUs Intel (Aurin y MacBook). El script =xmobar-cpu.sh= muestra
watts si RAPL esta disponible.

* Doom Emacs: Tree-Sitter y Syntax Highlighting en NixOS

** Que es Tree-Sitter

Tree-sitter es un sistema de parseo incremental que genera arboles de sintaxis abstracta (AST)
para codigo fuente. A diferencia del syntax highlighting tradicional basado en expresiones
regulares, tree-sitter:

- *Parsea el codigo completo* como lo haria un compilador
- *Es incremental*: solo reparsea las partes que cambian
- *Entiende la estructura* del codigo, no solo patrones de texto
- *Es mas rapido* para archivos grandes
- *Proporciona highlighting mas preciso* (distingue variables locales de globales, etc.)

** Tree-sitter en Emacs

Emacs 29+ incluye soporte nativo para tree-sitter (=treesit=), pero necesita *grammars compilados*
para cada lenguaje. Estos grammars son bibliotecas dinamicas (.so en Linux, .dylib en macOS).

*** El Problema en NixOS

Cuando Doom Emacs intenta usar tree-sitter, necesita compilar los grammars si no existen.
Esto falla o se congela en NixOS porque:

1. El compilador de C (gcc/clang) puede no estar en el PATH de Emacs
2. Las rutas de bibliotecas del sistema son diferentes en NixOS
3. El sandbox de Nix complica la compilacion dinamica

** Opciones Disponibles

*** Opcion 1: Deshabilitar Tree-sitter (Recomendado)

Si el syntax highlighting tradicional es suficiente, simplemente quita los flags =+tree-sitter=.

*En =~/.config/doom/init.el=:*

#+BEGIN_SRC emacs-lisp
;; ANTES (con tree-sitter)
:tools
tree-sitter

:lang
(nix +lsp +tree-sitter)
(php +lsp +tree-sitter)

;; DESPUES (sin tree-sitter)
:tools
;;tree-sitter  ; Comentado o eliminado

:lang
(nix +lsp)
(php +lsp)
#+END_SRC

*Aplicar cambios:*
#+BEGIN_SRC bash
~/.config/emacs/bin/doom sync
# Reiniciar Emacs
#+END_SRC

*Pros:* Sin configuracion adicional, funciona inmediatamente, LSP ya proporciona el 90% de los beneficios.

*** Opcion 2: Instalar Grammars via NixOS

NixOS puede preinstalar los grammars compilados. En =modules/home-manager/passh.nix=:

#+BEGIN_SRC nix
home.packages = with pkgs; [
  tree-sitter-grammars.tree-sitter-nix
  tree-sitter-grammars.tree-sitter-javascript
  tree-sitter-grammars.tree-sitter-php
  tree-sitter-grammars.tree-sitter-json
  tree-sitter-grammars.tree-sitter-html
  tree-sitter-grammars.tree-sitter-bash
];
#+END_SRC

Y en =~/.config/doom/config.el=:

#+BEGIN_SRC emacs-lisp
(when (and (fboundp 'treesit-available-p) (treesit-available-p))
  (setq treesit-extra-load-path
        (list (expand-file-name "~/.nix-profile/lib/tree-sitter")
              "/run/current-system/sw/lib/tree-sitter")))
#+END_SRC

** Verificar Estado

#+BEGIN_SRC emacs-lisp
;; M-x eval-expression RET
(treesit-available-p)              ; Deberia retornar t
(treesit-language-available-p 'nix) ; Ver si grammar de nix esta
#+END_SRC

*Modo activo:* Sin tree-sitter usa =nix-mode=, con tree-sitter usa =nix-ts-mode= (sufijo =-ts-=).

** Grammars Disponibles

#+BEGIN_SRC bash
nix search nixpkgs tree-sitter-grammars
#+END_SRC

| Lenguaje   | Paquete Nix                                 |
|------------+---------------------------------------------|
| Nix        | tree-sitter-grammars.tree-sitter-nix        |
| JavaScript | tree-sitter-grammars.tree-sitter-javascript |
| PHP        | tree-sitter-grammars.tree-sitter-php        |
| JSON       | tree-sitter-grammars.tree-sitter-json       |
| HTML       | tree-sitter-grammars.tree-sitter-html       |
| Bash       | tree-sitter-grammars.tree-sitter-bash       |

* Hosts Privados de Trabajo

** El Problema

Para desarrollo necesitamos hosts internos (staging, dev, etc.) que no pueden
estar en un repo publico. El archivo esta en un repo de trabajo externo.

** Por que requiere --impure

En NixOS Flakes, =builtins.pathExists= para paths externos al flake SIEMPRE
devuelve =false= en evaluacion pura. Por eso usamos =--impure=.

** Solucion Actual

#+BEGIN_SRC bash
# Aurin (con hosts de trabajo)
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# Macbook (requiere clonar repo de trabajo primero)
git clone <work-repo> ~/src/work/work-env
sudo nixos-rebuild switch --flake ~/dotfiles#macbook --impure
#+END_SRC

** Opciones Futuras (cuando haga falta)

| Opcion | Puro? | Complejidad | Notas |
|--------|-------|-------------|-------|
| =--impure= (actual) | No | Baja | Simple, funciona |
| sops-nix | Si | Media | Encripta secretos en repo |
| Repo privado input | Si | Media | Flake input con SSH |

Para implementar sops-nix: [[https://github.com/Mic92/sops-nix][sops-nix GitHub]]

* Roadmap: Migracion Stow -> Home Manager

** Contexto

Con la adopcion de NixOS Flakes para multiples maquinas (aurin, macbook), GNU Stow
se vuelve redundante. Home Manager integrado con el flake ofrece:

- *Configs per-machine declarativas* (ej: xmobar con diferentes DPI/fonts)
- *Un solo comando* =nixos-rebuild switch= aplica sistema + usuario
- *Reproducibilidad total* - Todo versionado en el flake
- *Rollback automatico* - Generaciones anteriores disponibles

** Estado Actual (Anti-pattern)

En =modules/home-manager/passh.nix= linea ~253 hay un hack que usa stow dentro de home-manager:

#+BEGIN_SRC nix
activation.linkDotfiles = lib.hm.dag.entryBefore [ "checkLinkTargets" ] ''
  ${pkgs.stow}/bin/stow -v -R -t ${config.home.homeDirectory} \
    alacritty composer fish picom xmobar xmonad claude-code
'';
#+END_SRC

Esto debe eliminarse gradualmente migrando cada config a home-manager nativo.

** Arquitectura Propuesta

#+BEGIN_SRC text
modules/home-manager/
|-- default.nix           # Entry point, recibe hostname
|-- common.nix            # Configs compartidas (paquetes base)
|-- programs/
|   |-- xmobar.nix        # Xmobar con opciones parametrizables
|   |-- xmonad.nix        # XMonad config
|   |-- alacritty.nix     # Terminal
|   `-- fish.nix          # Shell (usa programs.fish nativo)
`-- machines/
    |-- aurin.nix         # fontSize=14, dpi=96, nvidia, interfaces de red
    `-- macbook.nix       # fontSize=22, dpi=168, intel, HiDPI
#+END_SRC

** Pasar hostname al flake

En =flake.nix=, funcion =mkNixosConfig=:

#+BEGIN_SRC nix
home-manager.extraSpecialArgs = {
  inherit inputs;
  hostname = hostname;  # Anadir esto
};
#+END_SRC

** Patron para configs per-machine

#+BEGIN_SRC nix
# modules/home-manager/programs/xmobar.nix
{ config, lib, ... }:

let cfg = config.custom.xmobar;
in {
  options.custom.xmobar = {
    fontSize = lib.mkOption {
      type = lib.types.int;
      default = 14;
    };
    dpi = lib.mkOption {
      type = lib.types.int;
      default = 96;
    };
  };

  config.home.file.".config/xmobar/xmobarrc".text = ''
    Config { font = "xft:Monoid Nerd Font:size=${toString cfg.fontSize}"
           , ...
    }
  '';
}
#+END_SRC

Luego en cada maquina:

#+BEGIN_SRC nix
# machines/macbook.nix
{ ... }: {
  custom.xmobar.fontSize = 22;
  custom.xmobar.dpi = 168;
}

# machines/aurin.nix
{ ... }: {
  custom.xmobar.fontSize = 14;
  # dpi usa default 96
}
#+END_SRC

** Orden de Migracion Recomendado

1. [X] *xmobar* - COMPLETADO (2026-01-04)
   - Modulo parametrizable en =modules/home-manager/programs/xmobar.nix=
   - Configs per-machine en =modules/home-manager/machines/{aurin,macbook}.nix=
   - Opciones: fontSize, gpuType, networkInterface, wifiInterface, showBattery, showTrayer, alsaMixer

2. [X] *alacritty* - COMPLETADO (2026-01-04)
   - Modulo en =modules/home-manager/programs/alacritty.nix=
   - Usa =programs.alacritty= nativo de home-manager
   - Opciones: fontSize (14 aurin, 18 macbook), theme (dark/light)
   - Tema Spacemacs inline

3. [X] *picom* - COMPLETADO (2026-01-04)
   - Modulo en =modules/home-manager/programs/picom.nix=
   - Opcion: backend (egl para NVIDIA, xrender para Intel)
   - Config completa inline (shadows, blur, animations)

4. [X] *fish* - COMPLETADO (2026-01-04)
   - Modulo en =modules/home-manager/programs/fish.nix=
   - Usa =programs.fish= nativo de home-manager
   - Aliases: git shortcuts, eza/ls, nixos helpers
   - Abbreviations: docker, nix

5. [ ] *xmonad* - Pendiente (config Haskell compleja)
   - Actualmente gestionado via stow
   - Requiere analisis de como parametrizar Haskell

6. [ ] *composer* - Pendiente (bajo riesgo, simple)
   - PHP tool, config estatico
   - Baja prioridad

7. [X] Reducir bloque =activation.linkDotfiles= - PARCIALMENTE
   - Solo quedan: xmonad, composer, claude-code
   - Documentado estado en passh.nix lineas 255-276

8. [ ] Eliminar carpetas stow vacias (cuando todo migre)

** Referencias

- [[https://nix-community.github.io/home-manager/][Home Manager Manual]]
- [[https://nixos.wiki/wiki/Flakes][NixOS Flakes Wiki]]

* Estructura Recomendada para Nuevas Configs

Al anadir nueva configuracion:

#+BEGIN_SRC text
dotfiles/
`-- nueva-app/
    `-- .config/
        `-- nueva-app/
            `-- config.conf
#+END_SRC

Luego:
#+BEGIN_SRC bash
stow nueva-app
#+END_SRC

Esto crea: =~/.config/nueva-app/config.conf= -> =~/dotfiles/nueva-app/.config/nueva-app/config.conf=

* GestiÃ³n Segura de Secretos con SOPS-NIX ğŸ”

** Â¿QuÃ© es SOPS?

SOPS (Secrets OPerationS) es una herramienta de Mozilla para encriptar archivos de configuraciÃ³n.
- Encripta *solo los valores*, no las claves (puedes ver quÃ© secretos tienes, pero no su contenido)
- Usa age o GPG para encriptaciÃ³n
- IntegraciÃ³n nativa con NixOS via =sops-nix=

** El Problema Actual

Actualmente tenemos passwords hardcodeadas en texto plano en archivos que van a GitHub:

#+BEGIN_EXAMPLE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hosts/aurin/default.nix (PÃšBLICO)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ services.miniflux = {                   â”‚
â”‚   adminCredentialsFile = {              â”‚
â”‚     password = "MiPassword123";  â† ğŸ”¥ VISIBLEâ”‚
â”‚   };                                    â”‚
â”‚ };                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€â”€â”€ git push
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   GitHub     â”‚  â† TODO EL MUNDO PUEDE VER
          â”‚  (PÃšBLICO)   â”‚     tu password
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_EXAMPLE

*Secretos actualmente expuestos en este repo:*
- Passwords de servicios (Miniflux, Syncthing, VM Ubuntu)
- Email corporativo
- Paths a archivos externos (hosts Vocento)
- IPs y redes internas

** La SoluciÃ³n: SOPS-NIX

#+BEGIN_EXAMPLE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ secrets.yaml (ENCRIPTADO con tu clave age/GPG)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ miniflux_password: ENC[AES256_GCM,data:Qw==,...] â”‚ â† Encriptado
â”‚ router_password: ENC[AES256_GCM,data:Ab==,...]   â”‚
â”‚ syncthing_key: ENC[AES256_GCM,data:Xy==,...]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€â”€â”€ git push (SEGURO!)
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   GitHub     â”‚  â† Solo ve texto encriptado
          â”‚  (PÃšBLICO)   â”‚     Nadie puede leerlo
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EN TU MÃQUINA (cuando haces nixos-rebuild):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. sops-nix detecta secrets.yaml        â”‚
â”‚ 2. Desencripta con TU clave privada     â”‚
â”‚ 3. Crea archivos en /run/secrets/       â”‚
â”‚    (solo root puede leer)               â”‚
â”‚ 4. NixOS usa esos archivos              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_EXAMPLE

** Â¿CÃ³mo Funciona? (Paso a Paso)

*** 1. Generar Clave Age

#+BEGIN_SRC bash
# Instalar age
nix-shell -p age

# Generar clave
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt

# Output:
# Public key: age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
#             â””â”€ Guarda esta clave pÃºblica
#+END_SRC

*** 2. Crear Archivo de Secretos (Sin Encriptar TodavÃ­a)

#+BEGIN_SRC yaml
# secrets.yaml (TEMPORAL - lo encriptarÃ¡s en el paso 4)
miniflux_password: SuperSecretPass123
router_password: OtraPasswordSegura456
syncthing_api_key: abc123def456ghi789
vm_ubuntu_password: MiPasswordVM2024
#+END_SRC

*** 3. Configurar .sops.yaml

#+BEGIN_SRC yaml
# .sops.yaml - Define quÃ© clave usar
keys:
  - &passh age1ql3z7hjy54pw3hyww5ayyfg7zqgvc7w3j2elw8zmrj2kg5sfn9aqmcac8p
    # â””â”€ TU clave pÃºblica del paso 1
creation_rules:
  - path_regex: secrets\.yaml$
    key_groups:
      - age:
          - *passh
#+END_SRC

*** 4. Encriptar el Archivo

#+BEGIN_SRC bash
nix-shell -p sops
sops secrets.yaml  # Se abre editor, guardas, y queda encriptado

# Ahora secrets.yaml tiene:
# miniflux_password: ENC[AES256_GCM,data:Qw==,iv:...,tag:...,type:str]
#+END_SRC

*** 5. Usar los Secretos en NixOS

#+BEGIN_SRC nix
# flake.nix - AÃ±adir input
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    sops-nix.url = "github:Mic92/sops-nix";
  };
  
  outputs = { nixpkgs, sops-nix, ... }: {
    nixosConfigurations.aurin = nixpkgs.lib.nixosSystem {
      modules = [
        sops-nix.nixosModules.sops
        ./hosts/aurin
      ];
    };
  };
}

# hosts/aurin/default.nix
{
  sops = {
    defaultSopsFile = ../../secrets.yaml;
    age.keyFile = "/home/passh/.config/sops/age/keys.txt";
    
    secrets = {
      miniflux_password = {};  # Crea /run/secrets/miniflux_password
      router_password = {};
    };
  };
  
  # Usar el secreto
  services.miniflux = {
    adminCredentialsFile = {
      passwordFile = config.sops.secrets.miniflux_password.path;
      # â””â”€ Apunta a /run/secrets/miniflux_password (solo root)
    };
  };
}
#+END_SRC

** Diagrama Completo del Flujo

#+BEGIN_EXAMPLE
TU MÃQUINA                        GITHUB (PÃšBLICO)
===========                       ================

1. EDITAR SECRETOS
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ sops secrets â”‚               
   â”‚   .yaml      â”‚â”€â”€â”            
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Desencripta con tu clave
                     â”‚ Abre editor
                     â”‚ Editas password123 â†’ nueva_pass
                     â”‚ Guardas â†’ Re-encripta
                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ secrets.yaml (ENCRIPTADO)     â”‚
   â”‚ password: ENC[AES256...]      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
2. GIT PUSH          â”‚
   git add secrets.yaml
   git push          â”‚
                     â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  GitHub Repo    â”‚
                â”‚  (PÃšBLICO)      â”‚  â† Solo cifrado
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
3. REBUILD EN        â”‚ git pull
   OTRA MÃQUINA      â”‚
                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ nixos-rebuild switch         â”‚
   â”‚   â†“                          â”‚
   â”‚ sops-nix desencripta         â”‚
   â”‚   â†“                          â”‚
   â”‚ Crea /run/secrets/password   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#+END_EXAMPLE

** Ventajas vs Problemas

| Aspecto | SIN sops-nix (AHORA) | CON sops-nix |
|---------+----------------------+--------------|
| Passwords en repo | âŒ Texto plano visible | âœ… Encriptado |
| Git push seguro | âŒ Expones secretos | âœ… Solo cifrado sube |
| Multi-mÃ¡quina | âŒ Cambiar en 3 sitios | âœ… 1 archivo, sync auto |
| RotaciÃ³n passwords | âŒ Editar 10 archivos | âœ… =sops secrets.yaml= |
| Complejidad inicial | âœ… Cero setup | âš ï¸ 30 min setup |
| Mantenimiento | âš ï¸ Buscar/reemplazar | âœ… Centralizado |

** Â¿Es DifÃ­cil?

*NO.* El setup inicial es simple:

| Paso | Tiempo | Dificultad |
|------+--------+------------|
| 1. Generar clave age | 10 segundos | â­ Trivial |
| 2. Crear =.sops.yaml= | 2 minutos | â­ Copy/paste |
| 3. Crear =secrets.yaml= | 5 minutos | â­â­ Listar secretos |
| 4. AÃ±adir sops-nix a flake | 5 minutos | â­â­ 3 lÃ­neas cÃ³digo |
| 5. Migrar passwords | 15 minutos | â­â­â­ Buscar/reemplazar |
| *TOTAL* | *~30 minutos* | *Una sola vez* |

** Plan de ImplementaciÃ³n Propuesto

*** FASE 1: Setup Inicial (Lectura, SIN Cambios)
- [ ] Leer documentaciÃ³n oficial sops-nix
- [ ] Identificar TODOS los secretos en el repo
- [ ] DiseÃ±ar estructura de =secrets.yaml=
- [ ] Decidir: age vs GPG (recomendado: age)

*** FASE 2: ImplementaciÃ³n
- [ ] Generar clave age
- [ ] Crear =.sops.yaml= y =secrets.yaml=
- [ ] AÃ±adir sops-nix al flake.nix
- [ ] Migrar passwords uno por uno:
  - [ ] Miniflux (aurin, vespino)
  - [ ] Syncthing
  - [ ] VM Ubuntu
- [ ] Eliminar passwords hardcoded del cÃ³digo
- [ ] Test en aurin: =sudo nixos-rebuild test --flake .#aurin --impure=
- [ ] Commit & push (secrets.yaml encriptado)

*** FASE 3: Limpieza (Opcional)
- [ ] Git history rewrite (borrar passwords del historial antiguo)
- [ ] Documentar en README cÃ³mo aÃ±adir secretos nuevos
- [ ] Aplicar en macbook y vespino

** Secretos Actualmente en el Repo

Lista de secretos que necesitan migrarse (VALORES SANITIZADOS - no reales):

| Secreto | UbicaciÃ³n | AcciÃ³n |
|---------+-----------+--------|
| VM Ubuntu password | README.org | Migrar a sops |
| Miniflux password (aurin) | hosts/aurin/default.nix | Migrar a sops |
| Miniflux password (vespino) | hosts/vespino/default.nix | Migrar a sops |
| Syncthing password | aurin-system-notes.org | Migrar a sops |
| Router password | CLAUDE.md | âš ï¸ NO en NixOS - cambiar manualmente |
| Email corporativo | modules/home-manager/core.nix | âš ï¸ Considerar si es secreto |
| Vocento hosts file (path) | hosts/*/default.nix | Evaluar si necesita sops |

#+BEGIN_QUOTE
*NOTA IMPORTANTE:* El router NO se gestiona con NixOS, asÃ­ que su password debe cambiarse manualmente en la interfaz web del router.

*ADVERTENCIA:* Los valores mostrados en esta documentaciÃ³n son EJEMPLOS. Los valores reales estÃ¡n hardcodeados en varios archivos del repo y deben migrarse a sops-nix para mayor seguridad.
#+END_QUOTE

** Referencias

- [[https://github.com/Mic92/sops-nix][sops-nix - GitHub]]
- [[https://github.com/mozilla/sops][SOPS - Mozilla]]
- [[https://github.com/FiloSottile/age][age - Encryption Tool]]
- [[https://nixos.wiki/wiki/Sops-nix][NixOS Wiki - sops-nix]]

* TODO Tareas Pendientes

#+BEGIN_QUOTE
*Leyenda:*
- [X] = Completado
- [ ] = Pendiente (activo o futuro)
- *MAYÃšSCULAS* = TÃ­tulo de tarea principal
- Fechas [YYYY-MM-DD] = CuÃ¡ndo se completÃ³
#+END_QUOTE

** Resumen de Estado

| CategorÃ­a | Completadas | Pendientes | Estado |
|-----------+-------------+------------+--------|
| AI Agents | 4/5 (80%) | 1 | âœ… Funcionando (aurin + macbook) |
| XMonad Migration | 3/3 (100%) | 0 | âœ… Completado (aurin + macbook) |
| Repo Template | 2/3 (67%) | 1 | âš ï¸ En progreso |
| Seguridad (SOPS) | 1/2 (50%) | 1 | ğŸ“– Documentado |
| Infraestructura | 0/3 (0%) | 3 | ğŸ”® Futuro |
| Limpieza | 1/3 (33%) | 2 | âš ï¸ En progreso |

#+BEGIN_QUOTE
*Nota:* vespino estÃ¡ esperando =git pull && nixos-rebuild= para aplicar todos los cambios recientes (AI agents modular, XMonad migration, SOPS docs). Â¡Va a flipar! ğŸ˜„
#+END_QUOTE

** AI Agents (claude, opencode, crush)
- [X] *REFACTOR MODULAR* [2026-01-24] - Arquitectura modular para AI agents
  - [X] Crear =modules/home-manager/programs/ai-agents/= directory
  - [X] Separar en archivos: =default.nix=, =claude-code.nix=, =opencode.nix=, =crush.nix=
  - [X] Cada agente en mÃ³dulo independiente (~80-90 lÃ­neas)
  - [X] Escalable: aÃ±adir nuevo agente = crear archivo + 1 import
- [X] *CLAUDE-CODE INTEGRADO* [2026-01-22] - Migrado de stow a home-manager
  - [X] Crear mÃ³dulo =claude-code.nix= (config symlinks)
  - [X] Integrar en =core.nix= (portable)
  - [X] Eliminar claude-code de stow en =passh.nix=
  - [X] Aplicar en aurin (TESTED: =claude --version= v2.1.12)
  - [X] Aplicar en macbook (TESTED: =claude --version= v2.1.12)
  - [ ] Aplicar en vespino (el abandonado - esperando =git pull=)
- [X] *OPENCODE INTEGRADO* [2026-01-24] - No experimental, funcional
  - [X] Crear mÃ³dulo =opencode.nix= (package + config symlinks)
  - [X] Config en =~/dotfiles/opencode/.config/opencode/=
  - [X] Aplicar en aurin (TESTED & WORKING - usado para esta sesiÃ³n!)
  - [X] Aplicar en macbook (TESTED & WORKING)
  - [ ] Aplicar en vespino (esperando =git pull=)
- [X] *CRUSH AÃ‘ADIDO* [2026-01-24] - Desde Charmbracelet NUR
  - [X] Crear mÃ³dulo =crush.nix= con patrÃ³n =fetchGit + callPackage=
  - [X] Instalar desde NUR (no nixpkgs) para version reciente
  - [X] Config remota: Mac usa GPU desktop via =campo.zapto.org:11434=
  - [X] Aplicar en aurin (TESTED: =crush --version= v0.35.0)
  - [X] Aplicar en macbook (TESTED: usa desktop Ollama remotamente)
  - [ ] Aplicar en vespino
- [ ] *SHARED AGENTS* - Config multi-cliente (futuro)
  - [ ] Investigar compatibilidad entre clientes
  - [ ] Considerar shared agents directory si claude/opencode lo soportan

** Infraestructura
- [ ] *VPN VOCENTO EXPERIMENTAL* - Probar modulos en vespino antes de aurin
  - Copiar disco QCOW2 a vespino
  - Configurar =services.vocento-vpn-bridge= con interface correcta
  - Validar que funciona igual que en macbook
- [X] *WAYLAND RESUELTO* - SDDM soporta X11 y Wayland (2026-01-24)
  - Probado en macbook con Hyprland
  - Pendiente: probar en aurin y vespino (NVIDIA)
- [ ] *rEFInd* - Bootloader para fix geometria TTY en MacBook
  - =boot.loader.refind.enable = true=
  - Configurar =resolution 2560 1600= en refind.conf

** Repo como Template (Forkeable)
- [X] *MANIFIESTO HHKB* [2026-01-24] - DocumentaciÃ³n filosÃ³fica
  - [X] Historia personal HHKB (extensiÃ³n de manos â†’ extensiÃ³n de cerebro)
  - [X] Cita exacta Eiiti Wada (cowboys + saddle)
  - [X] Problemas universales (formatear, nuevo portÃ¡til, 3 mÃ¡quinas)
  - [X] Ã‰nfasis: hardware totalmente diferente (Intel MacBook vs Desktop RTX)
  - [X] Legibilidad humana primero, LLM-friendly como bonus
- [X] *SECCIÃ“N BÃSICA AÃ‘ADIDA* [2026-01-22] - "Use This Repo (WIP)"
  - [X] GuÃ­a Quick Start para terceros
  - [X] Checklist de valores hardcoded a cambiar
  - [X] Tabla "What You Get" vs "What's Personal"
  - [X] Warning claro: WIP, requiere adaptaciÃ³n manual
  - [ ] Testing con usuario real (Daniel)
- [ ] *TEMPLATE COMPLETO* (despuÃ©s de stow migraciÃ³n completa)
  - [ ] Parametrizar username (mainUser variable)
  - [ ] Script generator: =./scripts/new-machine.sh=
  - [ ] SeparaciÃ³n clara: personal vs. template
  - [ ] Secrets management (sops-nix o agenix)

** XMonad Migration (Home-Manager)
- [X] *PHASE 1: CLEANUP* [2026-01-23] - Limpieza de xmonad.hs
  - [X] Remover dead keybindings (TTS, keyboard layout)
  - [X] Fix hardcoded paths (picom, jetbrains-toolbox)
  - [X] Mover glmatrix-bg.sh a scripts/
- [X] *PHASE 2: HOME-MANAGER MODULE* [2026-01-23] - MigraciÃ³n a home-manager
  - [X] Crear =modules/home-manager/programs/xmonad.nix=
  - [X] Usar =.source= para hot-reload (10s compile)
  - [X] Absolute paths para scripts (reliability)
  - [X] Aplicar en aurin (TESTED & WORKING)
  - [X] Aplicar en macbook (TESTED & WORKING)
  - [ ] Aplicar en vespino (esperando =git pull=)
- [X] *PHASE 3: REJECTED* [2026-01-23] - Templates consideradas daÃ±inas
  - [X] Intentado: =.text= template (365 lines in Nix)
  - [X] Resultado: Indentation bugs, xmobar broken
  - [X] Revertido: Commit cff214e
  - [X] LecciÃ³n: =.source= > templates (pragmatismo > pureza)
  - [X] Documentado en =XMONAD-MIGRATION-SUMMARY.md=

** Seguridad (SOPS-NIX)
- [X] *DOCUMENTACIÃ“N SOPS-NIX* [2026-01-24] - GuÃ­a completa aÃ±adida
  - [X] Documentar quÃ© es SOPS y por quÃ© usarlo
  - [X] Diagramas de flujo (problema â†’ soluciÃ³n)
  - [X] GuÃ­a paso a paso (5 pasos)
  - [X] Plan de implementaciÃ³n (3 fases)
  - [X] AuditorÃ­a de secretos actuales
- [ ] *IMPLEMENTACIÃ“N SOPS-NIX* (pendiente, cuando convenga)
  - [ ] FASE 1: Setup inicial (generar keys age, .sops.yaml)
  - [ ] FASE 2: Migrar passwords (Miniflux, Syncthing, VM Ubuntu)
  - [ ] FASE 3: Limpieza (git history, docs)

** Limpieza
- [ ] Revisar y limpiar configs obsoletas (shell/, composer/)
- [ ] Documentar scripts utiles en scripts/
- [X] Migrar xmonad a home-manager - DONE (Phase 2)
- [ ] Eliminar stow cuando composer migre (CRÃTICO: composer en PROD Vocento)

* Apps Utiles de GNOME y KDE (para usar en XMonad)

Al tener GNOME y KDE Plasma instalados, tenemos acceso a todas sus aplicaciones
que funcionan perfectamente en XMonad u otros WMs minimalistas.

** Configuracion del Sistema

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| GNOME Settings             | GNOME | =gnome-control-center=     | Config general del sistema            |
| KDE System Settings        | KDE   | =systemsettings=           | Config general del sistema            |
| Display/Monitors           | -     | =arandr=                   | Configurar monitores (xrandr GUI)     |
| Network Connections        | GNOME | =nm-connection-editor=     | WiFi, VPN, proxies                    |
| Bluetooth                  | -     | =blueman-manager=          | Dispositivos Bluetooth                |
| Audio/Volume               | -     | =pavucontrol=              | Mezclador de audio detallado          |
| Printers                   | GNOME | =system-config-printer=    | Configurar impresoras                 |
| Users                      | GNOME | =gnome-control-center user-accounts= | Gestion de usuarios        |
| Date & Time                | GNOME | =gnome-control-center datetime= | Zona horaria, NTP               |
| Power                      | GNOME | =gnome-control-center power= | Energia, suspension                 |
| KDE Connect                | KDE   | =kdeconnect-app=           | Conectar movil al PC                  |

** Gestion de Archivos

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| Dolphin                    | KDE   | =dolphin=                  | File manager muy potente              |
| Nautilus                   | GNOME | =nautilus=                 | File manager GNOME                    |
| Thunar                     | XFCE  | =thunar=                   | File manager ligero                   |
| Disks                      | GNOME | =gnome-disks=              | Particiones, montar discos, SMART     |
| KDE Partition Manager      | KDE   | =partitionmanager=         | Particiones avanzado                  |
| Filelight                  | KDE   | =filelight=                | Uso de disco visual (sunburst)        |
| Baobab                     | GNOME | =baobab=                   | Uso de disco visual                   |

** Multimedia

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| Gwenview                   | KDE   | =gwenview=                 | Visor imagenes con edicion basica     |
| Eye of GNOME               | GNOME | =eog=                      | Visor imagenes simple                 |
| Okular                     | KDE   | =okular=                   | PDFs, ePub, comics, anotaciones       |
| Evince                     | GNOME | =evince=                   | PDFs simple                           |
| Totem                      | GNOME | =totem=                    | Reproductor video                     |
| Elisa                      | KDE   | =elisa=                    | Reproductor musica                    |
| Rhythmbox                  | GNOME | =rhythmbox=                | Reproductor musica + podcasts         |

** Screenshots y Grabacion

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| Spectacle                  | KDE   | =spectacle=                | Screenshots con anotaciones           |
| GNOME Screenshot           | GNOME | =gnome-screenshot=         | Screenshots basico                    |
| Flameshot                  | -     | =flameshot gui=            | Screenshots con edicion               |
| OBS Studio                 | -     | =obs=                      | Grabacion/streaming profesional       |
| Peek                       | -     | =peek=                     | GIFs animados                         |

** Editores y Documentos

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| Kate                       | KDE   | =kate=                     | Editor texto avanzado                 |
| GNOME Text Editor          | GNOME | =gnome-text-editor=        | Editor texto simple                   |
| Gedit                      | GNOME | =gedit=                    | Editor texto clasico                  |
| LibreOffice                | -     | =libreoffice=              | Suite offimatica completa             |
| Apostrophe                 | GNOME | =apostrophe=               | Editor Markdown                       |

** Utilidades

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| Calculator                 | GNOME | =gnome-calculator=         | Calculadora cientifica                |
| KCalc                      | KDE   | =kcalc=                    | Calculadora                           |
| System Monitor             | GNOME | =gnome-system-monitor=     | Procesos, CPU, memoria                |
| KSysGuard                  | KDE   | =ksysguard=                | Monitor sistema clasico               |
| Plasma System Monitor      | KDE   | =plasma-systemmonitor=     | Monitor sistema moderno               |
| Characters                 | GNOME | =gnome-characters=         | Mapa de caracteres, emojis            |
| KCharSelect                | KDE   | =kcharselect=              | Mapa de caracteres                    |
| Fonts                      | GNOME | =gnome-font-viewer=        | Visor de fuentes                      |
| Archive Manager            | GNOME | =file-roller=              | Comprimir/descomprimir                |
| Ark                        | KDE   | =ark=                      | Comprimir/descomprimir                |
| Secrets (Keyring)          | GNOME | =gnome-keyring=            | Gestor de passwords del sistema       |
| KWallet                    | KDE   | =kwalletmanager5=          | Gestor de passwords del sistema       |

** Desarrollo

| App                        | DE    | Comando                    | Para que                              |
|----------------------------+-------+----------------------------+---------------------------------------|
| D-Spy                      | GNOME | =d-spy=                    | Explorador D-Bus                      |
| Qt Designer                | KDE   | =designer=                 | Disenar interfaces Qt                 |
| Glade                      | GNOME | =glade=                    | Disenar interfaces GTK                |

** Herramientas CLI utiles (bonus)

| Comando                    | Para que                                          |
|----------------------------+---------------------------------------------------|
| =xrandr=                   | Configurar monitores desde terminal               |
| =autorandr=                | Perfiles de monitor automaticos                   |
| =xdotool=                  | Automatizar clicks y teclas                       |
| =xclip= / =xsel=           | Clipboard desde terminal                          |
| =wl-copy= / =wl-paste=     | Clipboard Wayland                                 |
| =notify-send=              | Enviar notificaciones                             |
| =pactl=                    | Control PulseAudio/PipeWire                       |
| =playerctl=                | Controlar reproductores multimedia                |
| =brightnessctl=            | Controlar brillo de pantalla                      |
| =nmcli=                    | NetworkManager desde terminal                     |
| =bluetoothctl=             | Bluetooth desde terminal                          |

** Nota sobre instalacion

La mayoria de estas apps ya estan instaladas al tener GNOME y KDE Plasma habilitados.
Si alguna falta, se puede instalar temporalmente con:

#+begin_src bash
nix-shell -p gnome.gnome-disk-utility  # Ejemplo
#+end_src

O anadirla permanentemente en =modules/core/packages.nix=.

* Referencias

- [[https://nixos.org/manual/nixos/stable/][NixOS Manual]]
- [[https://nix-community.github.io/home-manager/][Home Manager Manual]]
- [[https://xmonad.org/][XMonad Documentation]]
- [[https://www.gnu.org/software/stow/manual/stow.html][GNU Stow Manual]]
- [[https://github.com/alacritty/alacritty][Alacritty]]
- [[https://wiki.archlinux.org/title/Picom][Picom Wiki]]
- [[file:nixos-aurin/README.org][NixOS Aurin Specific Docs]]

---

*Ultima actualizacion:* 2026-01-24
*Arquitectura:* Clone-First (mkSystem)
*Display Manager:* SDDM (todas las maquinas)
*Sistemas:* Aurin, MacBook, Vespino (NixOS 25.05)
*Shell principal:* Fish
*Window Manager:* XMonad (X11), Hyprland/niri (Wayland)
*Terminal:* Alacritty

*Documentacion adicional:*
- [[file:docs/MACBOOK-INSTALL-GUIDE.org][Guia instalacion MacBook]] - Paso a paso para instalar NixOS en MacBook Pro 2016
- [[file:CLAUDE.md][CLAUDE.md]] - Instrucciones rapidas para Claude AI
