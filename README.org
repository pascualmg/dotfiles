#+TITLE: Dotfiles - passh@aurin
#+AUTHOR: passh
#+DATE: 2025-11-22
#+STARTUP: overview

* TL;DR - Setup Rápido

#+BEGIN_SRC bash
# Clonar dotfiles
git clone <repo> ~/dotfiles
cd ~/dotfiles

# Aplicar configs importantes
stow -v home-manager  # Home Manager (gestión de paquetes)
stow -v fish          # Shell
stow -v xmonad        # Window manager
stow -v xmobar        # Status bar
stow -v picom         # Compositor (transparencias, sombras, etc.)
stow -v alacritty     # Terminal

# NixOS config (necesita root)
sudo stow -v -t / nixos-aurin

# Rebuild NixOS
sudo nixos-rebuild switch
#+END_SRC

* Estructura del Proyecto

#+BEGIN_SRC text
dotfiles/
├── home-manager/     ★ Home Manager (paquetes, config base)
├── nixos-aurin/      ★ Configuración NixOS específica de Aurin
├── xmonad/           ★ Window manager
├── xmobar/           ★ Status bar
├── picom/            ★ Compositor X11
├── fish/             ★ Fish shell
├── alacritty/        ★ Terminal emulator
├── shell/            • Bashrc/Zshrc (legacy?)
├── scripts/          • Scripts útiles
├── wallpapers/       • Fondos de pantalla
├── composer/         • PHP Composer config
└── README.org        • Este archivo
#+END_SRC

*Leyenda:* =★ Activo= | =• Posiblemente legacy/sin usar=

* Configuraciones Principales

** Home Manager (~/.config/home-manager/home.nix) ★

*Gestiona:* Instalación de paquetes user-level con Nix

*Características:*
- Paquetes desde =stable=, =unstable= y =master=
- Desactiva gestión de configs (usamos stow)
- 200+ paquetes instalados

*Paquetes destacados:*
| Categoría       | Paquetes                                      |
|-----------------+-----------------------------------------------|
| Shells          | fish, zsh, bash                               |
| Editores        | emacs (unstable), neovim, doom-emacs          |
| Development     | php83, nodejs_24, go, python3, rust           |
| Window Manager  | xmonad, xmobar, picom, dmenu                  |
| Tools           | docker, lazydocker, k9s, direnv               |
| Media           | vlc, spotify, obs-studio                      |
| Communication   | telegram-desktop, slack, discord              |
| AI              | ollama, claude-code                           |
| Browsers        | firefox, brave, google-chrome                 |

*Aplicar cambios:*
#+BEGIN_SRC bash
# Editar
vim ~/.config/home-manager/home.nix

# Aplicar
home-manager switch

# O si usas stow
stow -R home-manager
home-manager switch
#+END_SRC

** NixOS Aurin (/etc/nixos/configuration.nix) ★

*Ver documentación completa:* [[file:nixos-aurin/README.org][nixos-aurin/README.org]]

*Sistema:* Dual Xeon E5-2699v3 + RTX 5080 + FiiO K7 + 128GB RAM

*Características principales:*
- NVIDIA RTX 5080 (drivers open-source beta)
- PipeWire optimizado para FiiO K7 DAC/AMP
- Sunshine streaming server (NVENC)
- Virtualización KVM/QEMU + Docker
- Ollama + Open WebUI (AI local)
- Dual NIC + bridge para VMs
- NUMA optimizations para dual socket

*Scripts del sistema:*
| Comando          | Descripción                      |
|------------------+----------------------------------|
| =aurin-info=     | Info completa del sistema        |
| =fiio-k7-test=   | Test DAC/AMP FiiO K7             |
| =sunshine-test=  | Test streaming Sunshine          |
| =xeon-stress=    | Stress test dual Xeon            |
| =numa-info=      | Info NUMA dual socket            |
| =temp-monitor=   | Monitor temperaturas             |

** XMonad (~/.config/xmonad/xmonad.hs) ★

*Tiling window manager* escrito en Haskell

*Características:*
- Layouts: Tall, ThreeCol, Grid, MultiCol
- Scratchpads: terminal, emacs, jetbrains-toolbox
- Grid selector (M-g)
- Integración con xmobar
- Keybindings personalizados

*Keybindings importantes:*
| Tecla               | Acción                              |
|---------------------+-------------------------------------|
| =M-p=               | Dmenu (launcher)                    |
| =M-g=               | Grid selector                       |
| =M-S-<Enter>=       | Alacritty                           |
| =M-S-c=             | Cerrar ventana                      |
| =M-<Space>=         | Cambiar layout                      |
| =M-S-f=             | Fullscreen                          |
| =M-[1-9]=           | Cambiar workspace                   |
| =M-S-[1-9]=         | Mover ventana a workspace           |
| =M-j/k=             | Focus siguiente/anterior            |
| =M-h/l=             | Resize master                       |
| =M-S-a=             | Sink all (des-float todas)          |
| =M-S-s=             | Sticky window (all workspaces)      |
| =M-S-k=             | Kill sticky copies                  |
| =M-<F1>=            | Scratchpad terminal                 |
| =M-<F2>=            | Scratchpad Emacs                    |
| =M-<F3>=            | JetBrains Toolbox                   |
| =M-<Print>=         | Flameshot screenshot                |
| =XF86AudioMute=     | Toggle mute                         |
| =XF86AudioRaise=    | Volumen +5%                         |
| =XF86AudioLower=    | Volumen -5%                         |

*Dmenu:* Busca en flatpak apps + nix-profile + $PATH

*Recargar config:*
#+BEGIN_SRC bash
# Recompilar y recargar
M-q

# O manualmente
xmonad --recompile && xmonad --restart
#+END_SRC

** Picom (~/.config/picom/picom.conf) ★

*Compositor X11* para transparencias, sombras, animaciones, blur

*Características:*
- Backend: GLX (optimizado para RTX 5080)
- VSync: enabled (120Hz)
- Refresh rate: 120
- Transparencias: terminals, rofi, etc.
- Sombras suaves en ventanas
- No borders cuando fullscreen

*Configuración importante:*
#+BEGIN_SRC conf
backend = "glx";
vsync = true;
refresh-rate = 120;
unredir-if-possible = true;  # Mejor para gaming/video
#+END_SRC

*Recargar:*
#+BEGIN_SRC bash
killall picom
picom &
#+END_SRC

** Fish Shell (~/.config/fish/config.fish) ★

*Shell moderno* con autocompletado y syntax highlighting

*Config actual:*
#+BEGIN_SRC fish
# PATH additions
set -x PATH /home/passh/.config/emacs/bin $PATH      # Doom Emacs
set -x PATH /home/passh/node_modules/.bin $PATH      # Node local
set -x PATH /home/passh/.local/bin $PATH             # Local bins
#+END_SRC

*Features:*
- =completions/= - Autocompletados personalizados
- =conf.d/= - Configs adicionales
- =functions/= - Funciones personalizadas

*Uso:*
#+BEGIN_SRC bash
# Cambiar a fish
chsh -s $(which fish)

# O usar temporalmente
fish
#+END_SRC

** Alacritty (~/.config/alacritty/) ★

*Terminal emulator* GPU-accelerated

*Configuración:* Ver =~/.config/alacritty/alacritty.yml=

*Features:*
- Renderizado GPU (OpenGL)
- Scrollback history
- True color support
- Integración con tmux/byobu

** XMobar (~/.config/xmobar/) ★

*Status bar* para XMonad

*Muestra:*
- Workspaces activos
- Layout actual
- Window title
- Posiblemente: CPU, RAM, fecha/hora (ver config)

*Recargar:*
#+BEGIN_SRC bash
killall xmobar
xmobar &
#+END_SRC

** Scripts (~/scripts/) •

*Scripts útiles del sistema*

| Script                            | Descripción                    |
|-----------------------------------+--------------------------------|
| =ubuntu-vm-ivanti-configurator.sh= | Configurador VM Ubuntu Ivanti  |
| =hdmon.sh=                        | Monitor discos duros?          |
| =vm-backupeitor.sh=               | Backup VMs?                    |

*Nota:* Puede que algunos estén obsoletos o sean específicos de otro setup

** Wallpapers (~/wallpapers/) •

Fondos de pantalla

*Gestión:*
- Nitrogen (GUI)
- O directamente con =feh=

** Shell (bashrc/zshrc) •

*Posiblemente legacy* - Fish es el shell principal

Contiene:
- =.bashrc= - Configuración Bash
- =.zshrc= - Configuración Zsh

*¿Usar?* Probablemente no si usas Fish, pero mantienen compatibilidad

** Composer (~/.config/composer/) •

*PHP Composer* config

Probablemente para desarrollo PHP (tienes php83 en home.nix)

* Guía Stow - Gestión de Dotfiles

** ¿Qué es Stow?

GNU Stow crea *enlaces simbólicos* desde tu dotfiles repo a tu $HOME

** Comandos Esenciales

#+BEGIN_SRC bash
cd ~/dotfiles

# Crear enlaces (primera vez)
stow PAQUETE

# Quitar enlaces
stow -D PAQUETE

# Recrear enlaces (cuando cambias cosas)
stow -R PAQUETE

# Ver qué va a hacer sin ejecutar
stow -n PAQUETE

# Verbose (siempre recomendado)
stow -v PAQUETE
#+END_SRC

** Workflows Comunes

*** Activar configuración por primera vez:
#+BEGIN_SRC bash
cd ~/dotfiles
stow -v xmonad
stow -v fish
#+END_SRC

*** Actualizar configuración existente:
#+BEGIN_SRC bash
# Editar archivo en dotfiles
vim ~/dotfiles/fish/.config/fish/config.fish

# Recrear enlaces (por si acaso)
stow -R fish
#+END_SRC

*** Para NixOS (necesita root y target /):
#+BEGIN_SRC bash
sudo stow -v -R -t / nixos-aurin

# Verificar
ls -la /etc/nixos/

# Aplicar cambios
sudo nixos-rebuild switch
#+END_SRC

** Flags Explicadas

| Flag     | Significado  | Uso                              |
|----------+--------------+----------------------------------|
| =-v=     | Verbose      | Ver qué hace stow                |
| =-R=     | Restow       | Quitar y recrear enlaces         |
| =-D=     | Delete       | Solo quitar enlaces              |
| =-t DIR= | Target       | Directorio donde crear enlaces   |
| =-n=     | No execute   | Simular sin ejecutar (dry-run)   |

** Pro Tips

- *Nunca uses =sudo stow=* para archivos de usuario (home)
- *Siempre usa =sudo stow -t /=* para archivos del sistema (/etc)
- *Usa =-R=* cuando dudes, es más seguro
- *Usa =-v=* siempre para ver qué hace
- *Usa =-n=* para testing antes de ejecutar
- *Git tu dotfiles* para backup/sync

** Troubleshooting

*** "Conflicts with existing target"
#+BEGIN_SRC bash
# Ver qué conflicta
stow -v -n PAQUETE

# Quitar archivo manual (backup primero)
mv ~/.config/fish/config.fish ~/.config/fish/config.fish.backup

# Volver a stow
stow fish
#+END_SRC

*** "Permission denied"
#+BEGIN_SRC bash
# Para archivos del sistema (/etc)
sudo stow -t / PAQUETE

# Para archivos de usuario (nunca uses sudo)
stow PAQUETE
#+END_SRC

*** Ver enlaces existentes
#+BEGIN_SRC bash
# Ver todos los symlinks en home
find ~ -maxdepth 3 -type l -ls | grep dotfiles

# Ver específico
ls -la ~/.config/fish/config.fish
#+END_SRC

* Git Workflow

#+BEGIN_SRC bash
cd ~/dotfiles

# Ver cambios
git status
git diff

# Commit cambios
git add .
git commit -m "Update xmonad keybindings"
git push

# En otra máquina
git pull
stow -R xmonad  # Recrear enlaces
#+END_SRC

** Credenciales Git Persistentes

Las credenciales de git se almacenan permanentemente gracias a =credential.helper = store=
configurado en =modules/home-manager/passh.nix=.

*Ubicación:* =~/.git-credentials=

*Formato del archivo:*
#+BEGIN_SRC text
https://usuario:password@bitbucket.vocento.com
https://usuario:token@github.com
#+END_SRC

*Primera vez:* Git pedirá credenciales una vez y las guardará automáticamente.

*Regenerar credenciales:*
#+BEGIN_SRC bash
# Borrar credenciales existentes
rm ~/.git-credentials

# El próximo git push/pull pedirá credenciales de nuevo
#+END_SRC

*Seguridad:* El archivo tiene permisos =600= (solo el usuario puede leer/escribir).

* Comandos Más Usados

#+BEGIN_SRC bash
# Activar config (con verbose)
stow -v -R PAQUETE

# Para NixOS
sudo stow -v -R -t / nixos-aurin
sudo nixos-rebuild switch

# Home Manager
stow -v -R home-manager
home-manager switch

# Testear sin aplicar
stow -v -n PAQUETE
#+END_SRC

* Setup Completo Nueva Máquina

#+BEGIN_SRC bash
# 1. Clonar dotfiles
git clone <repo-url> ~/dotfiles
cd ~/dotfiles

# 2. Aplicar Home Manager
stow -v home-manager
home-manager switch

# 3. Aplicar configs de usuario
stow -v fish
stow -v xmonad
stow -v xmobar
stow -v picom
stow -v alacritty

# 4. NixOS config (solo en NixOS)
sudo stow -v -t / nixos-aurin
sudo nixos-rebuild switch

# 5. Recargar shell
fish

# 6. Reiniciar sesión X (logout/login) o:
xmonad --recompile && xmonad --restart
#+END_SRC

* Notas de Desarrollo

** Home Manager vs NixOS config

- *NixOS config* (=/etc/nixos/configuration.nix=): Sistema base, servicios, hardware
- *Home Manager* (=~/.config/home-manager/home.nix=): Paquetes usuario, configs user-level

** Channels

#+BEGIN_SRC bash
# Ver channels
nix-channel --list

# Debería mostrar:
# home-manager https://github.com/nix-community/home-manager/archive/release-25.05.tar.gz
#+END_SRC

** Direnv

Tienes =direnv= instalado. Usa =.envrc= en proyectos para cargar variables automáticamente:

#+BEGIN_SRC bash
# En directorio proyecto
echo "use nix" > .envrc
direnv allow
#+END_SRC

* NixOS MacBook Pro 13,2 (2016)

** Hardware Status

| Componente         | Estado | Notas                                          |
|--------------------+--------+------------------------------------------------|
| Audio (CS8409)     | ✅ OK  | Driver snd-hda-macbookpro (davidjo)            |
| WiFi (BCM43602)    | ❌ NO  | Driver wl abandonado 2019, usar USB dongle     |
| Touch Bar (T1)     | ❌ NO  | Chip T1 en recovery mode, workaround con keyd  |
| Webcam FaceTime HD | ❌ NO  | Conectada via T1, requiere reset del T1        |
| Teclado/Trackpad   | ✅ OK  | Drivers applespi + keyd (fix ISO swap)         |
| Pantalla HiDPI     | ✅ OK  | 168 DPI, scaling 2x en GNOME                   |
| Batería            | ✅ OK  | ACPI estándar                                  |
| F-keys (Fn+número) | ✅ OK  | keyd: Fn+1=F1, Fn+º=Esc, etc.                  |

** Audio CS8409 - Solución

El MacBook Pro 2016 usa un chip Cirrus Logic CS8409 como bridge HDA.
El driver del kernel solo soporta Dell (subsystem IDs diferentes).

*Solución implementada:*
- Módulo custom =snd-hda-macbookpro= compilado desde [[https://github.com/davidjo/snd_hda_macbookpro][davidjo/snd_hda_macbookpro]]
- Parchea el driver del kernel para añadir soporte Apple (GPIO init)
- Config en =nixos-macbook/etc/nixos/modules/snd-hda-macbookpro.nix=

*Verificar funcionamiento:*
#+BEGIN_SRC bash
# Diagnóstico completo
audio-diag

# GPIO debe mostrar enable=1 para IO[0-3]
cat /proc/asound/card0/codec#0 | grep -A 10 "^GPIO:"

# Test altavoces
speaker-test -c 2 -t wav
#+END_SRC

** WiFi BCM43602 - Sin solución

El chip Broadcom BCM43602 interno requiere el driver =wl= (broadcom-sta).

*Estado del driver:*
- El módulo *compila* correctamente (mantenido por RPMFusion/Debian)
- Pero *falla en runtime* con kernel 6.x: =wl driver failed with code 1=
- Error: =NULL ndev->ieee80211ptr, unable to deref wl=
- Causa: APIs internas del kernel incompatibles con el driver propietario

*Conclusión:* El driver está muerto a nivel funcional, no solo de mantenimiento.
No hay solución posible sin que Broadcom libere código o alguien haga ingeniería inversa.

*Alternativa funcional:* USB WiFi dongle con chip Realtek (RTL8xxxu)
- Ejemplo: TP-Link TL-WN725N o similar
- Funciona out-of-the-box con driver =rtl8xxxu= del kernel

** Touch Bar T1 - Sin solución

El chip T1 (Touch Bar + Touch ID + *FaceTime HD Camera*) está en "Recovery Mode" permanente.

*Dispositivos conectados al T1:*
- Touch Bar (OLED strip)
- Touch ID (sensor huella)
- FaceTime HD Camera (720p)
- Ambient Light Sensor

*Problema:*
- El T1 aparece como =05ac:1281= (DFU/Recovery) en lugar de =05ac:8600= (iBridge)
- El firmware está corrupto o nunca fue inicializado
- Los drivers Linux (apple-ibridge, tiny-dfr, facetimehd) requieren el T1 en modo normal
- Sin T1 funcional, la cámara no es visible para el sistema (no hay =/dev/video*=)

*Única solución:*
- Conectar a un Mac con macOS
- Usar Apple Configurator 2 para restaurar el firmware del T1
- Sin acceso a macOS = sin Touch Bar

*Workaround con keyd:*
- =Fn + º= (tecla junto al 1) = Escape
- =Fn + 1-0= = F1-F10
- =Fn + -= = F11, =Fn + == = F12
- =Fn + Backspace= = Delete
- =Fn + Flechas= = Home/End/PageUp/PageDown

Configurado en =services.keyd= en configuration.nix.

** Teclado Spanish ISO - Fix teclas swapeadas

El teclado Apple SPI tiene las teclas =º ª= y =< >= intercambiadas respecto al layout físico.

*Solución:* keyd remapea las teclas a nivel kernel:
#+BEGIN_SRC nix
"grave" = "102nd";  # Swap tecla junto al 1
"102nd" = "grave";  # Swap tecla entre Shift y Z
#+END_SRC

Esto funciona tanto en X11 (XMonad) como en Wayland (GNOME) porque keyd opera a nivel evdev.

* Doom Emacs: Tree-Sitter y Syntax Highlighting en NixOS

** Qué es Tree-Sitter

Tree-sitter es un sistema de parseo incremental que genera árboles de sintaxis abstracta (AST)
para código fuente. A diferencia del syntax highlighting tradicional basado en expresiones
regulares, tree-sitter:

- *Parsea el código completo* como lo haría un compilador
- *Es incremental*: solo reparsea las partes que cambian
- *Entiende la estructura* del código, no solo patrones de texto
- *Es más rápido* para archivos grandes
- *Proporciona highlighting más preciso* (distingue variables locales de globales, etc.)

** Tree-sitter en Emacs

Emacs 29+ incluye soporte nativo para tree-sitter (=treesit=), pero necesita *grammars compilados*
para cada lenguaje. Estos grammars son bibliotecas dinámicas (.so en Linux, .dylib en macOS).

*** El Problema en NixOS

Cuando Doom Emacs intenta usar tree-sitter, necesita compilar los grammars si no existen.
Esto falla o se congela en NixOS porque:

1. El compilador de C (gcc/clang) puede no estar en el PATH de Emacs
2. Las rutas de bibliotecas del sistema son diferentes en NixOS
3. El sandbox de Nix complica la compilación dinámica

** Opciones Disponibles

*** Opción 1: Deshabilitar Tree-sitter (Recomendado)

Si el syntax highlighting tradicional es suficiente, simplemente quita los flags =+tree-sitter=.

*En =~/.config/doom/init.el=:*

#+BEGIN_SRC emacs-lisp
;; ANTES (con tree-sitter)
:tools
tree-sitter

:lang
(nix +lsp +tree-sitter)
(php +lsp +tree-sitter)

;; DESPUÉS (sin tree-sitter)
:tools
;;tree-sitter  ; Comentado o eliminado

:lang
(nix +lsp)
(php +lsp)
#+END_SRC

*Aplicar cambios:*
#+BEGIN_SRC bash
~/.config/emacs/bin/doom sync
# Reiniciar Emacs
#+END_SRC

*Pros:* Sin configuración adicional, funciona inmediatamente, LSP ya proporciona el 90% de los beneficios.

*** Opción 2: Instalar Grammars via NixOS

NixOS puede preinstalar los grammars compilados. En =modules/home-manager/passh.nix=:

#+BEGIN_SRC nix
home.packages = with pkgs; [
  tree-sitter-grammars.tree-sitter-nix
  tree-sitter-grammars.tree-sitter-javascript
  tree-sitter-grammars.tree-sitter-php
  tree-sitter-grammars.tree-sitter-json
  tree-sitter-grammars.tree-sitter-html
  tree-sitter-grammars.tree-sitter-bash
];
#+END_SRC

Y en =~/.config/doom/config.el=:

#+BEGIN_SRC emacs-lisp
(when (and (fboundp 'treesit-available-p) (treesit-available-p))
  (setq treesit-extra-load-path
        (list (expand-file-name "~/.nix-profile/lib/tree-sitter")
              "/run/current-system/sw/lib/tree-sitter")))
#+END_SRC

** Verificar Estado

#+BEGIN_SRC emacs-lisp
;; M-x eval-expression RET
(treesit-available-p)              ; Debería retornar t
(treesit-language-available-p 'nix) ; Ver si grammar de nix está
#+END_SRC

*Modo activo:* Sin tree-sitter usa =nix-mode=, con tree-sitter usa =nix-ts-mode= (sufijo =-ts-=).

** Grammars Disponibles

#+BEGIN_SRC bash
nix search nixpkgs tree-sitter-grammars
#+END_SRC

| Lenguaje   | Paquete Nix                                 |
|------------+---------------------------------------------|
| Nix        | tree-sitter-grammars.tree-sitter-nix        |
| JavaScript | tree-sitter-grammars.tree-sitter-javascript |
| PHP        | tree-sitter-grammars.tree-sitter-php        |
| JSON       | tree-sitter-grammars.tree-sitter-json       |
| HTML       | tree-sitter-grammars.tree-sitter-html       |
| Bash       | tree-sitter-grammars.tree-sitter-bash       |

* Hosts Privados de Trabajo

** El Problema

Para desarrollo necesitamos hosts internos (staging, dev, etc.) que no pueden
estar en un repo público. El archivo está en un repo de trabajo externo.

** Por qué requiere --impure

En NixOS Flakes, =builtins.pathExists= para paths externos al flake SIEMPRE
devuelve =false= en evaluación pura. Por eso usamos =--impure=.

** Solución Actual

#+BEGIN_SRC bash
# Aurin (con hosts de trabajo)
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# Macbook (requiere clonar repo de trabajo primero)
git clone <work-repo> ~/src/work/work-env
sudo nixos-rebuild switch --flake ~/dotfiles#macbook --impure
#+END_SRC

** Opciones Futuras (cuando haga falta)

| Opción | Puro? | Complejidad | Notas |
|--------|-------|-------------|-------|
| =--impure= (actual) | No | Baja | Simple, funciona |
| sops-nix | Sí | Media | Encripta secretos en repo |
| Repo privado input | Sí | Media | Flake input con SSH |

Para implementar sops-nix: [[https://github.com/Mic92/sops-nix][sops-nix GitHub]]

* TODO Tareas Pendientes

- [ ] Revisar y limpiar configs obsoletas (shell/, composer/)
- [ ] Documentar scripts útiles en scripts/
- [ ] Migrar xmonad a home-manager (si merece la pena)
- [ ] Considerar sops-nix para secretos

* Roadmap: Migración Stow → Home Manager

** Contexto

Con la adopción de NixOS Flakes para múltiples máquinas (aurin, macbook), GNU Stow
se vuelve redundante. Home Manager integrado con el flake ofrece:

- *Configs per-machine declarativas* (ej: xmobar con diferentes DPI/fonts)
- *Un solo comando* =nixos-rebuild switch= aplica sistema + usuario
- *Reproducibilidad total* - Todo versionado en el flake
- *Rollback automático* - Generaciones anteriores disponibles

** Estado Actual (Anti-pattern)

En =modules/home-manager/passh.nix= línea ~253 hay un hack que usa stow dentro de home-manager:

#+BEGIN_SRC nix
activation.linkDotfiles = lib.hm.dag.entryBefore [ "checkLinkTargets" ] ''
  ${pkgs.stow}/bin/stow -v -R -t ${config.home.homeDirectory} \
    alacritty composer fish picom xmobar xmonad claude-code
'';
#+END_SRC

Esto debe eliminarse gradualmente migrando cada config a home-manager nativo.

** Arquitectura Propuesta

#+BEGIN_SRC text
modules/home-manager/
├── default.nix           # Entry point, recibe hostname
├── common.nix            # Configs compartidas (paquetes base)
├── programs/
│   ├── xmobar.nix        # Xmobar con opciones parametrizables
│   ├── xmonad.nix        # XMonad config
│   ├── alacritty.nix     # Terminal
│   └── fish.nix          # Shell (usa programs.fish nativo)
└── machines/
    ├── aurin.nix         # fontSize=14, dpi=96, nvidia, interfaces de red
    └── macbook.nix       # fontSize=22, dpi=168, intel, HiDPI
#+END_SRC

** Pasar hostname al flake

En =flake.nix=, función =mkNixosConfig=:

#+BEGIN_SRC nix
home-manager.extraSpecialArgs = {
  inherit inputs;
  hostname = hostname;  # Añadir esto
};
#+END_SRC

** Patrón para configs per-machine

#+BEGIN_SRC nix
# modules/home-manager/programs/xmobar.nix
{ config, lib, ... }:

let cfg = config.custom.xmobar;
in {
  options.custom.xmobar = {
    fontSize = lib.mkOption {
      type = lib.types.int;
      default = 14;
    };
    dpi = lib.mkOption {
      type = lib.types.int;
      default = 96;
    };
  };

  config.home.file.".config/xmobar/xmobarrc".text = ''
    Config { font = "xft:Monoid Nerd Font:size=${toString cfg.fontSize}"
           , ...
    }
  '';
}
#+END_SRC

Luego en cada máquina:

#+BEGIN_SRC nix
# machines/macbook.nix
{ ... }: {
  custom.xmobar.fontSize = 22;
  custom.xmobar.dpi = 168;
}

# machines/aurin.nix
{ ... }: {
  custom.xmobar.fontSize = 14;
  # dpi usa default 96
}
#+END_SRC

** Orden de Migración Recomendado

1. [X] *xmobar* - ✅ COMPLETADO (2026-01-04)
   - Módulo parametrizable en =modules/home-manager/programs/xmobar.nix=
   - Configs per-machine en =modules/home-manager/machines/{aurin,macbook}.nix=
   - Opciones: fontSize, gpuType, networkInterface, wifiInterface, showBattery, showTrayer, alsaMixer

2. [X] *alacritty* - ✅ COMPLETADO (2026-01-04)
   - Módulo en =modules/home-manager/programs/alacritty.nix=
   - Usa =programs.alacritty= nativo de home-manager
   - Opciones: fontSize (14 aurin, 18 macbook), theme (dark/light)
   - Tema Spacemacs inline

3. [X] *picom* - ✅ COMPLETADO (2026-01-04)
   - Módulo en =modules/home-manager/programs/picom.nix=
   - Opción: backend (egl para NVIDIA, xrender para Intel)
   - Config completa inline (shadows, blur, animations)

4. [X] *fish* - ✅ COMPLETADO (2026-01-04)
   - Módulo en =modules/home-manager/programs/fish.nix=
   - Usa =programs.fish= nativo de home-manager
   - Aliases: git shortcuts, eza/ls, nixos helpers
   - Abbreviations: docker, nix

5. [ ] *xmonad* - Pendiente (config Haskell compleja)
   - Actualmente gestionado via stow
   - Requiere análisis de cómo parametrizar Haskell

6. [ ] *composer* - Pendiente (bajo riesgo, simple)
   - PHP tool, config estático
   - Baja prioridad

7. [X] Reducir bloque =activation.linkDotfiles= - ✅ PARCIALMENTE
   - Solo quedan: xmonad, composer, claude-code
   - Documentado estado en passh.nix líneas 255-276

8. [ ] Eliminar carpetas stow vacías (cuando todo migre)

** Referencias

- [[https://nix-community.github.io/home-manager/][Home Manager Manual]]
- [[https://nixos.wiki/wiki/Flakes][NixOS Flakes Wiki]]

* Estructura Recomendada para Nuevas Configs

Al añadir nueva configuración:

#+BEGIN_SRC text
dotfiles/
└── nueva-app/
    └── .config/
        └── nueva-app/
            └── config.conf
#+END_SRC

Luego:
#+BEGIN_SRC bash
stow nueva-app
#+END_SRC

Esto crea: =~/.config/nueva-app/config.conf= → =~/dotfiles/nueva-app/.config/nueva-app/config.conf=

* Referencias

- [[https://nixos.org/manual/nixos/stable/][NixOS Manual]]
- [[https://nix-community.github.io/home-manager/][Home Manager Manual]]
- [[https://xmonad.org/][XMonad Documentation]]
- [[https://www.gnu.org/software/stow/manual/stow.html][GNU Stow Manual]]
- [[https://github.com/alacritty/alacritty][Alacritty]]
- [[https://wiki.archlinux.org/title/Picom][Picom Wiki]]
- [[file:nixos-aurin/README.org][NixOS Aurin Specific Docs]]

---

*Última actualización:* 2026-01-05
*Sistemas:* Aurin (NixOS 25.05), MacBook Pro 13,2 (NixOS Flakes), Vespino (pendiente migrar)
*Shell principal:* Fish
*Window Manager:* XMonad
*Terminal:* Alacritty

*Documentación adicional:*
- [[file:docs/MACBOOK-INSTALL-GUIDE.org][Guía instalación MacBook]] - Paso a paso para instalar NixOS en MacBook Pro 2016
