#+TITLE: Estructura Ideal de Dotfiles con Flakes
#+AUTHOR: NixOS Guru
#+DATE: 2026-01-01
#+STARTUP: overview

* Vision General

#+begin_example
dotfiles/
│
├── flake.nix                      # Punto de entrada UNICO
├── flake.lock                     # Versiones pinneadas
├── README.org                     # Doc principal del repo
│
├── nixos/                         # Todo lo relacionado con NixOS
│   ├── hosts/                     # Configuraciones por maquina
│   │   ├── aurin/
│   │   │   ├── default.nix
│   │   │   ├── hardware.nix
│   │   │   └── README.org
│   │   └── vespino/
│   │       ├── default.nix
│   │       ├── hardware.nix
│   │       └── README.org
│   │
│   └── modules/                   # Modulos NixOS compartidos
│       ├── core/
│       ├── hardware/
│       ├── services/
│       ├── network/
│       └── desktop/
│
├── home/                          # Home Manager configs
│   ├── profiles/
│   │   └── passh/
│   │       └── default.nix
│   └── modules/
│       ├── shell/
│       ├── editors/
│       ├── desktop/
│       └── development/
│
├── configs/                       # Archivos raw (no .nix)
│   ├── xmonad/
│   ├── xmobar/
│   ├── picom/
│   ├── alacritty/
│   └── doom/
│
├── overlays/
├── lib/
└── scripts/
#+end_example

* flake.nix Completo

#+begin_src nix
# /home/passh/dotfiles/flake.nix
{
  description = "NixOS & Home Manager configuration for passh";

  inputs = {
    # === Nixpkgs ===
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-24.11";
    nixpkgs-unstable.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixpkgs-master.url = "github:NixOS/nixpkgs/master";

    # === Home Manager ===
    home-manager = {
      url = "github:nix-community/home-manager/release-24.11";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # === Extras (futuro) ===
    # agenix.url = "github:ryantm/agenix";  # Secretos
    # nixvim.url = "github:nix-community/nixvim";  # Neovim config
  };

  outputs = { self, nixpkgs, nixpkgs-unstable, nixpkgs-master, home-manager, ... }@inputs:
  let
    system = "x86_64-linux";

    # === Package Sets ===
    pkgs = import nixpkgs {
      inherit system;
      config.allowUnfree = true;
    };

    pkgs-unstable = import nixpkgs-unstable {
      inherit system;
      config.allowUnfree = true;
    };

    pkgs-master = import nixpkgs-master {
      inherit system;
      config.allowUnfree = true;
    };

    # === Argumentos especiales para todos los modulos ===
    specialArgs = {
      inherit inputs pkgs-unstable pkgs-master;
    };

    # === Helper: Crear configuracion NixOS ===
    mkHost = hostname: nixpkgs.lib.nixosSystem {
      inherit system specialArgs;
      modules = [
        # Host config
        ./nixos/hosts/${hostname}

        # Home Manager integration
        home-manager.nixosModules.home-manager
        {
          home-manager = {
            useGlobalPkgs = true;
            useUserPackages = true;
            extraSpecialArgs = specialArgs;
            users.passh = import ./home/profiles/passh;
          };
        }
      ];
    };

  in {
    # === NixOS Configurations ===
    nixosConfigurations = {
      aurin = mkHost "aurin";
      vespino = mkHost "vespino";
    };

    # === Development Shell ===
    devShells.${system}.default = pkgs.mkShell {
      packages = with pkgs; [
        nil           # LSP Nix
        nixfmt-classic
        statix        # Linter Nix
      ];
    };

    # === Formatter ===
    formatter.${system} = pkgs.nixfmt-classic;
  };
}
#+end_src

* Modulos NixOS

** Core (siempre se incluyen)

*** nixos/modules/core/default.nix
#+begin_src nix
{ ... }:
{
  imports = [
    ./nix.nix
    ./locale.nix
    ./users.nix
  ];
}
#+end_src

*** nixos/modules/core/nix.nix
#+begin_src nix
{ pkgs, ... }:
{
  nix = {
    settings = {
      auto-optimise-store = true;
      experimental-features = [ "nix-command" "flakes" ];
      trusted-users = [ "root" "@wheel" ];
    };
    gc = {
      automatic = true;
      dates = "weekly";
      options = "--delete-older-than 14d";
    };
  };

  # Paquetes esenciales del sistema
  environment.systemPackages = with pkgs; [
    git
    vim
    wget
    curl
  ];
}
#+end_src

*** nixos/modules/core/locale.nix
#+begin_src nix
{ ... }:
{
  time.timeZone = "Europe/Madrid";

  i18n = {
    defaultLocale = "en_US.UTF-8";
    extraLocaleSettings = {
      LC_ADDRESS = "es_ES.UTF-8";
      LC_IDENTIFICATION = "es_ES.UTF-8";
      LC_MEASUREMENT = "es_ES.UTF-8";
      LC_MONETARY = "es_ES.UTF-8";
      LC_NAME = "es_ES.UTF-8";
      LC_NUMERIC = "es_ES.UTF-8";
      LC_PAPER = "es_ES.UTF-8";
      LC_TELEPHONE = "es_ES.UTF-8";
      LC_TIME = "es_ES.UTF-8";
    };
  };

  console = {
    font = "ter-p20n";
    keyMap = "us";
  };
}
#+end_src

*** nixos/modules/core/users.nix
#+begin_src nix
{ pkgs, ... }:
{
  users.users.passh = {
    isNormalUser = true;
    description = "passh";
    extraGroups = [
      "wheel"
      "networkmanager"
      "audio"
      "video"
      "docker"
      "libvirtd"
      "kvm"
    ];
    shell = pkgs.fish;
  };

  programs.fish.enable = true;

  security.sudo.wheelNeedsPassword = false;
}
#+end_src

** Network - VPN Vocento (ZONA SAGRADA)

*** nixos/modules/network/vpn-vocento.nix
#+begin_src nix
# =============================================================================
# ZONA SAGRADA: VPN VOCENTO
# =============================================================================
# NO MODIFICAR sin:
# 1. Backup de la VM Ubuntu con Ivanti
# 2. Snapshot de la generacion NixOS actual
# 3. Plan de rollback documentado
#
# Este modulo configura:
# - Bridge br0 para VMs
# - Rutas estaticas a infraestructura Vocento via VM Ubuntu (192.168.53.12)
# - NAT para que las VMs accedan a internet
# =============================================================================

{ lib, ... }:

{
  networking = {
    # Bridge vacio (la VM se conecta via libvirt)
    bridges.br0.interfaces = [ ];

    interfaces.br0 = {
      useDHCP = false;
      ipv4 = {
        addresses = [{
          address = "192.168.53.10";
          prefixLength = 24;
        }];

        # Rutas a infraestructura Vocento via VM Ubuntu
        routes = [
          { address = "10.180.0.0"; prefixLength = 16; via = "192.168.53.12"; }
          { address = "10.182.0.0"; prefixLength = 16; via = "192.168.53.12"; }
          { address = "10.184.0.0"; prefixLength = 16; via = "192.168.53.12"; }
          { address = "10.186.0.0"; prefixLength = 16; via = "192.168.53.12"; }
          { address = "192.168.196.0"; prefixLength = 24; via = "192.168.53.12"; }
          { address = "10.200.26.0"; prefixLength = 24; via = "192.168.53.12"; }
          { address = "34.175.0.0"; prefixLength = 16; via = "192.168.53.12"; }
          { address = "34.13.0.0"; prefixLength = 16; via = "192.168.53.12"; }
        ];
      };
    };

    # NAT para que VMs salgan a internet
    nat = {
      enable = true;
      internalInterfaces = [ "br0" ];
      extraCommands = ''
        iptables -t nat -A POSTROUTING -s 192.168.53.0/24 -j MASQUERADE
      '';
    };

    # DNS via VM Ubuntu
    nameservers = lib.mkDefault [ "192.168.53.12" "8.8.8.8" ];
    search = [ "grupo.vocento" ];
    resolvconf.enable = false;

    firewall.checkReversePath = false;
  };

  # IP forwarding
  boot.kernel.sysctl = {
    "net.ipv4.ip_forward" = 1;
    "net.ipv4.conf.all.forwarding" = 1;
    "net.ipv4.conf.default.forwarding" = 1;
  };
}
#+end_src

** Hardware

*** nixos/modules/hardware/nvidia-rtx50xx.nix
#+begin_src nix
# RTX 50xx (Blackwell) - REQUIERE drivers open
{ config, pkgs, ... }:
{
  hardware.nvidia = {
    open = true;  # OBLIGATORIO para RTX 5080
    package = config.boot.kernelPackages.nvidiaPackages.beta;
    modesetting.enable = true;
    nvidiaSettings = true;
    powerManagement.enable = true;
    nvidiaPersistenced = true;
  };

  hardware.graphics = {
    enable = true;
    enable32Bit = true;
    extraPackages = with pkgs; [
      nvidia-vaapi-driver
      vaapiVdpau
      libvdpau-va-gl
    ];
  };

  services.xserver.videoDrivers = [ "nvidia" ];

  boot.kernelParams = [
    "nvidia-drm.modeset=1"
    "nvidia-drm.fbdev=1"
  ];

  environment.sessionVariables = {
    LIBVA_DRIVER_NAME = "nvidia";
    __GLX_VENDOR_LIBRARY_NAME = "nvidia";
  };
}
#+end_src

*** nixos/modules/hardware/nvidia-legacy.nix
#+begin_src nix
# GPUs antiguas - drivers propietarios
{ config, pkgs, ... }:
{
  hardware.nvidia = {
    open = false;
    package = config.boot.kernelPackages.nvidiaPackages.stable;
    modesetting.enable = true;
    nvidiaSettings = true;
    forceFullCompositionPipeline = true;
  };

  hardware.graphics = {
    enable = true;
    enable32Bit = true;
  };

  services.xserver.videoDrivers = [ "nvidia" ];

  environment.sessionVariables = {
    LIBVA_DRIVER_NAME = "nvidia";
    __GLX_VENDOR_LIBRARY_NAME = "nvidia";
  };
}
#+end_src

* Host Configs

** nixos/hosts/aurin/default.nix
#+begin_src nix
{ config, pkgs, pkgs-unstable, ... }:

{
  imports = [
    ./hardware.nix

    # Core
    ../../modules/core

    # Hardware
    ../../modules/hardware/nvidia-rtx50xx.nix
    ../../modules/hardware/audio-pipewire.nix
    ../../modules/hardware/audio-fiio-k7.nix

    # Network
    ../../modules/network/vpn-vocento.nix

    # Services
    ../../modules/services/virtualization.nix
    ../../modules/services/sunshine.nix
    ../../modules/services/ollama.nix
    ../../modules/services/syncthing.nix

    # Desktop
    ../../modules/desktop/xmonad.nix
    ../../modules/desktop/printing.nix
  ];

  # === Identity ===
  networking.hostName = "aurin";

  # === Network (host-specific) ===
  networking.interfaces.enp7s0 = {
    useDHCP = false;
    ipv4.addresses = [{
      address = "192.168.2.147";
      prefixLength = 24;
    }];
  };

  networking.defaultGateway = {
    address = "192.168.2.1";
    interface = "enp7s0";
  };

  networking.nat.externalInterface = "enp7s0";

  # === Firewall ===
  networking.firewall.allowedTCPPorts = [
    22 80 443 53
    8385 22000    # Syncthing
    3000          # Open-webui
    5900 5901     # VNC
  ];

  # === Dual Xeon Optimizations ===
  boot.kernelParams = [
    "numa_balancing=enable"
  ];

  boot.kernel.sysctl = {
    "vm.swappiness" = 1;
    "kernel.numa_balancing" = 1;
  };

  environment.sessionVariables = {
    OMP_NUM_THREADS = "72";
    MKL_NUM_THREADS = "72";
  };

  # === System Packages (host-specific) ===
  environment.systemPackages = with pkgs; [
    numactl
    perf-tools
  ];

  system.stateVersion = "25.05";
}
#+end_src

** nixos/hosts/vespino/default.nix
#+begin_src nix
{ config, pkgs, pkgs-unstable, ... }:

{
  imports = [
    ./hardware.nix

    # Core
    ../../modules/core

    # Hardware
    ../../modules/hardware/nvidia-legacy.nix
    ../../modules/hardware/audio-pipewire.nix

    # Network
    ../../modules/network/vpn-vocento.nix

    # Services
    ../../modules/services/virtualization.nix
    ../../modules/services/minecraft.nix
    ../../modules/services/ollama.nix
    ../../modules/services/syncthing.nix
    ../../modules/services/nfs.nix

    # Desktop
    ../../modules/desktop/xmonad.nix
  ];

  # === Identity ===
  networking.hostName = "vespino";

  # === Network (host-specific) ===
  networking.interfaces.enp10s0 = {
    useDHCP = false;
    ipv4.addresses = [{
      address = "192.168.2.125";
      prefixLength = 24;
    }];
  };

  networking.defaultGateway = {
    address = "192.168.2.1";
    interface = "enp10s0";
  };

  networking.nat.externalInterface = "enp10s0";

  # === Firewall ===
  networking.firewall.allowedTCPPorts = [
    22 80 443 53
    8384 22000    # Syncthing
    3000          # Open-webui
    25565         # Minecraft
    111 2049      # NFS
  ];

  system.stateVersion = "24.05";
}
#+end_src

* Home Manager

** home/profiles/passh/default.nix
#+begin_src nix
{ config, pkgs, pkgs-unstable, ... }:

{
  imports = [
    ../../modules/shell/fish.nix
    ../../modules/shell/direnv.nix
    ../../modules/editors/emacs.nix
    ../../modules/desktop/alacritty.nix
    ../../modules/desktop/xmonad.nix
    ../../modules/desktop/picom.nix
    ../../modules/development/git.nix
  ];

  home = {
    username = "passh";
    homeDirectory = "/home/passh";
    stateVersion = "24.11";
  };

  # Paquetes de usuario
  home.packages = with pkgs; [
    # Browsers
    firefox
    pkgs-unstable.google-chrome

    # Communication
    telegram-desktop
    slack

    # Media
    vlc
    spotify

    # Development
    pkgs-unstable.vscode
    jetbrains.idea-ultimate
  ];

  # Permitir unfree
  nixpkgs.config.allowUnfree = true;
}
#+end_src

** home/modules/desktop/xmonad.nix
#+begin_src nix
{ config, ... }:
{
  # Linkear xmonad.hs desde configs/
  xdg.configFile = {
    "xmonad/xmonad.hs".source = ../../../configs/xmonad/xmonad.hs;
    "xmobar/xmobarrc".source = ../../../configs/xmobar/xmobarrc;
  };
}
#+end_src

** home/modules/desktop/alacritty.nix
#+begin_src nix
{ config, pkgs, pkgs-unstable, ... }:
{
  programs.alacritty = {
    enable = true;
    package = pkgs-unstable.alacritty;
  };

  # O si prefieres tu config manual:
  # xdg.configFile."alacritty/alacritty.toml".source = ../../../configs/alacritty/alacritty.toml;
}
#+end_src

* Uso Diario

** Comandos

#+begin_src bash
# Rebuild aurin
sudo nixos-rebuild switch --flake ~/dotfiles#aurin

# Rebuild vespino
sudo nixos-rebuild switch --flake ~/dotfiles#vespino

# Test antes de switch
sudo nixos-rebuild test --flake ~/dotfiles#aurin

# Actualizar inputs
cd ~/dotfiles && nix flake update

# Ver que cambiaria
sudo nixos-rebuild build --flake ~/dotfiles#aurin
nix store diff-closures /run/current-system ./result
#+end_src

** Aliases recomendados

#+begin_src nix
# En fish.nix o directamente
programs.fish.shellAliases = {
  # NixOS
  nrs = "sudo nixos-rebuild switch --flake ~/dotfiles";
  nrt = "sudo nixos-rebuild test --flake ~/dotfiles";
  nrb = "sudo nixos-rebuild build --flake ~/dotfiles";

  # Flake
  nfu = "nix flake update ~/dotfiles";
  nfc = "nix flake check ~/dotfiles";

  # Editar configs
  nconf = "cd ~/dotfiles && $EDITOR .";
};
#+end_src

* Ventajas de Esta Estructura

| Aspecto | Antes | Ahora |
|---------+-------+-------|
| Linkeo | stow manual | Automatico via flake |
| Modulos | Duplicados por host | Compartidos |
| Actualizacion | Channels impredecibles | flake.lock pinneado |
| Rebuild | Multiples comandos | Un comando |
| Documentacion | Suelta | Junto al codigo |
| Reproducibilidad | "Deberia funcionar" | Garantizada |

* Migracion desde Estructura Actual

#+begin_src bash
cd ~/dotfiles

# 1. Crear estructura
mkdir -p nixos/{hosts/aurin,hosts/vespino,modules/{core,hardware,services,network,desktop}}
mkdir -p home/{profiles/passh,modules/{shell,editors,desktop,development}}
mkdir -p configs/{xmonad,xmobar,picom,alacritty,doom}
mkdir -p lib overlays scripts

# 2. Mover configs existentes
mv nixos-aurin/etc/nixos/hardware-configuration.nix nixos/hosts/aurin/hardware.nix
mv nixos-vespino/etc/nixos/hardware-configuration.nix nixos/hosts/vespino/hardware.nix

mv nixos-aurin/etc/nixos/modules/* nixos/modules/  # Reorganizar despues

# 3. Mover configs raw
mv xmonad/.config/xmonad/xmonad.hs configs/xmonad/
mv xmobar/.config/xmobar/* configs/xmobar/
mv picom/.config/picom/* configs/picom/
mv alacritty/.config/alacritty/* configs/alacritty/

# 4. Crear flake.nix (ver arriba)

# 5. Probar
nix flake check
sudo nixos-rebuild test --flake .#aurin

# 6. Limpiar legacy (cuando todo funcione)
rm -rf nixos-aurin nixos-vespino
#+end_src
