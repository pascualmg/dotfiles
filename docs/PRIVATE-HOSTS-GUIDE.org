#+TITLE: Hosts Privados/Trabajo - Problema y Soluciones
#+AUTHOR: passh
#+DATE: 2026-01-05
#+OPTIONS: toc:2

* El Problema

En =aurin= y =macbook= necesitamos hosts de desarrollo del trabajo
(dominios internos, staging, desarrollo local, etc.)

El archivo fuente está en un repo de trabajo externo al flake.

** Por qué no puede estar en el repo público

- Contiene IPs internas
- Dominios de desarrollo/staging corporativos
- Información de infraestructura que no debe ser pública

** El código actual (configuration-pure.nix)

#+BEGIN_SRC nix
networking.extraHosts = if builtins.pathExists
  "/home/passh/src/work/work-env/hosts_all.txt" then
    builtins.readFile "/home/passh/src/work/work-env/hosts_all.txt"
  else
    "";
#+END_SRC

** Por qué requiere --impure

En NixOS Flakes, la evaluación "pura" significa:
- Solo puede leer archivos *dentro* del flake (o en el nix store)
- =builtins.pathExists= para paths externos SIEMPRE devuelve =false=
- =builtins.readFile= para paths externos FALLA directamente

Por eso necesitamos =--impure= para que Nix pueda leer el archivo externo.

* Solución Actual (2026-01-05)

** Aurin
#+BEGIN_SRC bash
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure
#+END_SRC

El repo =work/work-env= ya está clonado en =/home/passh/src/work/work-env=.

** Macbook

Requiere clonar el repo de work-env:
#+BEGIN_SRC bash
# Primera vez
git clone <url-work/work-env> ~/src/work/work-env

# Luego
sudo nixos-rebuild switch --flake ~/dotfiles#macbook --impure
#+END_SRC

Añadir a =nixos-macbook/etc/nixos/configuration.nix=:
#+BEGIN_SRC nix
networking.extraHosts = if builtins.pathExists
  "/home/passh/src/work/work-env/hosts_all.txt" then
    builtins.readFile "/home/passh/src/work/work-env/hosts_all.txt"
  else
    "";
#+END_SRC

* Soluciones Futuras (Evaluadas)

** Opción A: sops-nix (Recomendada para "hacerlo bien")

[[https://github.com/Mic92/sops-nix][sops-nix]] permite encriptar secretos y guardarlos en el repo público.

*** Ventajas
- El archivo está en el repo (encriptado)
- Evaluación pura (no necesita --impure)
- Ambas máquinas lo obtienen automáticamente
- Estándar de la comunidad NixOS

*** Desventajas
- Setup inicial: generar claves age o GPG
- Curva de aprendizaje
- Hay que re-encriptar cuando cambie el archivo

*** Implementación

1. Añadir sops-nix al flake:
#+BEGIN_SRC nix
# flake.nix
inputs.sops-nix = {
  url = "github:Mic92/sops-nix";
  inputs.nixpkgs.follows = "nixpkgs";
};
#+END_SRC

2. Generar clave age:
#+BEGIN_SRC bash
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt
# Guardar la clave pública para .sops.yaml
#+END_SRC

3. Crear =.sops.yaml= en el repo:
#+BEGIN_SRC yaml
keys:
  - &aurin age1xxxxxx...  # clave pública aurin
  - &macbook age1yyyyyy... # clave pública macbook
creation_rules:
  - path_regex: secrets/.*
    key_groups:
      - age:
        - *aurin
        - *macbook
#+END_SRC

4. Encriptar el archivo:
#+BEGIN_SRC bash
sops -e /home/passh/src/work/work-env/hosts_all.txt > secrets/work-hosts.enc
#+END_SRC

5. Usar en NixOS:
#+BEGIN_SRC nix
{ config, ... }:
{
  sops.defaultSopsFile = ./secrets/work-hosts.enc;
  sops.age.keyFile = "/home/passh/.config/sops/age/keys.txt";

  sops.secrets.work-hosts = {};

  networking.extraHosts = builtins.readFile config.sops.secrets.work-hosts.path;
}
#+END_SRC

*** Recursos
- [[https://github.com/Mic92/sops-nix][sops-nix GitHub]]
- [[https://nixos.wiki/wiki/Sops-nix][NixOS Wiki - sops-nix]]

** Opción B: Repo privado como flake input

*** Ventajas
- Evaluación pura
- Se actualiza con =nix flake update=
- Separación clara de secretos

*** Desventajas
- Necesitas crear y mantener un repo privado
- Configurar SSH/auth en cada máquina
- Un repo más que gestionar

*** Implementación

1. Crear repo privado (ej: =github.com/pascualmg/work-secrets=)

2. Añadir como input:
#+BEGIN_SRC nix
# flake.nix
inputs.work-secrets = {
  url = "git+ssh://git@github.com/pascualmg/work-secrets";
  flake = false;  # No es un flake, solo archivos
};
#+END_SRC

3. Usar en NixOS:
#+BEGIN_SRC nix
{ inputs, ... }:
{
  networking.extraHosts = builtins.readFile "${inputs.work-secrets}/hosts_all.txt";
}
#+END_SRC

4. Actualizar cuando cambie:
#+BEGIN_SRC bash
nix flake update work-secrets
sudo nixos-rebuild switch --flake .#aurin
#+END_SRC

** Opción C: Symlink (NO FUNCIONA)

Intentar con symlink dentro del flake:
#+BEGIN_SRC bash
ln -s /home/passh/src/work/work-env/hosts_all.txt ~/dotfiles/secrets/work-hosts.txt
#+END_SRC

*Por qué no funciona*:
- Git almacena el symlink como symlink (no el contenido)
- Cuando Nix copia el flake al store, el symlink apunta fuera del store
- Nix puro rechaza leer fuera del store

*No usar esta opción.*

** Opción D: Copiar archivo manualmente

#+BEGIN_SRC bash
cp /home/passh/src/work/work-env/hosts_all.txt ~/dotfiles/secrets/work-hosts.txt
echo "secrets/" >> ~/dotfiles/.gitignore
#+END_SRC

*** Ventajas
- Simple
- Funciona puro

*** Desventajas
- Hay que copiar en CADA máquina
- Hay que actualizar manualmente cuando cambie
- Fácil olvidarse y tener versiones desincronizadas

* Decisión Actual

*Fecha*: 2026-01-05

*Decisión*: Usar =--impure= con el archivo en =work/work-env=

*Razón*:
- Simplicidad
- El archivo ya existe en el repo de work-env
- No requiere setup adicional
- Funciona aunque requiera --impure

*Revisitar cuando*:
- Tengamos más secretos que gestionar
- El workflow con --impure se vuelva molesto
- Queramos reproducibilidad total del flake

* Comandos de Referencia

#+BEGIN_SRC bash
# Aurin (con hosts Work)
sudo nixos-rebuild switch --flake ~/dotfiles#aurin --impure

# Macbook (con hosts Work, requiere clonar work-env primero)
sudo nixos-rebuild switch --flake ~/dotfiles#macbook --impure

# Macbook (sin hosts Work, si no tienes work-env clonado)
sudo nixos-rebuild switch --flake ~/dotfiles#macbook
#+END_SRC

* Historial de Cambios

| Fecha      | Cambio                                    |
|------------+-------------------------------------------|
| 2026-01-05 | Documentación inicial, decisión --impure  |
